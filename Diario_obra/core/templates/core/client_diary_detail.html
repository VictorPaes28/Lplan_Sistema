{% extends 'base.html' %}
{% load static %}

{% block page_title %}Diário de Obra — {{ diary.date|date:"d/m/Y" }}{% endblock %}
{% block page_subtitle %}{{ project.name }}{% endblock %}

{% block content %}
<div class="mb-6 flex items-center justify-between flex-wrap gap-3">
    <div class="flex items-center min-w-0">
        <a href="{% url 'client-diary-list' %}" class="text-slate-600 hover:text-slate-900 mr-3 p-2 -ml-2 rounded-lg hover:bg-slate-100 transition-colors" aria-label="Voltar">
            <i class="fas fa-arrow-left text-lg"></i>
        </a>
        <div>
            <h1 class="text-xl font-bold text-slate-800">Diário de Obra</h1>
            <p class="text-sm text-slate-500">{{ diary.date|date:"d/m/Y" }}{% if diary.report_number %} · #{{ diary.report_number }}{% endif %} · {{ project.name }}</p>
        </div>
    </div>
</div>

<div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-6">
    <div class="text-center mb-6 pb-6 border-b border-slate-200">
        <div class="flex items-center justify-center mb-4">
            <img src="{% static 'core/images/lplan-logo2.png' %}" alt="LPLAN" class="h-16 object-contain">
            <span class="ml-4 text-2xl font-bold text-blue-900">LPLAN</span>
        </div>
        <h2 class="text-lg font-bold text-slate-800">Relatório Diário de Obra (RDO)</h2>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
            <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Data</p>
            <p class="text-lg font-bold text-slate-800">{{ diary.date|date:"d/m/Y" }} · {{ weekday_name }}</p>
        </div>
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
            <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Obra</p>
            <p class="text-base font-semibold text-slate-800">{{ project.name }}{% if project.code %} ({{ project.code }}){% endif %}</p>
        </div>
        {% if project_days_total > 0 %}
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
            <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Prazo</p>
            <p class="text-base font-semibold text-slate-800">{{ project_days_elapsed }} / {{ project_days_total }} dias</p>
        </div>
        {% endif %}
    </div>

    {% if diary.weather_conditions or diary.pluviometric_index %}
    <div class="mb-6">
        <h3 class="text-base font-semibold text-slate-800 mb-3"><i class="fas fa-cloud-sun text-blue-600 mr-2"></i>Clima</h3>
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
            {% if diary.weather_conditions %}<p class="text-sm text-slate-700 whitespace-pre-wrap">{{ diary.weather_conditions }}</p>{% endif %}
            {% if diary.pluviometric_index %}<p class="text-sm text-slate-600 mt-2">Índice pluviométrico: {{ diary.pluviometric_index }} mm</p>{% endif %}
        </div>
    </div>
    {% endif %}

    {% if total_direct_labor > 0 or total_indirect_labor > 0 or total_third_party_labor > 0 %}
    <div class="mb-6">
        <h3 class="text-base font-semibold text-slate-800 mb-3"><i class="fas fa-users text-blue-600 mr-2"></i>Mão de Obra</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {% if total_direct_labor > 0 %}<div class="bg-green-50 rounded-lg p-3 border border-green-200 text-center"><p class="text-xs text-gray-600">Direto</p><p class="text-xl font-bold text-green-700">{{ total_direct_labor }}</p></div>{% endif %}
            {% if total_indirect_labor > 0 %}<div class="bg-blue-50 rounded-lg p-3 border border-blue-200 text-center"><p class="text-xs text-gray-600">Indireto</p><p class="text-xl font-bold text-blue-700">{{ total_indirect_labor }}</p></div>{% endif %}
            {% if total_third_party_labor > 0 %}<div class="bg-purple-50 rounded-lg p-3 border border-purple-200 text-center"><p class="text-xs text-gray-600">Terceiros</p><p class="text-xl font-bold text-purple-700">{{ total_third_party_labor }}</p></div>{% endif %}
        </div>
    </div>
    {% endif %}

    {% if equipment_list %}
    <div class="mb-6">
        <h3 class="text-base font-semibold text-slate-800 mb-3"><i class="fas fa-tools text-blue-600 mr-2"></i>Equipamentos</h3>
        <div class="flex flex-wrap gap-2">
            {% for e in equipment_list %}<span class="bg-slate-100 text-slate-700 px-3 py-1 rounded-full text-sm">{{ e.name }}{% if e.code %} ({{ e.code }}){% endif %}</span>{% endfor %}
        </div>
    </div>
    {% endif %}

    {% if diary.general_notes %}
    <div class="mb-6">
        <h3 class="text-base font-semibold text-slate-800 mb-3"><i class="fas fa-sticky-note text-blue-600 mr-2"></i>Observações gerais</h3>
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200"><p class="text-sm text-slate-700 whitespace-pre-wrap">{{ diary.general_notes }}</p></div>
    </div>
    {% endif %}
</div>

<!-- Comentários (chat dono da obra ↔ LPLAN) -->
<div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-6">
    <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fas fa-comments text-blue-600 mr-2"></i>Comentários</h3>

    {% if comments %}
    <ul class="space-y-4 mb-6">
        {% for c in comments %}
        <li class="flex {% if c.author == user %}justify-end{% else %}justify-start{% endif %}">
            <div class="max-w-[85%] rounded-lg px-4 py-2 {% if c.author == user %}bg-blue-100 text-blue-900{% else %}bg-slate-100 text-slate-800{% endif %}">
                <p class="text-sm font-medium">{{ c.author.get_full_name|default:c.author.username }}</p>
                <p class="text-sm whitespace-pre-wrap mt-1">{{ c.text }}</p>
                <p class="text-xs text-slate-500 mt-2">{{ c.created_at|date:"d/m/Y H:i" }}</p>
            </div>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="text-sm text-slate-500 mb-6">Nenhum comentário ainda.</p>
    {% endif %}

    {% if can_comment %}
    <p class="text-xs text-amber-700 mb-3"><i class="fas fa-clock mr-1"></i>Você pode enviar comentários até {{ comment_deadline|date:"d/m/Y H:i" }} (24h após o envio do diário).</p>
    <form action="{% url 'client-diary-add-comment' diary.pk %}" method="post" class="flex flex-col gap-3">
        {% csrf_token %}
        <textarea name="text" rows="3" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Escreva seu comentário..." required></textarea>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium w-fit">
            <i class="fas fa-paper-plane mr-2"></i>Enviar comentário
        </button>
    </form>
    {% else %}
    <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 text-slate-600 text-sm">
        {% if comment_deadline %}
        <i class="fas fa-lock mr-2"></i>O prazo de 24 horas para enviar novos comentários foi encerrado em {{ comment_deadline|date:"d/m/Y H:i" }}. Os comentários acima permanecem como histórico.
        {% else %}
        <i class="fas fa-info-circle mr-2"></i>Os comentários estão disponíveis apenas após o envio do diário ao dono da obra.
        {% endif %}
    </div>
    {% endif %}
</div>

<div class="flex items-center gap-4">
    <a href="{% url 'client-diary-list' %}" class="text-slate-600 hover:text-slate-800 text-sm"><i class="fas fa-list mr-1"></i>Ver todos os diários</a>
    <a href="{% url 'logout' %}" class="text-slate-500 hover:text-slate-700 text-sm"><i class="fas fa-sign-out-alt mr-1"></i>Sair</a>
</div>
{% endblock %}
