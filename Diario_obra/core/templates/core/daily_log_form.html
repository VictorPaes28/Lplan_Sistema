{% extends 'base.html' %}
{% load static %}
{% load core_tags %}

{% block page_title %}Diário de Obra - {{ diary.date|default:"Novo" }}{% endblock %}
{% block page_subtitle %}Preencha os dados do relatório diário{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/daily_log_form.css' %}">
{% endblock %}

{% block content %}
<div class="min-h-screen diary-form-page py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <form method="post" enctype="multipart/form-data" id="diary-form" class="diary-form-inner space-y-6">
            {% csrf_token %}
            <input type="hidden" name="partial_save" id="partial_save_flag" value="">
            <input type="hidden" name="work_logs_json" id="work_logs_json_input" value="">
            <input type="hidden" name="occurrences_json" id="occurrences_json_input" value="">
            {% if form.non_field_errors %}
            <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700" role="alert">
                {% for err in form.non_field_errors %}<p>{{ err }}</p>{% endfor %}
            </div>
            {% endif %}
            
            <!-- Header Principal -->
            <div class="diary-form-header-card">
                <div class="diary-form-header-bar">
                    <div class="flex items-center space-x-4">
                        <div>
                            <h1 class="diary-form-main-title">Relatório Diário de Obra (RDO)</h1>
                            <p class="text-sm text-slate-500 diary-form-subtitle">Preencha os dados do dia</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button type="button" 
                                id="save-draft-btn"
                                class="diary-form-btn bg-amber-500 hover:bg-amber-600 text-white border-0"
                                title="Salva sem assinatura para continuar depois">
                            <i class="fas fa-file-alt mr-1.5"></i>
                            <span>Salvar rascunho</span>
                        </button>
                        <button type="submit" 
                                id="save-diary-btn"
                                class="diary-form-btn bg-blue-600 hover:bg-blue-700 text-white border-0">
                            <i class="fas fa-save mr-1.5" id="save-icon"></i>
                            <span id="save-text">Salvar Diário</span>
                            <span id="save-spinner" class="hidden ml-1"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                        <a href="{% url 'report-list' %}" 
                           class="diary-form-btn diary-form-btn-secondary">
                            <i class="fas fa-times mr-1.5"></i>Cancelar
                        </a>
                    </div>
                </div>
                
                <!-- Informações do Projeto e Relatório -->
                <div class="diary-form-info-block">
                    <div class="diary-form-info-grid grid grid-cols-1 lg:grid-cols-2">
                        <!-- Informações do Projeto (Esquerda) -->
                        <div class="diary-form-info-col space-y-4">
                            <h3 class="diary-form-block-title">Informações do Projeto</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1.5">Obra</label>
                                    <input type="text" 
                                           name="project_name" 
                                           id="project_name"
                                           value="{{ project.name|default:"" }}" 
                                           readonly
                                           class="w-full px-3 py-2 border border-slate-200 rounded-md text-sm text-slate-700 bg-slate-100 cursor-not-allowed">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1.5">Contratante</label>
                                    <input type="text" 
                                           name="project_client_name" 
                                           id="project_client_name"
                                           value="{{ initial_contractante|default:'' }}" 
                                           readonly
                                           class="w-full px-3 py-2 border border-slate-200 rounded-md text-sm text-slate-700 bg-slate-100 cursor-not-allowed">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1.5">Responsável</label>
                                    <input type="text" 
                                           name="project_responsible" 
                                           id="project_responsible"
                                           value="{{ project.responsible|default:'' }}" 
                                           readonly
                                           class="w-full px-3 py-2 border border-slate-200 rounded-md text-sm text-slate-700 bg-slate-100 cursor-not-allowed">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informações do Relatório (Direita) -->
                        <div class="diary-form-info-col space-y-4">
                            <h3 class="diary-form-block-title">Informações do Relatório</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1.5">Relatório n°</label>
                                    <input type="text" 
                                           id="report_number"
                                           value="{% if form.instance.report_number %}{{ form.instance.report_number }}{% else %}{{ next_report_number|default:"Será gerado automaticamente" }}{% endif %}" 
                                           readonly
                                           class="w-full px-3 py-2 bg-white border border-slate-200 rounded-md text-sm text-slate-700">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1.5">
                                        Data <span class="text-red-500">*</span>
                                    </label>
                                    {{ form.date }}
                                    {% if form.date.errors %}
                                        <div class="mt-1.5 flex items-start text-red-600 text-xs" role="alert">
                                            <i class="fas fa-exclamation-circle mr-1.5 mt-0.5 flex-shrink-0"></i>
                                            <div>{{ form.date.errors }}</div>
                                        </div>
                                    {% endif %}
                                    <p class="diary-form-helper text-xs text-gray-500">Selecione a data do relatório</p>
                                    <script>
                                    // Preenche a data se vier via GET ou se estiver copiando
                                    (function() {
                                        var dateInput = document.getElementById('id_date');
                                        if (!dateInput) return;
                                        
                                        // Se já tem valor, não faz nada
                                        if (dateInput.value) return;
                                        
                                        // Tenta pegar do GET primeiro
                                        var urlParams = new URLSearchParams(window.location.search);
                                        var dateParam = urlParams.get('date');
                                        if (dateParam) {
                                                try {
                                                    // Converte de dd/mm/yyyy para yyyy-mm-dd
                                                    if (dateParam.includes('/')) {
                                                        var parts = dateParam.split('/');
                                                        if (parts.length === 3) {
                                                            var day = parts[0].padStart(2, '0');
                                                            var month = parts[1].padStart(2, '0');
                                                            var year = parts[2];
                                                            dateInput.value = year + '-' + month + '-' + day;
                                                        }
                                                    } else {
                                                        dateInput.value = dateParam;
                                                    }
                                                } catch(e) {
                                                    console.error('Erro ao converter data:', e);
                                                }
                                        } else {
                                            // Se não veio via GET, tenta pegar do valor inicial do form
                                            // O Django já deve ter preenchido via form.initial, mas garantimos aqui
                                        }
                                    })();
                                    </script>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1.5">Dia da semana</label>
                                    <select name="weekday"
                                           id="weekday-display"
                                           aria-label="Dia da semana"
                                           title="Dia da semana"
                                           class="w-full px-3 py-2 border border-slate-300 rounded-md text-sm text-slate-900 focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none transition-all">
                                        <option value="">Selecione...</option>
                                        <option value="Domingo" {% if form.instance.date and form.instance.date|weekday_name == "Domingo" %}selected{% endif %}>Domingo</option>
                                        <option value="Segunda-Feira" {% if form.instance.date and form.instance.date|weekday_name == "Segunda-Feira" %}selected{% endif %}>Segunda-Feira</option>
                                        <option value="Terça-Feira" {% if form.instance.date and form.instance.date|weekday_name == "Terça-Feira" %}selected{% endif %}>Terça-Feira</option>
                                        <option value="Quarta-Feira" {% if form.instance.date and form.instance.date|weekday_name == "Quarta-Feira" %}selected{% endif %}>Quarta-Feira</option>
                                        <option value="Quinta-Feira" {% if form.instance.date and form.instance.date|weekday_name == "Quinta-Feira" %}selected{% endif %}>Quinta-Feira</option>
                                        <option value="Sexta-Feira" {% if form.instance.date and form.instance.date|weekday_name == "Sexta-Feira" %}selected{% endif %}>Sexta-Feira</option>
                                        <option value="Sábado" {% if form.instance.date and form.instance.date|weekday_name == "Sábado" %}selected{% endif %}>Sábado</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden input para projeto -->
                {% if project %}
                    <input type="hidden" name="project" value="{{ project.id }}">
                {% endif %}
            </div>

            <!-- Copiar dados de relatório anterior (sempre do último relatório — escala sem dropdown) -->
            {% if last_diary_for_copy %}
            <div class="diary-form-section-card border-dashed border-2 border-slate-300 bg-slate-50/80 mb-4" id="copy-from-section">
                <input type="hidden" id="copy-from-last-id" value="{{ last_diary_for_copy.id }}">
                <button type="button"
                        class="section-toggle w-full flex items-center justify-between p-4 text-left transition-colors hover:bg-slate-100/80 rounded-t-lg"
                        data-toggle-section="copy-from"
                        aria-expanded="false"
                        aria-label="Expandir Copiar de relatório anterior">
                    <div class="flex items-center space-x-3">
                        <div class="diary-form-section-icon bg-slate-200 text-slate-700">
                            <i class="fas fa-copy text-sm"></i>
                        </div>
                        <div>
                            <h3 class="diary-form-section-title text-slate-800">Copiar dados de relatório anterior</h3>
                            <p class="text-xs text-slate-600 mt-0.5">Selecione o que deseja copiar do último relatório para agilizar o preenchimento.</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-down text-slate-400 transition-transform section-chevron"></i>
                </button>
                <div id="section-copy-from-content" class="section-content p-5 border-t border-slate-200 section-collapsed">
                    <div class="copy-from-flow">
                        <!-- Fonte: último relatório em destaque -->
                        <div class="copy-from-source-card">
                            <i class="fas fa-file-alt copy-from-source-icon" aria-hidden="true"></i>
                            <div>
                                <p class="copy-from-source-label">Copiar do último relatório</p>
                                <p class="copy-from-source-value">Relatório #{{ last_diary_for_copy.report_number }} — {{ last_diary_for_copy.date }}</p>
                            </div>
                        </div>
                        <!-- O que copiar: título + Selecionar tudo + chips -->
                        <div class="copy-from-options-block">
                            <div class="copy-from-options-head">
                                <span class="copy-from-options-title">O que copiar?</span>
                                <button type="button" id="copy-select-all-link" class="copy-select-all-link">Selecionar tudo</button>
                            </div>
                            <div id="copy-from-chips" class="copy-from-chips" role="group" aria-label="Categorias para copiar">
                                <button type="button" class="copy-chip" data-value="climate">Clima</button>
                                <button type="button" class="copy-chip" data-value="labor">Mão de obra</button>
                                <button type="button" class="copy-chip" data-value="equipment">Equipamentos</button>
                                <button type="button" class="copy-chip" data-value="activities">Atividades</button>
                                <button type="button" class="copy-chip" data-value="ocorrencias">Ocorrências</button>
                            </div>
                        </div>
                        <!-- Ação: botão + hint / contador -->
                        <div class="copy-from-actions">
                            <p id="copy-from-hint" class="copy-from-hint" aria-live="polite">Selecione ao menos um item acima para habilitar o botão.</p>
                            <p id="copy-from-count" class="copy-from-count" aria-live="polite" hidden></p>
                            <button type="button" id="apply-copy-btn" class="apply-copy-btn" disabled aria-describedby="copy-from-hint copy-from-count">
                                <i class="fas fa-paste" aria-hidden="true"></i> Aplicar cópia
                            </button>
                        </div>
                        {% if copy_source_diary %}
                        <p class="text-sm text-green-700 bg-green-50 px-3 py-2 rounded-lg border border-green-200">
                            <i class="fas fa-check-circle mr-1.5"></i> Dados aplicados do Relatório #{{ copy_source_diary.report_number }} ({{ copy_source_diary.date|date:"d/m/Y" }}). Ajuste o que precisar e salve.
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <script>
            (function() {
                var section = document.getElementById('copy-from-section');
                if (!section) return;
                var lastIdEl = document.getElementById('copy-from-last-id');
                var applyBtn = document.getElementById('apply-copy-btn');
                var chips = section.querySelectorAll('.copy-chip');
                var selectAllLink = document.getElementById('copy-select-all-link');

                var hintEl = document.getElementById('copy-from-hint');
                var countEl = document.getElementById('copy-from-count');

                function updateApplyButton() {
                    var n = getSelectedValues().length;
                    applyBtn.disabled = n === 0;
                    if (hintEl) {
                        hintEl.hidden = n > 0;
                    }
                    if (countEl) {
                        countEl.hidden = n === 0;
                        countEl.textContent = n === 1 ? '1 item selecionado' : n + ' itens selecionados';
                    }
                }

                function isChipSelected(chip) {
                    return chip.getAttribute('aria-pressed') === 'true';
                }

                function setChipSelected(chip, selected) {
                    chip.setAttribute('aria-pressed', selected ? 'true' : 'false');
                    chip.classList.toggle('copy-chip--selected', selected);
                    chip.classList.toggle('copy-chip--unselected', !selected);
                    updateApplyButton();
                }

                function getSelectedValues() {
                    var arr = [];
                    chips.forEach(function(chip) {
                        if (isChipSelected(chip)) arr.push(chip.getAttribute('data-value'));
                    });
                    return arr;
                }

                function allChipsSelected() {
                    return chips.length > 0 && getSelectedValues().length === chips.length;
                }

                chips.forEach(function(chip) {
                    chip.setAttribute('role', 'button');
                    chip.setAttribute('aria-pressed', 'false');
                    chip.classList.add('copy-chip--unselected');
                    chip.addEventListener('click', function() {
                        setChipSelected(chip, !isChipSelected(chip));
                    });
                });

                if (selectAllLink) {
                    selectAllLink.addEventListener('click', function() {
                        var allSelected = allChipsSelected();
                        chips.forEach(function(chip) { setChipSelected(chip, !allSelected); });
                    });
                }

                var copyOptionsStr = '{{ copy_options|escapejs }}';
                var opts = copyOptionsStr ? copyOptionsStr.split(',').map(function(s) { return s.trim().toLowerCase(); }) : [];
                if (opts.indexOf('all') !== -1 || opts.length >= 6) {
                    chips.forEach(function(chip) { setChipSelected(chip, true); });
                } else {
                    chips.forEach(function(chip) {
                        var val = chip.getAttribute('data-value');
                        setChipSelected(chip, opts.indexOf(val) !== -1);
                    });
                }

                applyBtn.addEventListener('click', function() {
                    if (applyBtn.disabled) return;
                    var fromId = lastIdEl && lastIdEl.value;
                    if (!fromId) { alert('Relatório de origem não disponível.'); return; }
                    var selected = getSelectedValues();
                    if (selected.length === 0) { alert('Selecione ao menos um item para copiar.'); return; }
                    var url = new URL(window.location.href);
                    url.searchParams.set('copy_from', fromId);
                    url.searchParams.set('copy', selected.join(','));
                    window.location.href = url.toString();
                });

                updateApplyButton();
            })();
            </script>
            {% endif %}

            <!-- Layout Principal com Sidebar -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Conteúdo Principal (Esquerda) -->
                <div class="lg:col-span-3 space-y-4">
                    
                    <!-- Seção: Condição Climática -->
                    <div class="diary-form-section-card" id="section-clima">
                        <button type="button"
                                class="section-toggle section-collapsed w-full flex items-center justify-between p-5 text-left transition-colors"
                                data-toggle-section="clima"
                                aria-expanded="false"
                                aria-label="Expandir ou recolher seção Condição climática"
                                title="Clique para expandir ou recolher">
                            <div class="flex items-center space-x-3">
                                <div class="diary-form-section-icon">
                                    <i class="fas fa-cloud-sun text-slate-600 text-sm"></i>
                                </div>
                                <h3 class="diary-form-section-title">Condição climática</h3>
                            </div>
                            <i class="fas fa-chevron-down text-slate-400 transition-transform section-chevron diary-form-chevron"></i>
                        </button>
                        <div id="section-clima-content" class="section-content p-6 border-t border-slate-200 section-collapsed">
                            <div class="weather-cards-grid">
                                <!-- Card Manhã -->
                                <div class="weather-card" data-period="morning">
                                    <div class="weather-card-header">
                                        <input type="checkbox"
                                               id="weather_morning_enabled"
                                               {% if form.instance.weather_morning_condition or form.weather_morning_condition.value %}checked{% endif %}
                                               class="weather-card-checkbox w-5 h-5 text-blue-600 border-slate-300 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer flex-shrink-0">
                                        <label for="weather_morning_enabled" class="text-base font-semibold text-slate-900 cursor-pointer select-none">Manhã</label>
                                    </div>
                                    <div class="weather-card-body">
                                        <div class="weather-card-row">
                                            <span class="weather-row-label">Condição</span>
                                            <div class="weather-chips">
                                                <label class="weather-chip {% if form.weather_morning_condition.value == 'B' %}weather-chip--selected{% else %}weather-chip--unselected{% endif %}">
                                                    <input type="radio" name="weather_morning_condition" value="B" id="weather_morning_bom" {% if form.weather_morning_condition.value == 'B' %}checked{% endif %} class="sr-only">
                                                    Bom
                                                </label>
                                                <label class="weather-chip {% if form.weather_morning_condition.value == 'R' %}weather-chip--selected{% else %}weather-chip--unselected{% endif %}">
                                                    <input type="radio" name="weather_morning_condition" value="R" id="weather_morning_ruim" {% if form.weather_morning_condition.value == 'R' %}checked{% endif %} class="sr-only">
                                                    Ruim
                                                </label>
                                            </div>
                                        </div>
                                        <div class="weather-card-row">
                                            <span class="weather-row-label">Estado</span>
                                            <div class="weather-chips">
                                                <label class="weather-chip {% if form.weather_morning_workable.value == 'T' %}weather-chip--selected{% else %}weather-chip--unselected{% endif %}">
                                                    <input type="radio" name="weather_morning_workable" value="T" id="weather_morning_trabalhavel" {% if form.weather_morning_workable.value == 'T' %}checked{% endif %} class="sr-only">
                                                    Trabalhável
                                                </label>
                                                <label class="weather-chip {% if form.weather_morning_workable.value == 'N' %}weather-chip--selected{% else %}weather-chip--unselected{% endif %}">
                                                    <input type="radio" name="weather_morning_workable" value="N" id="weather_morning_nao_trabalhavel" {% if form.weather_morning_workable.value == 'N' %}checked{% endif %} class="sr-only">
                                                    Não Trabalhável
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Card Tarde -->
                                <div class="weather-card" data-period="afternoon">
                                    <div class="weather-card-header">
                                        <input type="checkbox"
                                               id="weather_afternoon_enabled"
                                               {% if form.instance.weather_afternoon_condition or form.weather_afternoon_condition.value %}checked{% endif %}
                                               class="weather-card-checkbox w-5 h-5 text-blue-600 border-slate-300 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer flex-shrink-0">
                                        <label for="weather_afternoon_enabled" class="text-base font-semibold text-slate-900 cursor-pointer select-none">Tarde</label>
                                    </div>
                                    <div class="weather-card-body">
                                        <div class="weather-card-row">
                                            <span class="weather-row-label">Condição</span>
                                            <div class="weather-chips">
                                                <label class="weather-chip {% if form.weather_afternoon_condition.value == 'B' %}weather-chip--selected{% else %}weather-chip--unselected{% endif %}">
                                                    <input type="radio" name="weather_afternoon_condition" value="B" id="weather_afternoon_bom" {% if form.weather_afternoon_condition.value == 'B' %}checked{% endif %} class="sr-only">
                                                    Bom
                                                </label>
                                                <label class="weather-chip {% if form.weather_afternoon_condition.value == 'R' %}weather-chip--selected{% else %}weather-chip--unselected{% endif %}">
                                                    <input type="radio" name="weather_afternoon_condition" value="R" id="weather_afternoon_ruim" {% if form.weather_afternoon_condition.value == 'R' %}checked{% endif %} class="sr-only">
                                                    Ruim
                                                </label>
                                            </div>
                                        </div>
                                        <div class="weather-card-row">
                                            <span class="weather-row-label">Estado</span>
                                            <div class="weather-chips">
                                                <label class="weather-chip {% if form.weather_afternoon_workable.value == 'T' %}weather-chip--selected{% else %}weather-chip--unselected{% endif %}">
                                                    <input type="radio" name="weather_afternoon_workable" value="T" id="weather_afternoon_trabalhavel" {% if form.weather_afternoon_workable.value == 'T' %}checked{% endif %} class="sr-only">
                                                    Trabalhável
                                                </label>
                                                <label class="weather-chip {% if form.weather_afternoon_workable.value == 'N' %}weather-chip--selected{% else %}weather-chip--unselected{% endif %}">
                                                    <input type="radio" name="weather_afternoon_workable" value="N" id="weather_afternoon_nao_trabalhavel" {% if form.weather_afternoon_workable.value == 'N' %}checked{% endif %} class="sr-only">
                                                    Não Trabalhável
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <script>
                            (function() {
                                function updateWeatherChipStyles(container) {
                                    if (!container) return;
                                    container.querySelectorAll('label.weather-chip').forEach(function(lbl) {
                                        var radio = lbl.querySelector('input[type="radio"]');
                                        if (radio && radio.checked) {
                                            lbl.classList.add('weather-chip--selected');
                                            lbl.classList.remove('weather-chip--unselected');
                                        } else {
                                            lbl.classList.add('weather-chip--unselected');
                                            lbl.classList.remove('weather-chip--selected');
                                        }
                                    });
                                }
                                document.querySelectorAll('.weather-card').forEach(function(card) {
                                    card.addEventListener('change', function() { updateWeatherChipStyles(card); });
                                    updateWeatherChipStyles(card);
                                });
                            })();
                            </script>
                                
                                <!-- Índice Pluviométrico -->
                                <div class="pt-6 mt-6 border-t border-slate-200">
                                    <label class="block text-sm font-semibold text-slate-900 mb-3">
                                        <div class="inline-flex items-center">
                                            <div class="w-6 h-6 rounded-md bg-slate-100 flex items-center justify-center mr-2">
                                                <i class="fas fa-cloud-rain text-slate-600 text-xs"></i>
                                            </div>
                                            <span>Índice pluviométrico</span>
                                            <span class="text-slate-500 text-xs font-normal ml-2">(mm) — Opcional</span>
                                        </div>
                                    </label>
                                    <div class="relative max-w-xs">
                                    {{ form.pluviometric_index }}
                                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-slate-400 pointer-events-none font-medium">mm</span>
                                    </div>
                                    {% if form.pluviometric_index.errors %}
                                        <p class="text-red-600 text-xs mt-2 flex items-center">
                                            <i class="fas fa-exclamation-circle mr-1.5"></i>{{ form.pluviometric_index.errors }}
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seção: Mão de Obra -->
                    <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden" id="section-maoObra">
                        <button type="button"
                                class="section-toggle w-full flex items-center justify-between p-4 text-left bg-white hover:bg-blue-50 transition-colors cursor-pointer border-b border-slate-200"
                                data-toggle-section="maoObra"
                                aria-expanded="false"
                                aria-label="Expandir ou recolher seção Mão de obra"
                                title="Clique para expandir ou recolher">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center">
                                    <i class="fas fa-users text-slate-600 text-sm"></i>
                                </div>
                                <h3 class="text-base font-semibold text-slate-900">Mão de obra</h3>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-chevron-down text-slate-400 transition-transform section-chevron"></i>
                            </div>
                        </button>
                        <div id="section-maoObra-content" class="section-content p-6 border-t border-slate-200 section-collapsed">
                            <p class="text-sm text-slate-600 mb-4">Selecione o cargo e defina a quantidade de profissionais presentes no dia usando os botões + / −.</p>
                            <div id="diary-labor-by-category">
                                {% for category in labor_categories %}
                                <div class="diary-labor-category-block rounded-xl border border-slate-200 bg-slate-50/50 overflow-hidden" data-category-slug="{{ category.slug }}">
                                    <div class="diary-subcategory-header">
                                        <h4 class="text-sm font-semibold text-slate-900">{{ category.name }}</h4>
                                    </div>
                                    {% if category.slug == 'terceirizada' %}
                                    <div class="diary-subcategory-body">
                                        <button type="button" id="btn-add-terceirizada-empresa" class="diary-btn-add-secondary px-3 py-2 rounded-lg text-sm font-medium transition-colors border border-slate-300 bg-slate-100 text-slate-700 hover:bg-slate-200">
                                            <i class="fas fa-building mr-1.5"></i>Adicionar empresa terceirizada
                                        </button>
                                        <div id="terceirizada-empresas" class="mt-3 space-y-3"></div>
                                    </div>
                                    {% else %}
                                    <ul class="diary-labor-cargo-list diary-subcategory-body">
                                        {% for cargo in category.cargos.all %}
                                        <li class="flex items-center justify-between gap-2 py-1 border-b border-slate-100 last:border-0">
                                            <span class="text-sm text-slate-800 flex-1">{{ cargo.name }}</span>
                                            <div class="flex items-center gap-1">
                                                <button type="button" class="diary-labor-minus w-8 h-8 flex items-center justify-center rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-700 transition-colors" data-cargo-id="{{ cargo.id }}" data-company="" aria-label="Diminuir quantidade">
                                                    <i class="fas fa-minus text-xs"></i>
                                                </button>
                                                <input type="number" min="0" value="0" class="diary-labor-qty w-14 text-center py-1.5 border border-slate-300 rounded-lg text-sm font-medium" data-cargo-id="{{ cargo.id }}" data-company="" readonly>
                                                <button type="button" class="diary-labor-plus w-8 h-8 flex items-center justify-center rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-700 transition-colors" data-cargo-id="{{ cargo.id }}" data-company="" aria-label="Aumentar quantidade">
                                                    <i class="fas fa-plus text-xs"></i>
                                                </button>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                </div>
                                {% empty %}
                                <p class="text-sm text-slate-500 py-4">Nenhuma categoria de mão de obra configurada. Execute as migrações e o seed de cargos.</p>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="diary_labor_data" id="diary_labor_data" value="">
                            {{ existing_diary_labor|json_script:"existing-diary-labor-data" }}
                            {{ labor_terceirizada_cargos|json_script:"terceirizada-cargos-data" }}
                        </div>
                    </div>

                    <!-- Seção: Equipamentos -->
                    <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden" id="section-equipamentos">
                        <button type="button"
                                data-toggle-section="equipamentos"
                                class="section-toggle section-collapsed w-full flex items-center justify-between p-4 text-left bg-white hover:bg-blue-50 transition-colors cursor-pointer"
                                aria-expanded="false"
                                aria-label="Expandir ou recolher seção Equipamentos"
                                title="Clique para expandir ou recolher">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center">
                                    <i class="fas fa-tools text-slate-600 text-sm"></i>
                                </div>
                                <h3 class="text-base font-semibold text-slate-900">Equipamentos</h3>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-chevron-down text-slate-400 transition-transform section-chevron"></i>
                            </div>
                        </button>
                        <div id="section-equipamentos-content" class="section-content p-6 border-t border-slate-200 section-collapsed">
                            <p class="text-sm text-slate-600 mb-4">Selecione o equipamento e defina a quantidade usando os botões + / −. Use "Adicionar outro equipamento" para itens que não estão na lista.</p>
                            <div id="diary-equipment-by-category" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                {% for category in equipment_categories %}
                                <div class="diary-equipment-category-block rounded-xl border border-slate-200 bg-slate-50/50 overflow-hidden" data-equipment-category-slug="{{ category.slug }}">
                                    <div class="diary-subcategory-header">
                                        <h4 class="text-sm font-semibold text-slate-900">{{ category.name }}</h4>
                                    </div>
                                    <ul class="diary-equipment-item-list diary-subcategory-body">
                                        {% for item in category.items.all %}
                                        <li class="flex items-center justify-between gap-2 py-1 border-b border-slate-100 last:border-0">
                                            <span class="text-sm text-slate-800 flex-1">{{ item.name }}</span>
                                            <div class="flex items-center gap-1">
                                                <button type="button" class="diary-equipment-minus w-8 h-8 flex items-center justify-center rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-700 transition-colors" data-equipment-id="{{ item.id }}" data-equipment-name="{{ item.name|escapejs }}" aria-label="Diminuir quantidade">
                                                    <i class="fas fa-minus text-xs"></i>
                                                </button>
                                                <input type="number" min="0" value="0" name="equipment_qty_std_{{ item.id }}" id="equipment_qty_std_{{ item.id }}" class="diary-equipment-qty w-14 text-center py-1.5 border border-slate-300 rounded-lg text-sm font-medium" data-equipment-id="{{ item.id }}" data-equipment-name="{{ item.name|escapejs }}" readonly aria-label="Quantidade {{ item.name }}">
                                                <button type="button" class="diary-equipment-plus w-8 h-8 flex items-center justify-center rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-700 transition-colors" data-equipment-id="{{ item.id }}" data-equipment-name="{{ item.name|escapejs }}" aria-label="Aumentar quantidade">
                                                    <i class="fas fa-plus text-xs"></i>
                                                </button>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% empty %}
                                <p class="text-sm text-slate-500 py-4 col-span-2">Nenhuma categoria de equipamentos configurada. Execute as migrações.</p>
                                {% endfor %}
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-200">
                                <button type="button" id="btn-add-custom-equipment" class="diary-btn-add-secondary px-3 py-2 rounded-lg text-sm font-medium transition-colors border border-slate-300 bg-slate-100 text-slate-700 hover:bg-slate-200">
                                    <i class="fas fa-plus mr-1.5"></i>Adicionar outro equipamento
                                </button>
                                <div id="equipment-custom-list" class="mt-3 space-y-2"></div>
                            </div>
                            {{ existing_diary_equipment|json_script:"existing-diary-equipment-data" }}
                            <input type="hidden" name="equipment_data" id="equipment_data" value="[]">
                        </div>
                    </div>
                    
                    <!-- Modal: Adicionar outro equipamento (nome livre) -->
                    <div id="modal-add-equipment" 
                         class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm"
                         onclick="if(event.target === this) this.classList.add('hidden')">
                        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden" onclick="event.stopPropagation()">
                            <div class="px-6 py-4 border-b border-slate-200 bg-slate-50">
                                <h3 class="text-lg font-semibold text-slate-900">Adicionar outro equipamento</h3>
                                <p class="text-xs text-slate-500 mt-1">Para itens que não estão na lista acima</p>
                            </div>
                            <div class="p-6">
                                <div id="equipment-form" role="form">
                                    <div class="space-y-4">
                                        <div>
                                            <label for="equipment-name" class="block text-sm font-semibold text-slate-700 mb-2">Nome do equipamento <span class="text-red-500">*</span></label>
                                            <input type="text" id="equipment-name" name="equipment_name" aria-label="Nome do equipamento" placeholder="Ex: Escavadeira, Betoneira..."
                                                   class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 outline-none text-sm text-slate-900 placeholder:text-slate-400">
                                        </div>
                                        <div>
                                            <label for="equipment-quantity" class="block text-sm font-semibold text-slate-700 mb-2">Quantidade <span class="text-red-500">*</span></label>
                                            <input type="number" id="equipment-quantity" name="equipment_quantity" required min="1" value="1"
                                                   class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 outline-none text-sm text-slate-900">
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-end space-x-3 pt-6 border-t border-slate-200 mt-6">
                                        <button type="button" onclick="document.getElementById('modal-add-equipment').classList.add('hidden')" class="px-5 py-2.5 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 font-medium">Cancelar</button>
                                        <button type="button" onclick="addCustomEquipmentItem(event)" class="px-5 py-2.5 bg-slate-700 text-white rounded-lg hover:bg-slate-800 font-medium"><i class="fas fa-save mr-2"></i>Adicionar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seção: Atividades -->
                    <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden" id="section-atividades">
                        <div class="flex items-center justify-between p-4 border-b border-slate-200">
                        <button type="button"
                                    data-toggle-section="atividades"
                                    class="section-toggle section-collapsed flex items-center space-x-3 text-left bg-white hover:bg-blue-50 transition-colors flex-1 p-4 rounded-lg border border-slate-200"
                                    aria-expanded="false"
                                aria-label="Expandir ou recolher seção Atividades Executadas"
                                title="Clique para expandir ou recolher">
                                <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center">
                                    <i class="fas fa-tasks text-slate-600 text-sm"></i>
                            </div>
                                <h3 class="text-base font-semibold text-slate-900">Atividades Executadas</h3>
                                <span class="text-xs text-slate-500 bg-blue-100 px-2 py-1 rounded-full" id="activities-count-display">{{ worklog_formset.forms|length }}</span>
                                <i class="fas fa-chevron-down text-slate-400 transition-transform section-chevron ml-auto"></i>
                        </button>
                                <button type="button" id="btn-open-modal-activity"
                                    onclick="var m=document.getElementById('modal-add-activity'); m.classList.add('diary-modal-open'); m.setAttribute('aria-hidden','false');"
                                    class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-all duration-200 shadow-sm hover:shadow-md flex items-center ml-4">
                                <i class="fas fa-plus mr-2 text-xs"></i>Adicionar
                                </button>
                            </div>
                        <div id="section-atividades-content" class="section-content p-6 border-t border-slate-200 section-collapsed">
                            {{ worklog_formset.management_form }}
                            <div id="worklog-formset-container" class="space-y-3">
                                {% for form in worklog_formset %}
                                {% if not form.DELETE.value %}
                                <div class="activity-item border border-slate-200 rounded-lg p-4 bg-white hover:bg-blue-50 transition-colors" data-form-index="{{ forloop.counter0 }}">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-2">
                                                <h4 class="text-sm font-semibold text-slate-900">{{ form.activity_description.value|default:"Sem descrição"|truncatewords:10 }}</h4>
                                                {% if form.work_stage.value %}
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                                                    {{ form.instance.get_work_stage_display|default:form.work_stage.value }}
                                                </span>
                                                {% endif %}
                                        </div>
                                            <div class="flex items-center gap-4 text-xs text-slate-600">
                                                {% if form.percentage_executed_today.value %}
                                                <span class="flex items-center">
                                                    <i class="fas fa-percentage mr-1"></i>
                                                    {{ form.percentage_executed_today.value }}%
                                                </span>
                                                {% endif %}
                                                {% if form.location.value %}
                                                <span class="flex items-center">
                                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                                    {{ form.location.value|truncatewords:5 }}
                                                </span>
                                            {% endif %}
                                        </div>
                                        </div>
                                        <div class="flex items-center space-x-2 ml-4">
                                            <button type="button" 
                                                    onclick="editActivity({{ forloop.counter0 }})"
                                                    class="p-2 text-slate-600 hover:bg-blue-100 rounded-md transition-colors"
                                                    aria-label="Editar atividade"
                                                    title="Editar">
                                                <i class="fas fa-edit text-sm" aria-hidden="true"></i>
                                            </button>
                                            <button type="button" 
                                                    onclick="removeActivity({{ forloop.counter0 }})"
                                                    class="p-2 text-red-600 hover:bg-red-50 rounded-md transition-colors"
                                                    aria-label="Remover atividade"
                                                    title="Remover">
                                                <i class="fas fa-trash text-sm" aria-hidden="true"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {{ form.id }}
                                    {% if form.DELETE %}
                                    <div class="hidden-field">{{ form.DELETE }}</div>
                                    {% endif %}
                                    <div class="hidden-field">
                                        {{ form.activity_description }}
                                        {{ form.location }}
                                        {{ form.percentage_executed_today }}
                                        {{ form.accumulated_progress_snapshot }}
                                        {{ form.work_stage }}
                                        {{ form.quantity_done }}
                                        {{ form.unit }}
                                        {{ form.start_time }}
                                        {{ form.end_time }}
                                        {{ form.notes }}
                                    </div>
                                </div>
                                            {% endif %}
                                {% endfor %}
                                <p id="activities-empty-message" class="text-sm text-slate-500 text-center py-8 {% if worklog_formset.forms %}hidden{% endif %}" aria-hidden="{% if worklog_formset.forms %}true{% else %}false{% endif %}">Nenhuma atividade registrada. Clique em "Adicionar" para registrar uma atividade.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Seção: Ocorrências -->
                    <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden" id="section-ocorrencias">
                        <div class="flex items-center justify-between p-4 border-b border-slate-200">
                        <button type="button"
                                    data-toggle-section="ocorrencias"
                                    class="section-toggle section-collapsed flex items-center space-x-3 text-left bg-white hover:bg-blue-50 transition-colors flex-1 p-4 rounded-lg border border-slate-200"
                                    aria-expanded="false"
                                aria-label="Expandir ou recolher seção Ocorrências"
                                title="Clique para expandir ou recolher">
                                <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-slate-600 text-sm"></i>
                            </div>
                                <h3 class="text-base font-semibold text-slate-900">Ocorrências</h3>
                                <span class="text-xs text-slate-500 bg-blue-100 px-2 py-1 rounded-full" id="ocorrencias-count-display">{{ occurrence_formset.forms|length }}</span>
                                <i class="fas fa-chevron-down text-slate-400 transition-transform section-chevron ml-auto"></i>
                            </button>
                                <button type="button" 
                                    id="btn-open-modal-occurrence"
                                    onclick="event.stopPropagation(); if(typeof openOccurrenceModal === 'function') { openOccurrenceModal(); } else { var m=document.getElementById('modal-add-occurrence'); m.classList.add('diary-modal-open'); m.setAttribute('aria-hidden','false'); } return false;"
                                    class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-all duration-200 shadow-sm hover:shadow-md flex items-center ml-4">
                                <i class="fas fa-plus mr-2 text-xs"></i>Adicionar
                                </button>
                            </div>
                        <div id="section-ocorrencias-content" class="section-content p-6 border-t border-slate-200 section-collapsed">
                            {{ occurrence_formset.management_form }}
                            <div id="ocorrencias-formset-container" class="space-y-3">
                                {% for form in occurrence_formset %}
                                {% if not form.DELETE.value %}
                                <div class="ocorrencia-item border border-slate-200 rounded-lg p-4 bg-white hover:bg-blue-50 transition-colors" data-form-index="{{ forloop.counter0 }}">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-slate-900 mb-2 leading-relaxed">{{ form.description.value|default:"" }}</p>
                                            {% if form.instance.pk and form.instance.tags.exists %}
                                            <div class="flex flex-wrap gap-2 mt-2">
                                                {% for tag in form.instance.tags.all %}
                                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium shadow-sm tag-badge" data-tag-color="{{ tag.color }}">
                                                    <i class="fas fa-tag mr-1 text-xs"></i>{{ tag.name }}
                                                </span>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="flex items-center space-x-2 ml-4">
                                            <button type="button" 
                                                    onclick="editOccurrence({{ forloop.counter0 }})"
                                                    class="p-2 text-slate-600 hover:bg-blue-100 rounded-md transition-colors"
                                                    aria-label="Editar ocorrência"
                                                    title="Editar">
                                                <i class="fas fa-edit text-sm" aria-hidden="true"></i>
                                            </button>
                                            <button type="button" 
                                                    onclick="removeOccurrence({{ forloop.counter0 }})"
                                                    class="p-2 text-red-600 hover:bg-red-50 rounded-md transition-colors"
                                                    aria-label="Remover ocorrência"
                                                    title="Remover">
                                                <i class="fas fa-trash text-sm" aria-hidden="true"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {{ form.id }}
                                    {% if form.DELETE %}
                                    <div class="hidden-field">{{ form.DELETE }}</div>
                                    {% endif %}
                                    <div class="hidden-field">
                                        {{ form.description }}
                                        {{ form.tags }}
                                    </div>
                                </div>
                                {% endif %}
                                {% empty %}
                                <p id="ocorrencias-empty-message" class="text-sm text-slate-500 text-center py-4">Nenhuma ocorrência registrada. Clique em "Adicionar" para registrar uma ocorrência.</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Seção: Fotos -->
                    <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden" id="section-fotos">
                        <button type="button"
                                data-toggle-section="fotos"
                                class="section-toggle section-collapsed w-full flex items-center justify-between p-4 text-left bg-white hover:bg-blue-50 transition-colors border-b border-slate-200"
                                aria-expanded="false"
                                aria-label="Expandir ou recolher seção Fotos"
                                title="Clique para expandir ou recolher">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center">
                                    <i class="fas fa-camera text-slate-600 text-sm"></i>
                                </div>
                                <h3 class="text-base font-semibold text-gray-900">Fotos</h3>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded font-semibold" id="photos-count-display">{{ image_formset.forms|length }}</span>
                                <i class="fas fa-chevron-down text-gray-400 transition-transform section-chevron"></i>
                            </div>
                        </button>
                        <div id="section-fotos-content" class="section-content p-6 border-t border-slate-200 section-collapsed">
                            {{ image_formset.management_form }}
                            
                            <!-- Área de Upload (padrão: um bloco só) -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-slate-900 mb-2">Adicionar Fotos</label>
                                <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:border-slate-400 transition-colors bg-slate-50/50 cursor-pointer" onclick="document.getElementById('photo-upload-multiple').click()">
                                    <input type="file" 
                                           id="photo-upload-multiple" 
                                           name="photos" 
                                           multiple 
                                           accept="image/*"
                                           class="hidden"
                                           onchange="handleMultiplePhotos(this)">
                                    <div class="flex flex-col items-center">
                                        <div class="w-12 h-12 rounded-lg bg-slate-200 flex items-center justify-center mb-2">
                                            <i class="fas fa-camera text-slate-600 text-xl"></i>
                                        </div>
                                        <p class="text-sm font-medium text-slate-700">Clique ou arraste fotos aqui</p>
                                        <p class="text-xs text-slate-500 mt-0.5">Múltiplas fotos permitidas</p>
                                    </div>
                                </div>
                                <p class="text-xs text-slate-500 mt-2">
                                    <i class="fas fa-info-circle mr-1"></i>Adicione as fotos e preencha a <strong>legenda de cada uma</strong> no card (obrigatório).
                                </p>
                            </div>
                            
                            <!-- Grid de Preview das Fotos -->
                            <div id="photos-preview-grid" class="grid grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-8 gap-2 mb-4">
                                {% for form in image_formset %}
                                {% if not form.DELETE.value %}
                                <div class="photo-item group relative border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm hover:shadow-md transition-all" data-form-index="{{ forloop.counter0 }}">
                                    {% if form.instance.pk and form.instance.image %}
                                        <div class="photo-item__media aspect-square bg-white border-b border-slate-200">
                                            <img src="{{ form.instance.image.url }}" 
                                                 alt="{{ form.instance.caption|default:'Foto' }}" 
                                                 class="w-full h-full object-cover">
                                            <div class="photo-item__remove">
                                                <button type="button" 
                                                        onclick="removePhotoItem(this)"
                                                        class="bg-red-600 text-white w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-700 transition-all shadow border border-white"
                                                        aria-label="Remover foto"
                                                        title="Remover foto">
                                                    <i class="fas fa-times text-xs" aria-hidden="true"></i>
                                                </button>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {{ form.id }}
                                    {% if form.image %}
                                    <div class="hidden-field">
                                        <label for="{{ form.image.id_for_label }}" class="sr-only">Upload de imagem</label>
                                        {{ form.image }}
                                    </div>
                                    {% endif %}
                                    {% if form.caption %}
                                    <div class="photo-item__caption p-2 border-t border-slate-100">
                                        <label for="{{ form.caption.id_for_label }}" class="block text-xs font-medium text-slate-700 mb-1">Legenda <span class="text-red-500">*</span></label>
                                        {{ form.caption }}
                                    </div>
                                    {% endif %}
                                    {% if form.is_approved_for_report %}
                                    <div class="hidden-field">
                                        <label for="{{ form.is_approved_for_report.id_for_label }}" class="sr-only">Foto aprovada para relatório</label>
                                        {{ form.is_approved_for_report }}
                                    </div>
                                    {% endif %}
                                        {% if form.DELETE %}
                                    <div class="hidden-field">{{ form.DELETE }}</div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            
                            <script>
                            // Remove IDs duplicados dos campos de imagem no grid de preview
                            (function() {
                                var photoItems = document.querySelectorAll('#photos-preview-grid .photo-item');
                                photoItems.forEach(function(item) {
                                    var inputs = item.querySelectorAll('input, select, textarea');
                                    inputs.forEach(function(input) {
                                        // Remove ID mas mantém name para que o Django possa processar
                                        if (input.id) {
                                            input.removeAttribute('id');
                                        }
                                    });
                                });
                                
                                // Garante que os campos no formset oculto também não tenham IDs duplicados
                                var formsetContainer = document.getElementById('image-formset-container');
                                if (formsetContainer) {
                                    var formsetInputs = formsetContainer.querySelectorAll('input, select, textarea');
                                    formsetInputs.forEach(function(input) {
                                        // Remove ID se começar com id_diaryimage_set- para evitar conflitos
                                        if (input.id && input.id.startsWith('id_diaryimage_set-')) {
                                            input.removeAttribute('id');
                                        }
                                    });
                                }
                            })();
                            </script>
                            
                            <!-- Estado vazio -->
                            <div id="photos-empty-state" class="text-center py-12 {% if image_formset.forms %}hidden{% else %}block{% endif %}">
                                <div class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-images text-slate-400 text-2xl"></i>
                                </div>
                                <p class="text-sm text-slate-500">Nenhuma foto adicionada ainda</p>
                                <p class="text-xs text-slate-400 mt-1">Selecione fotos acima para começar</p>
                            </div>
                            
                            <script>
                            // Funções serão definidas no script principal abaixo
                            </script>
                            
                            <!-- Formset oculto para novas fotos (management_form já está no topo da seção) -->
                            <div id="image-formset-container" class="hidden-field">
                                {% for form in image_formset %}
                                <div class="image-form-row">
                                    {{ form.id }}
                                    <label for="{{ form.image.id_for_label }}" class="sr-only">Upload de imagem</label>
                                    {{ form.image }}
                                    <label for="{{ form.caption.id_for_label }}" class="sr-only">Legenda da foto</label>
                                    {{ form.caption }}
                                    <label for="{{ form.is_approved_for_report.id_for_label }}" class="sr-only">Foto aprovada para relatório</label>
                                    {{ form.is_approved_for_report }}
                                    {% if form.DELETE %}{{ form.DELETE }}{% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Seção: Vídeos -->
                    <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden" id="section-videos">
                        <button type="button"
                                data-toggle-section="videos"
                                class="section-toggle section-collapsed w-full flex items-center justify-between p-4 text-left bg-white hover:bg-blue-50 transition-colors border-b border-slate-200"
                                aria-expanded="false"
                                aria-label="Expandir ou recolher seção Vídeos"
                                title="Clique para expandir ou recolher">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center">
                                    <i class="fas fa-video text-slate-600 text-sm"></i>
                                </div>
                                <h3 class="text-base font-semibold text-slate-900">Vídeos</h3>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full" id="videos-count-display">0</span>
                                <i class="fas fa-chevron-down text-slate-400 transition-transform section-chevron"></i>
                            </div>
                        </button>
                        <div id="section-videos-content" class="section-content p-6 border-t border-slate-200 section-collapsed">
                            <!-- Área de Upload Múltiplo -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-slate-900 mb-3">
                                    Adicionar Vídeos
                                </label>
                                <div class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-slate-400 transition-colors bg-white">
                                    <input type="file" 
                                           id="video-upload-multiple" 
                                           name="videos" 
                                           multiple 
                                           accept="video/*"
                                           class="hidden"
                                           aria-label="Selecionar vídeos para upload"
                                           title="Selecionar vídeos"
                                           onchange="handleMultipleVideos(this)">
                                    <label for="video-upload-multiple" class="cursor-pointer block">
                                        <div class="flex flex-col items-center">
                                            <div class="w-14 h-14 rounded-lg bg-slate-200 flex items-center justify-center mb-4">
                                                <i class="fas fa-video text-slate-600 text-2xl"></i>
                                            </div>
                                            <p class="text-sm font-semibold text-slate-700 mb-1">Clique para selecionar vídeos</p>
                                            <p class="text-xs text-slate-500">ou arraste e solte aqui</p>
                                            <p class="text-xs text-slate-400 mt-2">Você pode selecionar múltiplos vídeos de uma vez</p>
                                            <p class="text-xs text-slate-500 mt-2">
                                                <i class="fas fa-info-circle mr-1"></i>Adicione os vídeos e preencha a <strong>legenda de cada um</strong> no card (obrigatório).
                                            </p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Grid de Preview dos Vídeos -->
                            <div id="videos-preview-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2">
                                {% if diary and diary.videos.exists %}
                                    {% for video in diary.videos.all %}
                                    <div class="video-item group relative border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm hover:shadow-md transition-all" data-video-id="{{ video.id }}">
                                        <div class="video-item__media aspect-video bg-white border-b border-slate-200">
                                                {% if video.video %}
                                                <video controls class="w-full h-full object-cover">
                                                            <source src="{{ video.video.url }}" type="video/mp4">
                                                            Seu navegador não suporta vídeos.
                                                        </video>
                                            {% else %}
                                                <div class="w-full h-full flex items-center justify-center">
                                                    <i class="fas fa-video text-slate-400 text-3xl"></i>
                                                    </div>
                                                {% endif %}
                                            <div class="video-item__remove">
                                                <button type="button" 
                                                        onclick="removeVideoItem(this)"
                                                        class="bg-red-600 text-white w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-700 transition-all shadow border border-white"
                                                        aria-label="Remover vídeo"
                                                        title="Remover vídeo">
                                                    <i class="fas fa-trash text-xs" aria-hidden="true"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="video-item__caption p-2 border-t border-slate-100">
                                            <label class="block text-xs font-medium text-slate-700 mb-1">Legenda <span class="text-red-500">*</span></label>
                                            <input type="text" name="video_caption_{{ video.id }}" value="{{ video.caption|default:'' }}" placeholder="Legenda deste vídeo" required
                                                   class="w-full px-2 py-1.5 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none"
                                                   aria-label="Legenda do vídeo">
                                        </div>
                                        <input type="file" name="video_{{ video.id }}" accept="video/*" class="hidden-field">
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <!-- Estado vazio -->
                            <div id="videos-empty-state" class="text-center py-12 {% if diary and diary.videos.exists %}hidden{% else %}block{% endif %}">
                                <div class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-video text-slate-400 text-2xl"></i>
                                </div>
                                <p class="text-sm text-slate-500">Nenhum vídeo adicionado ainda</p>
                                <p class="text-xs text-slate-400 mt-1">Selecione vídeos acima para começar</p>
                            </div>
                            
                        </div>
                    </div>

                    <!-- Seção: Anexos -->
                    <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden" id="section-anexos">
                        <button type="button"
                                data-toggle-section="anexos"
                                class="section-toggle section-collapsed w-full flex items-center justify-between p-4 text-left bg-white hover:bg-blue-50 transition-colors border-b border-slate-200"
                                aria-expanded="false"
                                aria-label="Expandir ou recolher seção Anexos"
                                title="Clique para expandir ou recolher">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center">
                                    <i class="fas fa-paperclip text-slate-600 text-sm"></i>
                                </div>
                                <h3 class="text-base font-semibold text-slate-900">Anexos</h3>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full" id="attachments-count-display">0</span>
                                <i class="fas fa-chevron-down text-slate-400 transition-transform section-chevron"></i>
                            </div>
                        </button>
                        <div id="section-anexos-content" class="section-content p-6 border-t border-slate-200 section-collapsed">
                            <div class="mb-6 flex items-center justify-between">
                                <div>
                                    <button type="button" 
                                            onclick="addAttachmentRow()"
                                            class="px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium transition-all duration-200 shadow-sm hover:shadow-md flex items-center">
                                        <i class="fas fa-plus mr-1.5"></i>Adicionar Anexo
                                    </button>
                                    <p class="text-xs text-slate-500 mt-2">Formatos aceitos: PDF, DOC, DOCX, XLS, XLSX, TXT</p>
                                </div>
                            </div>
                            
                            <div id="attachment-formset-container" class="space-y-3">
                                {% if diary and diary.attachments.exists %}
                                    {% for attachment in diary.attachments.all %}
                                    <div class="attachment-item border border-slate-200 rounded-lg p-4 bg-white hover:bg-blue-50 transition-colors shadow-sm">
                                        <div class="flex items-start gap-4">
                                            <div class="flex-1 space-y-4">
                                                <div>
                                                    <label class="block text-xs font-semibold text-slate-700 mb-1.5 uppercase tracking-wide">
                                                        <i class="fas fa-file mr-1.5 text-slate-500"></i>Arquivo
                                                    </label>
                                                    {% if attachment.file %}
                                                    <div class="mb-2 p-2.5 bg-white rounded-lg border border-slate-200">
                                                        <a href="{{ attachment.file.url }}" 
                                                           target="_blank" 
                                                           aria-label="Abrir anexo {{ attachment.file.name|default:'arquivo' }} em nova aba"
                                                           title="Abrir anexo em nova aba"
                                                           class="text-slate-700 hover:text-slate-900 text-sm flex items-center transition-colors group">
                                                            <i class="fas fa-file-pdf text-red-600 mr-2 text-base" aria-hidden="true"></i>
                                                            <span class="group-hover:underline font-medium">{{ attachment.name|default:attachment.file.name|truncatechars:40 }}</span>
                                                            <i class="fas fa-external-link-alt ml-2 text-xs text-slate-400"></i>
                                                        </a>
                                                    </div>
                                                    {% endif %}
                                                    <input type="file" 
                                                           name="attachment_{{ attachment.id }}" 
                                                           accept=".pdf,.doc,.docx,.xls,.xlsx,.txt" 
                                                           class="w-full px-3 py-2.5 border border-slate-300 rounded-lg text-sm text-slate-700 focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none transition-all file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-semibold text-slate-700 mb-1.5 uppercase tracking-wide">
                                                        <i class="fas fa-tag mr-1.5 text-slate-500"></i>Nome do Arquivo
                                                    </label>
                                                    <input type="text" 
                                                           name="attachment_name_{{ attachment.id }}" 
                                                           value="{{ attachment.name|default:'' }}" 
                                                           class="w-full px-3 py-2.5 border border-slate-300 rounded-lg text-sm text-slate-900 focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none transition-all" 
                                                           placeholder="Ex: Relatório de inspeção, Laudo técnico...">
                                                </div>
                                            </div>
                                            <button type="button" 
                                                    onclick="removeAttachmentItem(this)"
                                                    class="mt-6 p-2.5 text-red-600 hover:bg-red-50 rounded-lg transition-colors flex-shrink-0"
                                                    title="Remover anexo"
                                                    aria-label="Remover anexo">
                                                <i class="fas fa-trash text-base"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center py-12 bg-white rounded-lg border border-slate-200">
                                        <div class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
                                            <i class="fas fa-paperclip text-slate-400 text-2xl"></i>
                                        </div>
                                        <p class="text-sm text-slate-500">Nenhum anexo adicionado ainda</p>
                                        <p class="text-xs text-slate-400 mt-1">Clique em "Adicionar Anexo" para começar</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Seção: Assinaturas -->
                    <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden" id="section-assinaturas">
                        <button type="button"
                                data-toggle-section="assinaturas"
                                class="section-toggle section-collapsed w-full flex items-center justify-between p-4 text-left bg-white hover:bg-blue-50 transition-colors border-b border-slate-200"
                                aria-expanded="false"
                                aria-label="Expandir ou recolher seção Assinaturas"
                                title="Clique para expandir ou recolher">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center">
                                    <i class="fas fa-signature text-slate-600 text-sm"></i>
                                </div>
                                <h3 class="text-base font-semibold text-slate-900">Assinaturas</h3>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-red-600 bg-red-50 px-2 py-1 rounded-full font-medium">Obrigatório</span>
                                <i class="fas fa-chevron-down text-slate-400 transition-transform section-chevron"></i>
                            </div>
                        </button>
                        <div id="section-assinaturas-content" class="section-content p-6 border-t border-slate-200 section-collapsed">
                            <div class="max-w-md">
                                <!-- Assinatura - Responsável pelo preenchimento -->
                                <div class="border border-slate-200 rounded-lg p-5 bg-white">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-sm font-semibold text-slate-900 flex items-center">
                                            <div class="w-6 h-6 rounded bg-slate-200 flex items-center justify-center mr-2">
                                                <i class="fas fa-clipboard-check text-slate-600 text-xs"></i>
                                            </div>
                                            Responsável pelo preenchimento <span class="text-red-500 ml-0.5">*</span>
                                        </h4>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-slate-700 mb-2.5">Assinatura Manual</label>
                                        <div class="relative">
                                        <canvas id="signature-canvas-1" 
                                                    class="w-full border-2 border-slate-300 rounded-lg cursor-crosshair bg-white shadow-sm signature-canvas"></canvas>
                                            <div class="absolute top-2 right-2">
                                            <button type="button" 
                                                    onclick="if(typeof clearSignature === 'function') { clearSignature(1); } else { console.error('Função clearSignature não encontrada'); }"
                                                        class="px-3 py-1.5 bg-white text-slate-700 rounded-md hover:bg-blue-50 text-xs font-medium transition-all shadow-sm border border-slate-200"
                                                        title="Limpar assinatura">
                                                <i class="fas fa-undo mr-1"></i>Limpar
                                            </button>
                                        </div>
                                        </div>
                                        <p class="text-xs text-slate-500 mt-2 flex items-center">
                                            <i class="fas fa-info-circle mr-1.5"></i>
                                            Desenhe sua assinatura na área acima
                                        </p>
                                        <input type="hidden" name="signature_inspection" id="signature-data-1">
                                    </div>
                                    {% if diary %}
                                        {% for sig in diary.signatures.all %}
                                            {% if sig.signature_type == 'inspection' %}
                                            <div class="mt-3 p-3 bg-white rounded-lg border border-slate-200 shadow-sm">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <p class="text-xs font-medium text-slate-900">Assinado por: {{ sig.signer.get_full_name|default:sig.signer.username }}</p>
                                                        <p class="text-xs text-slate-500 mt-0.5">Em: {{ sig.signed_at|date:"d/m/Y H:i" }}</p>
                                                    </div>
                                                    <i class="fas fa-check-circle text-green-600"></i>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seção: Informações Adicionais -->
                    <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden" id="section-comentarios">
                        <button type="button"
                                data-toggle-section="comentarios"
                                class="section-toggle section-collapsed w-full flex items-center justify-between p-4 text-left bg-white hover:bg-blue-50 transition-colors border-b border-slate-200"
                                aria-expanded="false"
                                aria-label="Expandir ou recolher seção Informações Adicionais"
                                title="Clique para expandir ou recolher">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center">
                                    <i class="fas fa-info-circle text-slate-600 text-sm"></i>
                                </div>
                                <h3 class="text-base font-semibold text-slate-900">Informações Adicionais</h3>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full">Opcional</span>
                                <i class="fas fa-chevron-down text-slate-400 transition-transform section-chevron"></i>
                            </div>
                        </button>
                        <div id="section-comentarios-content" class="section-content p-6 border-t border-slate-200 section-collapsed">
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-900 mb-2 flex items-center">
                                        <i class="fas fa-sticky-note text-slate-600 text-xs mr-2"></i>
                                        Observações Gerais
                                    </label>
                                    {{ form.general_notes }}
                                    {% if form.general_notes.errors %}
                                        <p class="text-red-600 text-xs mt-1.5 flex items-center">
                                            <i class="fas fa-exclamation-circle mr-1.5"></i>{{ form.general_notes.errors }}
                                        </p>
                                    {% endif %}
                                    <p class="text-xs text-slate-500 mt-1.5">Adicione observações, comentários ou informações complementares sobre o dia de trabalho</p>
                                </div>

                                <p class="text-sm font-semibold text-slate-700 pt-6 border-t border-slate-200 mt-6">Atividades executadas</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-900 mb-2 flex items-center">
                                            <div class="w-6 h-6 rounded bg-blue-100 flex items-center justify-center mr-2">
                                                <i class="fas fa-clipboard-check text-blue-600 text-xs"></i>
                                            </div>
                                            Fiscalizações
                                        </label>
                                        {{ form.inspections }}
                                        {% if form.inspections.errors %}
                                            <p class="text-red-600 text-xs mt-1.5 flex items-center">
                                                <i class="fas fa-exclamation-circle mr-1.5"></i>{{ form.inspections.errors }}
                                            </p>
                                        {% endif %}
                                        <p class="text-xs text-slate-500 mt-1.5">Registre fiscalizações realizadas no dia</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-900 mb-2 flex items-center">
                                            <div class="w-6 h-6 rounded bg-green-100 flex items-center justify-center mr-2">
                                                <i class="fas fa-industry text-green-600 text-xs"></i>
                                            </div>
                                            DDS (Discurso Diário de Segurança)
                                        </label>
                                        {{ form.dds }}
                                        {% if form.dds.errors %}
                                            <p class="text-red-600 text-xs mt-1.5 flex items-center">
                                                <i class="fas fa-exclamation-circle mr-1.5"></i>{{ form.dds.errors }}
                                            </p>
                                        {% endif %}
                                        <p class="text-xs text-slate-500 mt-1.5">Registre o DDS realizado no dia</p>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-6 border-t border-slate-200">
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-900 mb-2 flex items-center">
                                            <div class="w-6 h-6 rounded bg-slate-100 flex items-center justify-center mr-2">
                                                <i class="fas fa-clipboard-check text-slate-600 text-xs"></i>
                                            </div>
                                            Responsável pela Inspeção
                                        </label>
                                        {{ form.inspection_responsible }}
                                        {% if form.inspection_responsible.errors %}
                                            <p class="text-red-600 text-xs mt-1.5 flex items-center">
                                                <i class="fas fa-exclamation-circle mr-1.5"></i>{{ form.inspection_responsible.errors }}
                                            </p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-900 mb-2 flex items-center">
                                            <div class="w-6 h-6 rounded bg-slate-100 flex items-center justify-center mr-2">
                                                <i class="fas fa-industry text-slate-600 text-xs"></i>
                                            </div>
                                            Responsável pela Produção
                                        </label>
                                        {{ form.production_responsible }}
                                        {% if form.production_responsible.errors %}
                                            <p class="text-red-600 text-xs mt-1.5 flex items-center">
                                                <i class="fas fa-exclamation-circle mr-1.5"></i>{{ form.production_responsible.errors }}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Sidebar de Detalhes (Direita) -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-4 sticky top-6">
                        <h3 class="text-sm font-semibold text-slate-900 mb-4 uppercase tracking-wide">Detalhes do relatório</h3>
                        <nav class="space-y-1">
                            <a href="#clima" 
                               data-section="clima"
                               aria-label="Ir para seção Condição climática"
                               class="section-link flex items-center justify-between text-sm text-slate-700 hover:text-slate-900 hover:bg-blue-50 px-2 py-2 rounded-md transition-colors cursor-pointer">
                                <span>Condição climática</span>
                            </a>
                            <a href="#mao-obra" 
                               data-section="maoObra"
                               aria-label="Ir para seção Mão de obra"
                               class="section-link flex items-center justify-between text-sm text-slate-700 hover:text-slate-900 hover:bg-blue-50 px-2 py-2 rounded-md transition-colors cursor-pointer">
                                <span>Mão de obra</span>
                            </a>
                            <a href="#equipamentos" 
                               data-section="equipamentos"
                               aria-label="Ir para seção Equipamentos"
                               class="section-link flex items-center justify-between text-sm text-slate-700 hover:text-slate-900 hover:bg-blue-50 px-2 py-2 rounded-md transition-colors cursor-pointer">
                                <span>Equipamentos</span>
                            </a>
                            <a href="#atividades" 
                               data-section="atividades"
                               aria-label="Ir para seção Atividades"
                               class="section-link flex items-center justify-between text-sm text-slate-700 hover:text-slate-900 hover:bg-blue-50 px-2 py-2 rounded-md transition-colors cursor-pointer">
                                <span>Atividades</span>
                            </a>
                            <a href="#ocorrencias" 
                               data-section="ocorrencias"
                               aria-label="Ir para seção Ocorrências"
                               class="section-link flex items-center justify-between text-sm text-slate-700 hover:text-slate-900 hover:bg-blue-50 px-2 py-2 rounded-md transition-colors cursor-pointer">
                                <span>Ocorrências</span>
                            </a>
                            <a href="#fotos" 
                               data-section="fotos"
                               aria-label="Ir para seção Fotos"
                               class="section-link flex items-center justify-between text-sm text-slate-700 hover:text-slate-900 hover:bg-blue-50 px-2 py-2 rounded-md transition-colors cursor-pointer">
                                <span>Fotos</span>
                            </a>
                            <a href="#comentarios" 
                               data-section="comentarios"
                               class="section-link flex items-center justify-between text-sm text-slate-700 hover:text-slate-900 hover:bg-blue-50 px-2 py-2 rounded-md transition-colors cursor-pointer">
                                <span>Informações Adicionais</span>
                            </a>
                        </nav>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// O AccordionManager está carregado globalmente via base.html
// Este script apenas adiciona funcionalidades específicas do formulário

// Funções de fechar modais no escopo global para onclick (modais podem estar em outro block)
function closeActivityModal() {
    var modal = document.getElementById('modal-add-activity');
    if (!modal) return;
    var opener = document.getElementById('btn-open-modal-activity');
    if (opener && typeof opener.focus === 'function') opener.focus(); else if (document.body) document.body.focus();
    modal.classList.remove('diary-modal-open');
    modal.setAttribute('aria-hidden', 'true');
}
function closeOccurrenceModal() {
    var modal = document.getElementById('modal-add-occurrence');
    if (!modal) return;
    var opener = document.getElementById('btn-open-modal-occurrence');
    if (opener && typeof opener.focus === 'function') opener.focus(); else if (document.body) document.body.focus();
    modal.classList.remove('diary-modal-open');
    modal.setAttribute('aria-hidden', 'true');
}

function editOccurrence(index) {
    if (typeof index !== 'undefined') { /* TODO: implementar edição */ }
}
function removeOccurrence(index) {
    var item = document.querySelector('.ocorrencia-item[data-form-index="' + index + '"]');
    if (item) {
        var deleteInput = item.querySelector('input[name$="-DELETE"]');
        if (!deleteInput) {
            deleteInput = document.createElement('input');
            deleteInput.type = 'hidden';
            deleteInput.name = 'ocorrencias-' + index + '-DELETE';
            deleteInput.value = 'on';
            item.appendChild(deleteInput);
        } else {
            if (deleteInput.type === 'checkbox') deleteInput.checked = true;
            else deleteInput.value = 'on';
        }
        item.style.display = 'none';
        updateOccurrenceCount();
    }
}
function updateOccurrenceCount() {
    var items = document.querySelectorAll('.ocorrencia-item');
    var count = 0;
    for (var i = 0; i < items.length; i++) {
        var item = items[i];
        if (item.style.display === 'none') continue;
        var deleteInput = item.querySelector('input[name$="-DELETE"]');
        var isDeleted = false;
        if (deleteInput) {
            if (deleteInput.type === 'checkbox') isDeleted = deleteInput.checked;
            else isDeleted = (deleteInput.value === 'on');
        }
        if (!isDeleted) count++;
    }
    var displayEl = document.getElementById('ocorrencias-count-display');
    if (displayEl) displayEl.textContent = count;
    var emptyMessage = document.getElementById('ocorrencias-empty-message');
    if (emptyMessage) emptyMessage.style.display = count > 0 ? 'none' : 'block';
}
function removeActivity(index) {
    var item = document.querySelector('.activity-item[data-form-index="' + index + '"]');
    if (item) {
        var deleteInput = item.querySelector('input[name$="-DELETE"]');
        if (!deleteInput) {
            deleteInput = document.createElement('input');
            deleteInput.type = 'hidden';
            deleteInput.name = 'work_logs-' + index + '-DELETE';
            deleteInput.value = 'on';
            item.appendChild(deleteInput);
        } else {
            if (deleteInput.type === 'checkbox') deleteInput.checked = true;
            else deleteInput.value = 'on';
        }
        item.style.display = 'none';
        if (typeof updateActivityCount === 'function') updateActivityCount();
    }
}

// Função para atualizar informações de data usando input nativo
document.addEventListener('DOMContentLoaded', function() {
    var dateInput = document.querySelector('#id_date');
    var weekdaySelect = document.getElementById('weekday-display');
    
    if (dateInput) {
        // Converte data do formato YYYY-MM-DD para dd/mm/yyyy e atualiza dia da semana
        function updateDateFromNativeInput() {
            if (dateInput.value) {
                // O input type="date" retorna no formato YYYY-MM-DD
                var date = new Date(dateInput.value + 'T00:00:00');
                
                // Atualiza dia da semana
                if (weekdaySelect) {
                    var weekdays = ['Domingo', 'Segunda-Feira', 'Terça-Feira', 'Quarta-Feira', 'Quinta-Feira', 'Sexta-Feira', 'Sábado'];
                    weekdaySelect.value = weekdays[date.getDay()];
                }
            }
        }
        
        // Atualiza quando a data muda
        dateInput.addEventListener('change', updateDateFromNativeInput);
        dateInput.addEventListener('input', updateDateFromNativeInput);
        
        // Atualiza inicialmente se já houver uma data
        if (dateInput.value) {
            updateDateFromNativeInput();
        }
    }
    
    // Se houver data inicial do formulário, converte para o formato do input
    {% if form.instance.date %}
    try {
        var dateInput = document.querySelector('#id_date');
        if (dateInput) {
            // Converte de dd/mm/yyyy para YYYY-MM-DD
            var dateStr = '{{ form.instance.date|date:"Y-m-d" }}';
            if (dateStr && dateStr !== 'None' && dateStr.trim() !== '') {
                dateInput.value = dateStr;
                
                // Atualiza dia da semana
                var weekdaySelect = document.getElementById('weekday-display');
                if (weekdaySelect) {
                    var weekdays = ['Domingo', 'Segunda-Feira', 'Terça-Feira', 'Quarta-Feira', 'Quinta-Feira', 'Sexta-Feira', 'Sábado'];
                    var dateObj = new Date(dateStr);
                    if (!isNaN(dateObj.getTime())) {
                        weekdaySelect.value = weekdays[dateObj.getDay()];
                    }
                }
            }
        }
    } catch (e) {
        if (console && console.error) {
        console.error('Erro ao processar data inicial:', e);
        }
    }
    {% endif %}
    
    // Navegação por links da sidebar
    var sectionLinks = document.querySelectorAll('.section-link');
    for (var i = 0; i < sectionLinks.length; i++) {
        sectionLinks[i].addEventListener('click', function(e) {
            e.preventDefault();
            var sectionId = this.getAttribute('data-section');
            var section = document.getElementById('section-' + sectionId);
            if (section) {
                // Abre a seção se estiver fechada
                var content = section.querySelector('.section-content');
                var toggle = section.querySelector('[data-toggle-section="' + sectionId + '"]');
                if (content) {
                    var computedDisplay = window.getComputedStyle(content).display;
                    if (computedDisplay === 'none') {
                        // Usa a função global toggleSection
                        if (window.toggleSection) {
                            window.toggleSection(sectionId);
                        } else if (toggle) {
                            toggle.click();
                        }
                    }
                }
                // Faz scroll suave até a seção (com fallback para browsers antigos)
                if (section.scrollIntoView) {
                    try {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } catch (e) {
                        // Fallback para browsers que não suportam smooth scroll
                        section.scrollIntoView();
                    }
                }
            }
        });
    }
    
    // Atualiza contadores iniciais
    updateActivityCount();
    updateLaborTotals();
    updateOccurrenceCount();
    
    // Função simplificada - apenas atualiza contador de clima (definida mais abaixo)

// Função para atualizar informações de data
function updateDateInfo(dateStr) {
    // Converte data de dd/mm/yyyy para objeto Date
    const [day, month, year] = dateStr.split('/');
    const date = new Date(year, month - 1, day);
    
    // Função mantida para compatibilidade, mas não é mais usada com input nativo
    // O input nativo já atualiza automaticamente via event listeners
}

// Função para atualizar contador de atividades
function updateActivityCount() {
    var forms = document.querySelectorAll('.worklog-form-row:not([style*="display: none"])');
    var count = Array.prototype.filter.call(forms, function(form) {
        var deleteCheckbox = form.querySelector('input[name$="-DELETE"]');
        return !deleteCheckbox || !deleteCheckbox.checked;
    }).length;
    
    var countElement = document.getElementById('activities-count');
    if (countElement) {
        countElement.textContent = count;
    }
}

// Variável global para armazenar lista de trabalhadores
var laborList = [];

// Função global para adicionar trabalhador à lista
window.addLaborItem = function(event) {
    if (event) {
    event.preventDefault();
        event.stopPropagation();
    }
    
    try {
        var nameEl = document.getElementById('labor-name');
        var roleEl = document.getElementById('labor-role');
        var quantityEl = document.getElementById('labor-quantity');
        var hourlyRateEl = document.getElementById('labor-hourly-rate');
        
        if (!nameEl || !roleEl || !quantityEl || !hourlyRateEl) {
            if (console && console.error) {
                console.error('Elementos do formulário não encontrados');
            }
            alert('Erro: Elementos do formulário não encontrados.');
            return false;
        }
        
        var name = nameEl.value.trim();
        var role = roleEl.value;
        var quantity = parseInt(quantityEl.value) || 1;
        var hourlyRate = parseFloat(hourlyRateEl.value) || 0;
        
        // Validação manual do campo role
        if (!role) {
            alert('Por favor, selecione a função/categoria.');
            roleEl.focus();
            roleEl.classList.add('border-red-500');
            return false;
        }
        roleEl.classList.remove('border-red-500');
    
    var roleNames = {
        'EN': 'Engenheiro',
        'ME': 'Mestre',
        'SE': 'Servente',
        'PE': 'Pedreiro',
        'CA': 'Carpinteiro',
        'EL': 'Eletricista',
        'HI': 'Hidráulico',
        'AR': 'Armador',
        'OU': 'Outros'
    };
    
        var laborItem = {
        id: Date.now(),
        name: name,
        role: role,
        roleName: roleNames[role] || 'Outros',
        quantity: quantity,
        hourlyRate: hourlyRate
    };
    
        if (typeof laborList === 'undefined') {
            laborList = [];
        }
        
        // Se já existe mesma função/categoria (e mesmo nome se preenchido), soma na quantidade em vez de nova linha
        var merged = false;
        for (var m = 0; m < laborList.length; m++) {
            if (laborList[m].role === role && (laborList[m].name || '') === (name || '')) {
                laborList[m].quantity = (laborList[m].quantity || 1) + quantity;
                merged = true;
                break;
            }
        }
        if (!merged) {
            laborList.push(laborItem);
        }
    renderLaborList();
    updateLaborTotals();
    
        // Limpa o formulário e fecha o modal APÓS salvar
        var form = document.getElementById('labor-form');
        var modal = document.getElementById('modal-add-labor');
        if (form) {
            form.reset();
        }
        if (modal) {
            modal.classList.add('hidden');
        }
        
        return false;
    } catch (error) {
        if (console && console.error) {
            console.error('Erro ao adicionar trabalhador:', error);
        }
        alert('Erro ao adicionar trabalhador. Verifique o console para mais detalhes.');
        return false;
    }
};

// Função para renderizar lista de trabalhadores
function renderLaborList() {
    var container = document.getElementById('labor-list');
    if (!container) return;
    
    if (typeof laborList === 'undefined' || !laborList || laborList.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Nenhum trabalhador adicionado. Clique em "Adicionar Trabalhador" para começar.</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < laborList.length; i++) {
        var item = laborList[i];
        var nameDisplay = item.name || item.roleName;
        var nameSubtitle = item.name ? '<p class="text-xs text-gray-600">' + item.roleName + '</p>' : '';
        var hourlyRateDisplay = item.hourlyRate > 0 ? '<span class="text-xs text-gray-600 ml-4">R$ ' + item.hourlyRate.toFixed(2) + '/h</span>' : '';
        
        html += '<div class="labor-item bg-gray-50 border border-gray-200 rounded-lg p-4 flex items-center justify-between hover:bg-gray-100 transition-colors" data-id="' + item.id + '">';
        html += '<div class="flex-1">';
        html += '<div class="flex items-center space-x-3">';
        html += '<div class="flex-1">';
        html += '<p class="text-sm font-semibold text-gray-900">' + (nameDisplay || '') + '</p>';
        html += nameSubtitle;
        html += '</div>';
        html += '<div class="flex items-center space-x-2">';
        html += '<button type="button" onclick="updateLaborQuantity(' + i + ', -1)" class="w-8 h-8 flex items-center justify-center bg-slate-100 hover:bg-slate-200 rounded-md text-slate-700 transition-colors">';
        html += '<i class="fas fa-minus text-xs"></i>';
        html += '</button>';
        html += '<input type="number" value="' + (item.quantity || 1) + '" min="1" onchange="updateLaborQuantity(' + i + ', 0, this.value)" class="w-16 px-2 py-1 text-center text-sm font-semibold border border-slate-300 rounded-md focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none">';
        html += '<button type="button" onclick="updateLaborQuantity(' + i + ', 1)" class="w-8 h-8 flex items-center justify-center bg-slate-100 hover:bg-slate-200 rounded-md text-slate-700 transition-colors">';
        html += '<i class="fas fa-plus text-xs"></i>';
        html += '</button>';
        html += '</div>';
        html += hourlyRateDisplay;
        html += '</div>';
        html += '</div>';
        html += '<button type="button" onclick="removeLaborItem(' + i + ')" class="ml-4 p-2 text-red-600 hover:bg-red-50 rounded-md transition-colors" aria-label="Remover trabalhador" title="Remover">';
        html += '<i class="fas fa-trash text-sm" aria-hidden="true"></i>';
        html += '</button>';
        html += '</div>';
    }
    
    container.innerHTML = html;
}

// Função para atualizar quantidade de trabalhador
function updateLaborQuantity(index, delta, value) {
    if (index < 0 || index >= laborList.length) return;
    
    if (value !== null && value !== undefined) {
        laborList[index].quantity = Math.max(1, parseInt(value) || 1);
    } else {
        laborList[index].quantity = Math.max(1, laborList[index].quantity + delta);
    }
    
    renderLaborList();
    updateLaborTotals();
}

// Função para remover trabalhador (exposta no window para onclick dinâmico)
function removeLaborItem(index) {
    if (typeof laborList === 'undefined' || !laborList) return;
    index = parseInt(index, 10);
    if (index < 0 || index >= laborList.length) return;
    
    laborList.splice(index, 1);
    renderLaborList();
    updateLaborTotals();
}
window.removeLaborItem = removeLaborItem;
window.updateLaborQuantity = updateLaborQuantity;

// --- Mão de obra por categorias/cargos (novo UX) ---
(function() {
    var diaryLaborState = {};
    function key(cargoId, company) { return company ? cargoId + '|' + company : String(cargoId); }
    function getDiaryLaborPayload() {
        var out = [];
        for (var k in diaryLaborState) {
            if (diaryLaborState[k] <= 0) continue;
            var parts = k.split('|');
            out.push({ cargo_id: parseInt(parts[0], 10), quantity: diaryLaborState[k], company: parts[1] || '' });
        }
        return out;
    }
    window.getDiaryLaborPayload = getDiaryLaborPayload;

    function setQuantity(cargoId, company, qty) {
        var k = key(cargoId, company);
        diaryLaborState[k] = Math.max(0, parseInt(qty, 10) || 0);
        var inp = document.querySelector('.diary-labor-qty[data-cargo-id="' + cargoId + '"][data-company="' + (company || '') + '"]');
        if (inp) inp.value = diaryLaborState[k];
    }
    function changeQty(cargoId, company, delta) {
        var k = key(cargoId, company);
        diaryLaborState[k] = (diaryLaborState[k] || 0) + delta;
        if (diaryLaborState[k] < 0) diaryLaborState[k] = 0;
        var inp = document.querySelector('.diary-labor-qty[data-cargo-id="' + cargoId + '"][data-company="' + (company || '') + '"]');
        if (inp) inp.value = diaryLaborState[k];
    }

    function initFromExisting() {
        var el = document.getElementById('existing-diary-labor-data');
        if (!el) return;
        try {
            var data = JSON.parse(el.textContent || '[]');
            for (var i = 0; i < data.length; i++) {
                var e = data[i];
                setQuantity(e.cargo_id, e.company || '', e.quantity);
            }
            var companies = [];
            for (var k in diaryLaborState) {
                if (k.indexOf('|') !== -1 && diaryLaborState[k] > 0) {
                    var company = k.split('|').slice(1).join('|');
                    if (companies.indexOf(company) === -1) companies.push(company);
                }
            }
            var cargosEl = document.getElementById('terceirizada-cargos-data');
            var cargos = [];
            if (cargosEl) try { cargos = JSON.parse(cargosEl.textContent || '[]'); } catch (e) {}
            var container = document.getElementById('terceirizada-empresas');
            for (var c = 0; c < companies.length; c++) {
                var companyName = companies[c];
                if (!container || !companyName) continue;
                var card = document.createElement('div');
                card.className = 'terceirizada-empresa-card rounded-lg border border-amber-200 bg-amber-50/50 p-4';
                card.setAttribute('data-company', companyName);
                var html = '<div class="flex items-center justify-between mb-3"><strong class="text-slate-800">' + escapeHtml(companyName) + '</strong><button type="button" class="terceirizada-remove-empresa text-red-600 hover:text-red-800 text-sm" data-company="' + escapeHtml(companyName) + '"><i class="fas fa-times mr-1"></i>Remover</button></div><ul class="space-y-2">';
                for (var j = 0; j < cargos.length; j++) {
                    var cargo = cargos[j];
                    var q = diaryLaborState[key(cargo.id, companyName)] || 0;
                    html += '<li class="flex items-center justify-between gap-2 py-1"><span class="text-sm text-slate-700">' + escapeHtml(cargo.name) + '</span>';
                    html += '<div class="flex items-center gap-1"><button type="button" class="diary-labor-minus w-8 h-8 flex items-center justify-center rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-700" data-cargo-id="' + cargo.id + '" data-company="' + escapeHtml(companyName) + '"><i class="fas fa-minus text-xs"></i></button>';
                    html += '<input type="number" min="0" value="' + q + '" class="diary-labor-qty w-14 text-center py-1.5 border border-slate-300 rounded-lg text-sm" data-cargo-id="' + cargo.id + '" data-company="' + escapeHtml(companyName) + '">';
                    html += '<button type="button" class="diary-labor-plus w-8 h-8 flex items-center justify-center rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-700" data-cargo-id="' + cargo.id + '" data-company="' + escapeHtml(companyName) + '"><i class="fas fa-plus text-xs"></i></button></div></li>';
                }
                html += '</ul>';
                card.innerHTML = html;
                container.appendChild(card);
                card.querySelector('.terceirizada-remove-empresa') && card.querySelector('.terceirizada-remove-empresa').addEventListener('click', function() {
                    var cn = this.getAttribute('data-company');
                    var qs = document.querySelectorAll('.diary-labor-qty[data-company="' + cn + '"]');
                    for (var i = 0; i < qs.length; i++) setQuantity(parseInt(qs[i].getAttribute('data-cargo-id'), 10), cn, 0);
                    card.remove();
                });
            }
            var allInputs = document.querySelectorAll('.diary-labor-qty');
            for (var i = 0; i < allInputs.length; i++) {
                var inpx = allInputs[i];
                var cid = inpx.getAttribute('data-cargo-id');
                var comp = (inpx.getAttribute('data-company') || '').trim();
                if (cid) {
                    var k = key(parseInt(cid, 10), comp);
                    if (diaryLaborState.hasOwnProperty(k)) inpx.value = diaryLaborState[k];
                }
            }
        } catch (err) {}
    }
    function bindPlusMinus() {
        document.getElementById('diary-labor-by-category') && document.getElementById('diary-labor-by-category').addEventListener('click', function(ev) {
            var plus = ev.target.closest('.diary-labor-plus');
            var minus = ev.target.closest('.diary-labor-minus');
            var cargoId = (plus && plus.getAttribute('data-cargo-id')) || (minus && minus.getAttribute('data-cargo-id'));
            var company = (plus && plus.getAttribute('data-company')) || (minus && minus.getAttribute('data-company')) || '';
            if (!cargoId) return;
            if (plus) changeQty(parseInt(cargoId, 10), company, 1);
            if (minus) changeQty(parseInt(cargoId, 10), company, -1);
        });
        document.getElementById('diary-labor-by-category') && document.getElementById('diary-labor-by-category').addEventListener('change', function(ev) {
            var inp = ev.target;
            if (inp && inp.classList && inp.classList.contains('diary-labor-qty')) {
                var cid = inp.getAttribute('data-cargo-id');
                var company = inp.getAttribute('data-company') || '';
                if (cid) setQuantity(parseInt(cid, 10), company, parseInt(inp.value, 10) || 0);
            }
        });
    }
    function addTerceirizadaEmpresa() {
        var el = document.getElementById('terceirizada-cargos-data');
        if (!el) return;
        var cargos;
        try { cargos = JSON.parse(el.textContent || '[]'); } catch (e) { return; }
        var companyName = prompt('Nome da empresa terceirizada:', '');
        if (companyName === null || !companyName.trim()) return;
        companyName = companyName.trim();
        var container = document.getElementById('terceirizada-empresas');
        if (!container) return;
        var card = document.createElement('div');
        card.className = 'terceirizada-empresa-card rounded-lg border border-amber-200 bg-amber-50/50 p-4';
        card.setAttribute('data-company', companyName);
        var html = '<div class="flex items-center justify-between mb-3"><strong class="text-slate-800">' + escapeHtml(companyName) + '</strong><button type="button" class="terceirizada-remove-empresa text-red-600 hover:text-red-800 text-sm" data-company="' + escapeHtml(companyName) + '"><i class="fas fa-times mr-1"></i>Remover</button></div><ul class="space-y-2">';
        for (var j = 0; j < cargos.length; j++) {
            var c = cargos[j];
            html += '<li class="flex items-center justify-between gap-2 py-1"><span class="text-sm text-slate-700">' + escapeHtml(c.name) + '</span>';
            html += '<div class="flex items-center gap-1"><button type="button" class="diary-labor-minus w-8 h-8 flex items-center justify-center rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-700" data-cargo-id="' + c.id + '" data-company="' + escapeHtml(companyName) + '"><i class="fas fa-minus text-xs"></i></button>';
            html += '<input type="number" min="0" value="0" class="diary-labor-qty w-14 text-center py-1.5 border border-slate-300 rounded-lg text-sm" data-cargo-id="' + c.id + '" data-company="' + escapeHtml(companyName) + '">';
            html += '<button type="button" class="diary-labor-plus w-8 h-8 flex items-center justify-center rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-700" data-cargo-id="' + c.id + '" data-company="' + escapeHtml(companyName) + '"><i class="fas fa-plus text-xs"></i></button></div></li>';
        }
        html += '</ul>';
        card.innerHTML = html;
        container.appendChild(card);
        card.querySelector('.terceirizada-remove-empresa') && card.querySelector('.terceirizada-remove-empresa').addEventListener('click', function() {
            var cn = this.getAttribute('data-company');
            var qs = document.querySelectorAll('.diary-labor-qty[data-company="' + cn + '"]');
            for (var i = 0; i < qs.length; i++) setQuantity(parseInt(qs[i].getAttribute('data-cargo-id'), 10), cn, 0);
            card.remove();
        });
    }
    function escapeHtml(s) {
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initFromExisting();
            bindPlusMinus();
            var btn = document.getElementById('btn-add-terceirizada-empresa');
            if (btn) btn.addEventListener('click', addTerceirizadaEmpresa);
        });
    } else {
        initFromExisting();
        bindPlusMinus();
        var btn = document.getElementById('btn-add-terceirizada-empresa');
        if (btn) btn.addEventListener('click', addTerceirizadaEmpresa);
    }
})();

// Função para atualizar totalizadores de mão de obra
function updateLaborTotals() {
    if (typeof laborList === 'undefined' || !laborList) {
        laborList = [];
    }
    
    var totals = {
        'EN': 0, 'ME': 0, 'SE': 0, 'PE': 0, 'CA': 0,
        'EL': 0, 'HI': 0, 'AR': 0, 'OU': 0
    };
    
    // Soma as quantidades por categoria
    for (var i = 0; i < laborList.length; i++) {
        var item = laborList[i];
        if (item && totals.hasOwnProperty(item.role)) {
            totals[item.role] += item.quantity || 0;
        }
    }
    
    var grandTotal = 0;
    var totalsKeys = Object.keys(totals);
    for (var j = 0; j < totalsKeys.length; j++) {
        var key = totalsKeys[j];
        var element = document.getElementById('labor-total-' + key);
        if (element) {
            element.textContent = totals[key];
            grandTotal += totals[key];
        }
    }
    
    var totalDisplay = document.getElementById('labor-total');
    var totalHeader = document.getElementById('labor-total-header');
    
    if (totalDisplay) totalDisplay.textContent = grandTotal;
    if (totalHeader) totalHeader.textContent = grandTotal;
}

// Função para atualizar contador de clima
function updateClimaCount() {
    var morningEl = document.getElementById('weather_morning_enabled');
    var afternoonEl = document.getElementById('weather_afternoon_enabled');
    var morningChecked = (morningEl && morningEl.checked) || false;
    var afternoonChecked = (afternoonEl && afternoonEl.checked) || false;
    var checkedCount = 0;
    if (morningChecked) checkedCount++;
    if (afternoonChecked) checkedCount++;
    
    var countEl = document.getElementById('clima-count');
    if (countEl) countEl.textContent = checkedCount;
}

// updateOccurrenceCount está definido no topo do script (escopo global)

// Variável global para armazenar lista de equipamentos (legado)
var equipmentList = [];

// --- Equipamentos por categorias (novo UX) ---
(function() {
    var diaryEquipmentState = {};  // standard: key = "std-{id}", value = quantity; custom: key = "custom-{id}", value = { name, quantity }
    var customEquipmentId = 0;
    function getEquipmentPayload() {
        var byName = {};
        for (var k in diaryEquipmentState) {
            if (k.indexOf('std-') === 0) {
                var id = k.replace('std-', '');
                var inp = document.querySelector('.diary-equipment-qty[data-equipment-id="' + id + '"]');
                var qState = parseInt(diaryEquipmentState[k], 10) || 0;
                var qFromInput = (inp && inp.value !== undefined && inp.value !== '') ? (parseInt(inp.value, 10) || 0) : 0;
                var q = Math.max(qState, qFromInput);
                if (q <= 0) continue;
                var name = inp ? (inp.getAttribute('data-equipment-name') || '') : '';
                if (name) byName[name] = Math.max(byName[name] || 0, q);
            } else if (k.indexOf('custom-') === 0) {
                var v = diaryEquipmentState[k];
                if (v && v.quantity > 0 && v.name) byName[v.name] = Math.max(byName[v.name] || 0, v.quantity);
            }
        }
        var allInputs = document.querySelectorAll('.diary-equipment-qty[data-equipment-id][data-equipment-name]');
        for (var i = 0; i < allInputs.length; i++) {
            var inp = allInputs[i];
            var name = (inp.getAttribute('data-equipment-name') || '').trim();
            var qty = parseInt(inp.value, 10) || 0;
            if (name && qty > 0) byName[name] = Math.max(byName[name] || 0, qty);
        }
        var out = [];
        for (var n in byName) if (byName[n] > 0) out.push({ name: n, quantity: byName[n] });
        return out;
    }
    window.getEquipmentPayload = getEquipmentPayload;

    function setEquipmentQty(id, name, qty) {
        var k = 'std-' + id;
        diaryEquipmentState[k] = Math.max(0, parseInt(qty, 10) || 0);
        var inp = document.querySelector('.diary-equipment-qty[data-equipment-id="' + id + '"]');
        if (inp) inp.value = diaryEquipmentState[k];
    }
    function changeEquipmentQty(id, name, delta) {
        var k = 'std-' + id;
        diaryEquipmentState[k] = (parseInt(diaryEquipmentState[k], 10) || 0) + delta;
        if (diaryEquipmentState[k] < 0) diaryEquipmentState[k] = 0;
        var inp = document.querySelector('.diary-equipment-qty[data-equipment-id="' + id + '"]');
        if (inp) inp.value = diaryEquipmentState[k];
    }

    function bindEquipmentButtons() {
        var container = document.getElementById('diary-equipment-by-category');
        if (!container) return;
        container.addEventListener('click', function(ev) {
            var plus = ev.target.closest('.diary-equipment-plus');
            var minus = ev.target.closest('.diary-equipment-minus');
            var id = (plus && plus.getAttribute('data-equipment-id')) || (minus && minus.getAttribute('data-equipment-id'));
            var name = (plus && plus.getAttribute('data-equipment-name')) || (minus && minus.getAttribute('data-equipment-name'));
            if (!id || !name) return;
            if (plus) changeEquipmentQty(id, name, 1);
            if (minus) changeEquipmentQty(id, name, -1);
        });
    }
    function addCustomEquipment(name, quantity) {
        customEquipmentId++;
        var k = 'custom-' + customEquipmentId;
        diaryEquipmentState[k] = { name: name, quantity: quantity };
        renderCustomEquipmentList();
    }
    function removeCustomEquipment(key) {
        delete diaryEquipmentState[key];
        renderCustomEquipmentList();
    }
    function renderCustomEquipmentList() {
        var container = document.getElementById('equipment-custom-list');
        if (!container) return;
        var keys = [];
        for (var k in diaryEquipmentState) if (k.indexOf('custom-') === 0 && diaryEquipmentState[k].quantity > 0) keys.push(k);
        if (keys.length === 0) { container.innerHTML = ''; return; }
        var html = '';
        for (var i = 0; i < keys.length; i++) {
            var k = keys[i], v = diaryEquipmentState[k];
            html += '<div class="flex items-center justify-between gap-2 py-2 px-3 bg-slate-50 rounded-lg border border-slate-200">';
            html += '<span class="text-sm font-medium text-slate-800">' + (v.name || '').replace(/</g, '&lt;') + '</span>';
            html += '<div class="flex items-center gap-1">';
            html += '<button type="button" class="diary-equipment-minus w-8 h-8 flex items-center justify-center rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-700" data-custom-key="' + k + '"><i class="fas fa-minus text-xs"></i></button>';
            html += '<span class="w-8 text-center text-sm font-semibold">' + (v.quantity || 0) + '</span>';
            html += '<button type="button" class="diary-equipment-plus w-8 h-8 flex items-center justify-center rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-700" data-custom-key="' + k + '"><i class="fas fa-plus text-xs"></i></button>';
            html += '</div>';
            html += '<button type="button" class="remove-custom-equipment text-red-600 hover:text-red-800 text-sm" data-custom-key="' + k + '"><i class="fas fa-trash"></i></button>';
            html += '</div>';
        }
        container.innerHTML = html;
        container.querySelectorAll('.remove-custom-equipment').forEach(function(btn) {
            btn.addEventListener('click', function() { removeCustomEquipment(this.getAttribute('data-custom-key')); });
        });
        container.querySelectorAll('.diary-equipment-plus[data-custom-key]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var key = this.getAttribute('data-custom-key');
                if (diaryEquipmentState[key]) { diaryEquipmentState[key].quantity = (diaryEquipmentState[key].quantity || 0) + 1; renderCustomEquipmentList(); }
            });
        });
        container.querySelectorAll('.diary-equipment-minus[data-custom-key]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var key = this.getAttribute('data-custom-key');
                if (diaryEquipmentState[key]) {
                    diaryEquipmentState[key].quantity = Math.max(0, (diaryEquipmentState[key].quantity || 0) - 1);
                    if (diaryEquipmentState[key].quantity === 0) delete diaryEquipmentState[key];
                    renderCustomEquipmentList();
                }
            });
        });
    }
    window.addCustomEquipmentItem = function(event) {
        if (event) event.preventDefault();
        var nameEl = document.getElementById('equipment-name');
        var qtyEl = document.getElementById('equipment-quantity');
        if (!nameEl || !qtyEl) return false;
        var name = (nameEl.value || '').trim();
        var qty = parseInt(qtyEl.value, 10) || 1;
        if (!name) { alert('Preencha o nome do equipamento.'); return false; }
        addCustomEquipment(name, qty);
        if (nameEl) nameEl.value = '';
        if (qtyEl) qtyEl.value = '1';
        document.getElementById('modal-add-equipment').classList.add('hidden');
        return false;
    };
    function initEquipmentFromExisting() {
        var el = document.getElementById('existing-diary-equipment-data');
        if (!el) return;
        try {
            var data = JSON.parse(el.textContent || '[]');
            console.log('[DIARY_DEBUG] existing-diary-equipment-data (parsed):', JSON.stringify(data));
            var allInputs = document.querySelectorAll('.diary-equipment-qty[data-equipment-id][data-equipment-name]');
            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                var name = (item.name || '').trim();
                var qty = Math.max(1, parseInt(item.quantity, 10) || 1);
                if (!name) continue;
                var found = false;
                for (var j = 0; j < allInputs.length; j++) {
                    if ((allInputs[j].getAttribute('data-equipment-name') || '') === name) {
                        var id = allInputs[j].getAttribute('data-equipment-id');
                        if (id) { setEquipmentQty(id, name, qty); found = true; break; }
                    }
                }
                if (!found) addCustomEquipment(name, qty);
            }
            console.log('[DIARY_DEBUG] after initEquipmentFromExisting diaryEquipmentState (snapshot):', JSON.stringify(diaryEquipmentState));
        } catch (err) { console.warn('initEquipmentFromExisting:', err); }
    }
    function initEquipmentUI() {
        bindEquipmentButtons();
        initEquipmentFromExisting();
        var btnCustom = document.getElementById('btn-add-custom-equipment');
        if (btnCustom) btnCustom.addEventListener('click', function() { document.getElementById('modal-add-equipment').classList.remove('hidden'); });
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initEquipmentUI);
    else initEquipmentUI();
})();

// Função para adicionar equipamento à lista (legado - modal "outro")
function addEquipmentItem(event) {
    try {
    event.preventDefault();
    
        var nameInput = document.getElementById('equipment-name');
        var quantityInput = document.getElementById('equipment-quantity');
        
        if (!nameInput || !quantityInput) {
            console.error('Campos do formulário não encontrados');
            return;
        }
        
        var name = nameInput.value.trim();
        var quantity = parseInt(quantityInput.value) || 1;
    
    if (!name) {
        alert('Por favor, preencha o nome do equipamento.');
        return;
    }
    
        var equipmentItem = {
        id: Date.now(),
        name: name,
        quantity: quantity
    };
    
        // Adiciona à lista ANTES de limpar
    equipmentList.push(equipmentItem);
        console.log('Equipamento adicionado:', equipmentItem);
        console.log('Lista atual:', equipmentList);
        
    renderEquipmentList();
    updateEquipmentTotals();
    updateEquipmentCount();
    
        // Limpa o formulário e fecha o modal APÓS salvar
        var form = document.getElementById('equipment-form');
        var modal = document.getElementById('modal-add-equipment');
        if (form) {
            form.reset();
        }
        if (modal) {
            modal.classList.add('hidden');
        }
        
        return false;
    } catch (error) {
        console.error('Erro ao adicionar equipamento:', error);
        alert('Erro ao adicionar equipamento. Verifique o console para mais detalhes.');
    }
}

// Torna a função globalmente acessível
window.addEquipmentItem = addEquipmentItem;

// Função para renderizar lista de equipamentos
function renderEquipmentList() {
    try {
        var container = document.getElementById('equipment-list');
        if (!container) {
            console.error('Container equipment-list não encontrado');
            return;
        }
        
        console.log('Renderizando lista de equipamentos. Total:', equipmentList.length);
    
    if (equipmentList.length === 0) {
            container.innerHTML = '<p class="text-sm text-slate-500 text-center py-4">Nenhum equipamento adicionado. Clique em "Adicionar Equipamento" para começar.</p>';
        return;
    }
    
        var html = '';
        for (var i = 0; i < equipmentList.length; i++) {
            var item = equipmentList[i];
            html += '<div class="equipment-item bg-white border border-slate-200 rounded-lg p-4 flex items-center justify-between hover:bg-blue-50 transition-colors" data-id="' + item.id + '">' +
                '<div class="flex-1">' +
                '<div class="flex items-center space-x-3">' +
                '<div class="flex-1">' +
                '<p class="text-sm font-semibold text-slate-900">' + (item.name || 'Sem nome') + '</p>' +
                '</div>' +
                '<div class="flex items-center space-x-2">' +
                '<button type="button" ' +
                'onclick="updateEquipmentQuantity(' + i + ', -1)" ' +
                'class="w-8 h-8 flex items-center justify-center bg-slate-100 hover:bg-slate-200 rounded-md text-slate-700 transition-colors">' +
                '<i class="fas fa-minus text-xs"></i>' +
                '</button>' +
                '<input type="number" ' +
                'value="' + (item.quantity || 1) + '" ' +
                'min="1" ' +
                'onchange="updateEquipmentQuantity(' + i + ', 0, this.value)" ' +
                'class="w-16 px-2 py-1 text-center text-sm font-semibold border border-slate-300 rounded-md focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none">' +
                '<button type="button" ' +
                'onclick="updateEquipmentQuantity(' + i + ', 1)" ' +
                'class="w-8 h-8 flex items-center justify-center bg-slate-100 hover:bg-slate-200 rounded-md text-slate-700 transition-colors">' +
                '<i class="fas fa-plus text-xs"></i>' +
                '</button>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<button type="button" ' +
                'onclick="removeEquipmentItem(' + i + ')" ' +
                'class="ml-4 px-3 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium transition-all duration-200 shadow-sm hover:shadow-md flex items-center">' +
                '<i class="fas fa-trash mr-1.5 text-xs"></i>Remover' +
                '</button>' +
                '</div>';
        }
        
        container.innerHTML = html;
        console.log('Lista renderizada com sucesso');
    } catch (error) {
        console.error('Erro ao renderizar lista de equipamentos:', error);
    }
}

// Torna a função globalmente acessível
window.renderEquipmentList = renderEquipmentList;

// Função para atualizar quantidade de equipamento
function updateEquipmentQuantity(index, delta, value) {
    if (index < 0 || index >= equipmentList.length) return;
    
    if (value !== undefined && value !== null) {
        equipmentList[index].quantity = Math.max(1, parseInt(value) || 1);
    } else {
        equipmentList[index].quantity = Math.max(1, equipmentList[index].quantity + delta);
    }
    
    renderEquipmentList();
    updateEquipmentTotals();
    updateEquipmentCount();
}

// Torna a função globalmente acessível
window.updateEquipmentQuantity = updateEquipmentQuantity;

// Função para remover equipamento (exposta no window para onclick dinâmico)
function removeEquipmentItem(index) {
    index = parseInt(index, 10);
    if (index < 0 || index >= equipmentList.length) return;
    
    equipmentList.splice(index, 1);
    renderEquipmentList();
    updateEquipmentTotals();
    updateEquipmentCount();
}

// Torna a função globalmente acessível
window.removeEquipmentItem = removeEquipmentItem;

// Função para atualizar totalizadores de equipamentos
function updateEquipmentTotals() {
    var grandTotal = 0;
    
    // Calcula total geral
    for (var i = 0; i < equipmentList.length; i++) {
        grandTotal += equipmentList[i].quantity;
    }
    
    // Atualiza mensagem no container
    var totalsContainer = document.getElementById('equipment-totals');
    if (totalsContainer) {
        if (grandTotal === 0) {
            totalsContainer.innerHTML = '<p class="text-sm text-slate-500 text-center py-2">Nenhum equipamento adicionado</p>';
        } else {
            totalsContainer.innerHTML = '';
        }
    }
    
    // Atualiza total geral
    var totalHeader = document.getElementById('equipment-total-header');
    if (totalHeader) {
        totalHeader.textContent = grandTotal;
    }
}

// Função para atualizar contador de equipamentos
function updateEquipmentCount() {
    // Função mantida para compatibilidade, mas contador foi removido do HTML
    const count = equipmentList.length;
}

// Função para mostrar/ocultar campos adicionais
function toggleMoreOptions(checkbox) {
    var row = checkbox.closest('.worklog-form-row');
    if (!row) return;
    
    var moreOptionsFields = row.querySelector('.more-options-fields');
    if (!moreOptionsFields) return;
    
    if (checkbox.checked) {
        moreOptionsFields.classList.remove('hidden');
    } else {
        moreOptionsFields.classList.add('hidden');
    }
}

// Função para calcular total de horas
function calculateTotalHours(startTimeInput, endTimeInput, totalHoursInput) {
    if (!startTimeInput || !endTimeInput || !totalHoursInput) return;
    
    var startTime = startTimeInput.value;
    var endTime = endTimeInput.value;
    
    if (startTime && endTime) {
        var startParts = startTime.split(':');
        var endParts = endTime.split(':');
        
        if (startParts.length === 2 && endParts.length === 2) {
            var startMinutes = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
            var endMinutes = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);
            
            if (endMinutes < startMinutes) {
                // Se hora fim for menor que hora início, assume que passou da meia-noite
                endMinutes += 24 * 60;
            }
            
            var diffMinutes = endMinutes - startMinutes;
            var hours = Math.floor(diffMinutes / 60);
            var minutes = diffMinutes % 60;
            
            var hoursStr = String(hours);
            var minutesStr = String(minutes);
            if (hoursStr.length === 1) hoursStr = '0' + hoursStr;
            if (minutesStr.length === 1) minutesStr = '0' + minutesStr;
            
            totalHoursInput.value = hoursStr + ':' + minutesStr;
        }
    } else {
        totalHoursInput.value = '';
    }
}

// Função para inicializar cálculo de horas em uma linha
function initHoursCalculation(row) {
    if (!row) return;
    
    var startTimeInput = row.querySelector('input[name*="start_time"]');
    var endTimeInput = row.querySelector('input[name*="end_time"]');
    var totalHoursInput = row.querySelector('.total-hours-input');
    
    if (startTimeInput && endTimeInput && totalHoursInput) {
        var calcHours = function() {
            calculateTotalHours(startTimeInput, endTimeInput, totalHoursInput);
        };
        
        startTimeInput.addEventListener('change', calcHours);
        endTimeInput.addEventListener('change', calcHours);
    }
}

// Torna as funções globalmente acessíveis
window.toggleMoreOptions = toggleMoreOptions;
window.calculateTotalHours = calculateTotalHours;
window.initHoursCalculation = initHoursCalculation;

// Inicializa cálculo de horas em todas as linhas existentes ao carregar
document.addEventListener('DOMContentLoaded', function() {
    var rows = document.querySelectorAll('.worklog-form-row');
    for (var i = 0; i < rows.length; i++) {
        initHoursCalculation(rows[i]);
    }
});

// Funções para gerenciar WorkLog Formset
function addWorkLogRow() {
    var container = document.getElementById('worklog-formset-container');
    if (!container) {
        console.error('Container worklog-formset-container não encontrado');
        alert('Erro: Container de atividades não encontrado. Recarregue a página.');
        return;
    }
    
    // Prefixo do formset (deve ser work_logs - related_name no modelo)
    var workLogPrefix = 'work_logs';
    var totalForms = document.getElementById('id_' + workLogPrefix + '-TOTAL_FORMS') ||
                     document.querySelector('input[name="' + workLogPrefix + '-TOTAL_FORMS"]');
    
    if (!totalForms) {
        console.error('Campo TOTAL_FORMS não encontrado. Tentando criar...');
        var managementForm = container.previousElementSibling;
        if (managementForm && managementForm.querySelector) {
            totalForms = managementForm.querySelector('input[name*="TOTAL_FORMS"]');
        }
        if (!totalForms) {
            var existingForms = container.querySelectorAll('.activity-item').length;
            var hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = workLogPrefix + '-TOTAL_FORMS';
            hiddenInput.id = 'id_' + workLogPrefix + '-TOTAL_FORMS';
            hiddenInput.value = existingForms;
            if (container.parentNode) {
                container.parentNode.insertBefore(hiddenInput, container);
            }
            totalForms = hiddenInput;
        }
    }
    
    var formNum = parseInt(totalForms.value, 10) || container.querySelectorAll('.activity-item').length || 0;
    
    // Cria nova linha (classe activity-item para consistência com itens renderizados no servidor)
    var newForm = document.createElement('div');
    newForm.className = 'activity-item worklog-form-row border border-slate-200 rounded-lg p-5 bg-white';
    newForm.setAttribute('data-form-index', formNum);
    newForm.innerHTML = '<div class="mb-4">' +
        '<label class="block text-sm font-semibold text-slate-900 mb-2" for="' + workLogPrefix + '-' + formNum + '-activity_description">Descrição <span class="text-red-500">*</span></label>' +
        '<textarea name="' + workLogPrefix + '-' + formNum + '-activity_description" id="id_' + workLogPrefix + '-' + formNum + '-activity_description" rows="2" style="height: 4rem; max-height: 5.5rem;" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none text-sm text-slate-900 placeholder:text-slate-400 transition-all resize-y" aria-label="Descreva a atividade executada" placeholder="Descreva a atividade executada..." required></textarea>' +
        '</div>' +
        '<div class="mb-4">' +
        '<div><label class="block text-sm font-medium text-slate-700 mb-1.5" for="' + workLogPrefix + '-' + formNum + '-percentage_executed_today">Porcentagem (%)</label>' +
        '<input type="number" name="' + workLogPrefix + '-' + formNum + '-percentage_executed_today" id="id_' + workLogPrefix + '-' + formNum + '-percentage_executed_today" step="0.01" min="0" max="100" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none text-sm text-slate-900 transition-all" aria-label="Progresso executado hoje em percentual" placeholder="0.00"></div>' +
        '</div>' +
        '<div class="mb-4">' +
        '<label class="block text-sm font-medium text-slate-700 mb-1.5" for="' + workLogPrefix + '-' + formNum + '-work_stage">Status</label>' +
        '<select name="' + workLogPrefix + '-' + formNum + '-work_stage" id="id_' + workLogPrefix + '-' + formNum + '-work_stage" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none text-sm text-slate-900 transition-all" aria-label="Status da atividade">' +
        '<option value="IN">Iniciada</option>' +
        '<option value="AN" selected>Em andamento</option>' +
        '<option value="TE">Finalizada</option>' +
        '</select>' +
        '</div>' +
        '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-location" value="">' +
        '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-accumulated_progress_snapshot" value="">' +
        '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-start_time" value="">' +
        '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-end_time" value="">' +
        '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-quantity_done" value="">' +
        '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-unit" value="">' +
        '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-notes" value="">' +
        '<div class="mt-4 flex items-center justify-end pt-4 border-t border-slate-200">' +
        '<button type="button" onclick="removeWorkLogRow(this)" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium transition-all duration-200 shadow-sm hover:shadow-md flex items-center" aria-label="Remover atividade" title="Remover"><i class="fas fa-trash mr-1.5 text-xs"></i>Remover</button>' +
        '</div><input type="hidden" name="' + workLogPrefix + '-' + formNum + '-id" value="">';
    
    container.appendChild(newForm);
    totalForms.value = formNum + 1;
    updateActivityCount();
    
    // Inicializa cálculo de horas na nova linha
    initHoursCalculation(newForm);
    
    console.log('Nova atividade adicionada. Total de forms:', totalForms.value);
}

// Torna as funções globalmente acessíveis
window.addWorkLogRow = addWorkLogRow;

function removeWorkLogRow(button) {
    const row = button.closest('.worklog-form-row') || button.closest('.activity-item');
    if (!row) return;
    const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');
    if (deleteCheckbox) {
        deleteCheckbox.checked = true;
        row.style.display = 'none';
    } else {
        row.remove();
    }
    updateActivityCount();
}

// Funções para gerenciar Fotos com múltiplas seleções
function handleMultiplePhotos(input) {
    if (!input || !input.files || input.files.length === 0) {
        console.log('Nenhum arquivo selecionado');
        return;
    }
    
    // Verifica suporte a DataTransfer
    var supportsDataTransfer = typeof DataTransfer !== 'undefined';
    if (!supportsDataTransfer) {
        alert('Seu navegador não suporta upload de múltiplas fotos desta forma. Por favor, use um navegador moderno (Chrome, Firefox ou Edge atualizado).');
        return;
    }
    
    var container = document.getElementById('image-formset-container');
    var previewGrid = document.getElementById('photos-preview-grid');
    var emptyState = document.getElementById('photos-empty-state');
    
    // Busca TOTAL_FORMS em vários lugares (seção pode estar recolhida; id pode ter sido removido por script)
    var totalForms = document.getElementById('id_diaryimage_set-TOTAL_FORMS') ||
                     document.querySelector('#section-fotos-content input[name="diaryimage_set-TOTAL_FORMS"]') ||
                     document.querySelector('#diary-form input[name="diaryimage_set-TOTAL_FORMS"]') ||
                     document.querySelector('input[name="diaryimage_set-TOTAL_FORMS"]');
    
    if (!totalForms) {
        var sectionContent = document.getElementById('section-fotos-content');
        if (sectionContent) {
            totalForms = document.createElement('input');
            totalForms.type = 'hidden';
            totalForms.name = 'diaryimage_set-TOTAL_FORMS';
            totalForms.id = 'id_diaryimage_set-TOTAL_FORMS';
            totalForms.value = '0';
            sectionContent.insertBefore(totalForms, sectionContent.firstChild);
            if (!document.querySelector('#section-fotos-content input[name="diaryimage_set-INITIAL_FORMS"]')) {
                var initInput = document.createElement('input');
                initInput.type = 'hidden';
                initInput.name = 'diaryimage_set-INITIAL_FORMS';
                initInput.id = 'id_diaryimage_set-INITIAL_FORMS';
                initInput.value = '0';
                sectionContent.insertBefore(initInput, totalForms);
            }
            if (!document.querySelector('#section-fotos-content input[name="diaryimage_set-MIN_NUM_FORMS"]')) {
                var minInput = document.createElement('input');
                minInput.type = 'hidden';
                minInput.name = 'diaryimage_set-MIN_NUM_FORMS';
                minInput.id = 'id_diaryimage_set-MIN_NUM_FORMS';
                minInput.value = '0';
                sectionContent.insertBefore(minInput, totalForms);
            }
            if (!document.querySelector('#section-fotos-content input[name="diaryimage_set-MAX_NUM_FORMS"]')) {
                var maxInput = document.createElement('input');
                maxInput.type = 'hidden';
                maxInput.name = 'diaryimage_set-MAX_NUM_FORMS';
                maxInput.id = 'id_diaryimage_set-MAX_NUM_FORMS';
                maxInput.value = '1000';
                sectionContent.insertBefore(maxInput, totalForms);
            }
        } else {
            console.error('section-fotos-content não encontrado');
            return;
        }
    }
    
    // Cria container se não existir
    if (!container) {
        console.warn('Container image-formset-container não encontrado. Criando...');
        var sectionContent = document.getElementById('section-fotos-content');
        if (sectionContent) {
            container = document.createElement('div');
            container.id = 'image-formset-container';
            container.className = 'hidden-field';
            sectionContent.appendChild(container);
            console.log('Container criado com sucesso');
        } else {
            console.error('Não foi possível criar container: section-fotos-content não encontrado');
            return;
        }
    }
    
    if (!previewGrid) {
        console.error('Elemento photos-preview-grid não encontrado');
        return;
    }
    
    var formNum = parseInt(totalForms.value) || 0;
    
    // Esconde estado vazio
    if (emptyState) {
        emptyState.style.display = 'none';
    }
    
    console.log('Processando', input.files.length, 'foto(s), formNum inicial:', formNum);
    
    // Legenda global opcional (preenche o campo de cada nova foto; o usuário pode editar depois)
    var globalCaption = document.getElementById('photos-caption-global');
    var captionValue = (globalCaption && globalCaption.value) ? String(globalCaption.value).trim() : '';
    
    // Processa cada foto selecionada
    for (var i = 0; i < input.files.length; i++) {
        (function(file, currentFormNum) {
            var imageName = 'diaryimage_set-' + currentFormNum + '-image';
            var captionName = 'diaryimage_set-' + currentFormNum + '-caption';
            var approvedName = 'diaryimage_set-' + currentFormNum + '-is_approved_for_report';
            
            // Cria card de preview imediatamente (sem imagem ainda)
            var photoCard = document.createElement('div');
            photoCard.className = 'photo-item group relative border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm hover:shadow-md transition-all cursor-pointer';
            photoCard.setAttribute('data-form-index', currentFormNum);
            
            photoCard.innerHTML = '<div class="photo-item__media aspect-square bg-slate-100">' +
                '<img src="" alt="Preview" class="w-full h-full object-cover" style="display: none;">' +
                '<div class="absolute inset-0 flex items-center justify-center bg-slate-200 photo-loading-spinner">' +
                '<i class="fas fa-spinner fa-spin text-slate-400 text-lg"></i>' +
                '</div>' +
                '<div class="photo-item__remove">' +
                '<button type="button" onclick="removePhotoItem(this)" class="bg-red-600 text-white w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-700 transition-all shadow border border-white" aria-label="Remover foto" title="Remover foto">' +
                '<i class="fas fa-times text-xs" aria-hidden="true"></i>' +
                '</button>' +
                '</div>' +
                '</div>' +
                '<div class="photo-item__caption p-2 border-t border-slate-100">' +
                '<label class="block text-xs font-medium text-slate-700 mb-1">Legenda <span class="text-red-500">*</span></label>' +
                '<input type="text" name="' + captionName + '" value="' + (captionValue.replace(/"/g, '&quot;')) + '" placeholder="Legenda desta foto" required class="w-full px-2 py-1.5 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none" aria-label="Legenda da foto">' +
                '</div>' +
                '<input type="hidden" name="diaryimage_set-' + currentFormNum + '-id" value="">';
            
            // Garante que o grid está visível
            previewGrid.style.display = 'grid';
            
            // Adiciona o card ao grid imediatamente
            previewGrid.appendChild(photoCard);
            console.log('Preview adicionado ao grid para formNum:', currentFormNum);
            
            // Usa FileReader para criar data URL (compatível com CSP)
            var reader = new FileReader();
            reader.onload = function(e) {
                var img = photoCard.querySelector('img');
                var spinner = photoCard.querySelector('.photo-loading-spinner');
                if (img) {
                    img.src = e.target.result;
                    img.style.display = 'block';
                }
                if (spinner) {
                    spinner.style.display = 'none';
                }
            };
            reader.onerror = function() {
                console.error('Erro ao carregar preview da imagem');
                var spinner = photoCard.querySelector('.photo-loading-spinner');
                if (spinner) {
                    spinner.innerHTML = '<i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>';
                }
            };
            reader.readAsDataURL(file);
            
            // Esconde estado vazio se ainda estiver visível
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Cria form oculto no formset com o arquivo
            var hiddenForm = document.createElement('div');
            hiddenForm.className = 'image-form-row';
            hiddenForm.style.display = 'none';
            
            // Cria input file e tenta atribuir o arquivo usando DataTransfer
            var fileInputHidden = document.createElement('input');
            fileInputHidden.type = 'file';
            fileInputHidden.name = imageName;
            fileInputHidden.accept = 'image/*';
            fileInputHidden.style.display = 'none';
            // Não adiciona ID para evitar duplicação
            fileInputHidden.removeAttribute('id');
            fileInputHidden.setAttribute('aria-label', 'Upload de imagem');
            
            // Tenta usar DataTransfer para atribuir o arquivo (suportado em navegadores modernos)
            try {
                if (typeof DataTransfer !== 'undefined') {
                    var dt2 = new DataTransfer();
                    dt2.items.add(file);
                    fileInputHidden.files = dt2.files;
                    console.log('Arquivo atribuído via DataTransfer para', imageName);
    } else {
                    console.warn('DataTransfer não suportado neste navegador');
                }
            } catch(e) {
                console.error('Erro ao atribuir arquivo:', e);
            }
            
            // Verifica se o arquivo foi atribuído corretamente
            if (!fileInputHidden.files || fileInputHidden.files.length === 0) {
                console.error('ERRO CRÍTICO: Não foi possível atribuir o arquivo ao input!');
                console.error('Arquivo:', file.name, 'Tamanho:', file.size, 'Tipo:', file.type);
                // Tenta uma abordagem alternativa: clonar o input original
                var originalInput = input;
                if (originalInput && originalInput.files && originalInput.files.length > 0) {
                    // Cria um novo input file e tenta copiar
                    var newInput = document.createElement('input');
                    newInput.type = 'file';
                    newInput.name = imageName;
                    newInput.accept = 'image/*';
                    newInput.style.display = 'none';
                    newInput.removeAttribute('id');
                    
                    // Tenta usar DataTransfer novamente
                    try {
                        if (typeof DataTransfer !== 'undefined') {
                            var dt3 = new DataTransfer();
                            dt3.items.add(file);
                            newInput.files = dt3.files;
                            if (newInput.files && newInput.files.length > 0) {
                                fileInputHidden = newInput;
                                console.log('Arquivo atribuído com sucesso usando input alternativo');
                            }
                        }
                    } catch(e2) {
                        console.error('Erro na tentativa alternativa:', e2);
                    }
                }
            }
            
            var form = document.getElementById('diary-form');
            if (!form) {
                console.error('❌ Formulário principal não encontrado!');
                return;
            }
            
            // Checkbox de aprovação e ID: dentro do hiddenForm para a validação no submit encontrá-los no mesmo .image-form-row
            var approvedInputHidden = document.createElement('input');
            approvedInputHidden.type = 'checkbox';
            approvedInputHidden.name = approvedName;
            approvedInputHidden.checked = true;
            approvedInputHidden.removeAttribute('id');
            approvedInputHidden.style.display = 'none';
            approvedInputHidden.setAttribute('aria-label', 'Foto aprovada para relatório');
            var idInputHidden = document.createElement('input');
            idInputHidden.type = 'hidden';
            idInputHidden.name = 'diaryimage_set-' + currentFormNum + '-id';
            idInputHidden.value = '';
            idInputHidden.removeAttribute('id');
            
            // Coloca file, approved e id DENTRO do .image-form-row para o submit e a validação (querySelectorAll('.image-form-row')) encontrarem
            hiddenForm.appendChild(fileInputHidden);
            hiddenForm.appendChild(approvedInputHidden);
            hiddenForm.appendChild(idInputHidden);
            container.appendChild(hiddenForm);
            
            // Remove o input file do card de preview (não é necessário lá)
            var previewFileInput = photoCard.querySelector('input[type="file"]');
            if (previewFileInput) {
                previewFileInput.remove();
            }
            
            console.log('✅ Todos os campos adicionados ao formulário principal:');
            console.log('  - Input file:', fileInputHidden.name);
            console.log('  - Caption: no card (visível), name=', captionName);
            console.log('  - Approved:', approvedInputHidden.name, '=', approvedInputHidden.checked);
            console.log('  - ID:', idInputHidden.name);
            
            // Sincroniza checkbox de aprovação
            var approvedInputPreview = photoCard.querySelector('input[type="checkbox"]');
            if (approvedInputPreview) {
                approvedInputPreview.addEventListener('change', function() {
                    approvedInputHidden.checked = this.checked;
                });
            }
            
            // Atualiza total de forms ANTES de processar a próxima foto
            var currentTotal = parseInt(totalForms.value) || 0;
            var newTotal = Math.max(currentTotal, currentFormNum + 1);
            totalForms.value = newTotal;
            
            // Verificação final: confirma que o arquivo está no input antes de continuar
            if (!fileInputHidden.files || fileInputHidden.files.length === 0) {
                console.error('❌ ERRO FINAL: Arquivo não está no input após todas as tentativas!');
                console.error('FormNum:', currentFormNum, 'Arquivo:', file.name);
                // Remove o card de preview se não conseguiu salvar
                if (photoCard && photoCard.parentNode) {
                    photoCard.parentNode.removeChild(photoCard);
                }
                return; // Interrompe o processamento desta foto
            }
            
            console.log('✅ Foto processada com sucesso! FormNum:', currentFormNum, 'Total de forms:', newTotal);
            console.log('✅ Input name:', fileInputHidden.name);
            console.log('✅ Arquivo:', file.name, 'Tamanho:', file.size, 'bytes');
        })(input.files[i], formNum + i);
    }
    
    // Atualiza contador e esconde estado vazio após processar todas as fotos
    setTimeout(function() {
        // Garante que o grid está visível
        if (previewGrid) {
            previewGrid.style.display = 'grid';
        }
        
        // Esconde estado vazio se houver fotos
        var photoItems = previewGrid ? previewGrid.querySelectorAll('.photo-item') : [];
        if (photoItems.length > 0 && emptyState) {
            emptyState.style.display = 'none';
        }
        
    updatePhotoCount();
    }, 50);
    
    // Limpa o input para permitir adicionar mais fotos
    input.value = '';
    console.log('Processamento concluído');
}

// Torna a função globalmente acessível
// Funções já expostas globalmente acima (linha ~2754), não precisa duplicar

function removePhotoItem(button) {
    var photoCard = button.closest('.photo-item');
    var formIndex = photoCard.getAttribute('data-form-index');
    
    // Remove o card de preview
    photoCard.remove();
    
    // Marca como DELETE no formset oculto
    var hiddenForms = document.querySelectorAll('.image-form-row');
    if (hiddenForms[formIndex]) {
        var deleteInput = hiddenForms[formIndex].querySelector('input[name$="-DELETE"]');
        if (!deleteInput) {
            deleteInput = document.createElement('input');
            deleteInput.type = 'hidden';
            deleteInput.name = 'diaryimage_set-' + formIndex + '-DELETE';
            hiddenForms[formIndex].appendChild(deleteInput);
        }
        deleteInput.value = 'on';
    }
    
    // Verifica se ainda há fotos
    var previewGrid = document.getElementById('photos-preview-grid');
    var emptyState = document.getElementById('photos-empty-state');
    if (previewGrid && previewGrid.children.length === 0 && emptyState) {
        emptyState.style.display = 'block';
    }
    
    updatePhotoCount();
}

// Função para atualizar todas as legendas das fotos
function updateAllPhotoCaptions(captionValue) {
    var hiddenForms = document.querySelectorAll('.image-form-row');
    for (var i = 0; i < hiddenForms.length; i++) {
        var captionInput = hiddenForms[i].querySelector('input[name$="-caption"]');
        if (captionInput) {
            captionInput.value = captionValue || '';
        }
    }
    
    // Atualiza também os campos de legenda nos cards de preview (visível ou hidden)
    var photoCards = document.querySelectorAll('.photo-item');
    for (var j = 0; j < photoCards.length; j++) {
        var captionInput = photoCards[j].querySelector('input[name$="-caption"]');
        if (captionInput) {
            captionInput.value = captionValue || '';
        }
    }
}

// Torna as funções globalmente acessíveis
// Torna as funções globalmente acessíveis
window.handleMultiplePhotos = handleMultiplePhotos;
window.removePhotoItem = removePhotoItem;
window.updateAllPhotoCaptions = updateAllPhotoCaptions;

// Verifica se as funções foram definidas corretamente (após a definição)
if (typeof window.handleMultiplePhotos === 'undefined') {
    console.error('handleMultiplePhotos não foi definida corretamente!');
}

function updatePhotoCount() {
    // Conta fotos no grid de preview (mais confiável)
    var previewGrid = document.getElementById('photos-preview-grid');
    var count = 0;
    if (previewGrid) {
        var photoItems = previewGrid.querySelectorAll('.photo-item');
        count = photoItems.length;
    } else {
        // Fallback: conta forms
        var forms = document.querySelectorAll('.image-form-row:not([style*="display: none"])');
        for (var i = 0; i < forms.length; i++) {
            var form = forms[i];
            var deleteCheckbox = form.querySelector('input[name$="-DELETE"]');
            if (!deleteCheckbox || !deleteCheckbox.checked) {
                count++;
            }
        }
    }
    
    var photosCountEl = document.getElementById('photos-count');
    var photosDisplayEl = document.getElementById('photos-count-display');
    if (photosCountEl) photosCountEl.textContent = count;
    if (photosDisplayEl) photosDisplayEl.textContent = count;
}

// Funções para gerenciar Ocorrências
function openOccurrenceModal() {
    var modal = document.getElementById('modal-add-occurrence');
    if (modal) {
        modal.classList.add('diary-modal-open');
        modal.setAttribute('aria-hidden', 'false');
        // Limpa o formulário
        document.getElementById('occurrence-description').value = '';
        document.getElementById('tag-search-input').value = '';
        document.getElementById('custom-tag-input').value = '';
        
        // Desmarca todos os checkboxes
        var allCheckboxes = document.querySelectorAll('input[name="occurrence-tags"]:checked, input[name="occurrence-tags-custom"]:checked');
        for (var i = 0; i < allCheckboxes.length; i++) {
            allCheckboxes[i].checked = false;
        }
        
        // Remove tags customizadas temporárias
        var customTagInputs = document.querySelectorAll('input[name="occurrence-tags-custom"]');
        for (var j = 0; j < customTagInputs.length; j++) {
            var customLabel = customTagInputs[j].closest('label');
            if (customLabel) {
                customLabel.remove();
            }
        }
        
        // Mostra todas as tags novamente
        var tagOptions = document.querySelectorAll('.tag-option');
        for (var k = 0; k < tagOptions.length; k++) {
            tagOptions[k].style.display = '';
        }
        
        // Atualiza preview
        updateSelectedTagsPreview();
        
    }
}

// Função para filtrar tags na busca
function filterTags(searchTerm) {
    var searchLower = (searchTerm || '').toLowerCase();
    var tagOptions = document.querySelectorAll('.tag-option');
    for (var i = 0; i < tagOptions.length; i++) {
        var tagName = tagOptions[i].getAttribute('data-tag-name');
        if (tagName && tagName.indexOf(searchLower) !== -1) {
            tagOptions[i].style.display = '';
        } else {
            tagOptions[i].style.display = 'none';
        }
    }
}
window.filterTags = filterTags;

// Função para adicionar tag customizada
function addCustomTag() {
    var input = document.getElementById('custom-tag-input');
    if (!input) {
        console.error('Campo custom-tag-input não encontrado');
        return false;
    }
    
    var tagName = input.value.trim();
    
    if (!tagName) {
        alert('Por favor, digite o nome da tag.');
        return false;
    }
    
    // Verifica se já existe nas tags do banco
    var existingCheckboxes = document.querySelectorAll('input[name="occurrence-tags"]');
    for (var i = 0; i < existingCheckboxes.length; i++) {
        var label = existingCheckboxes[i].closest('label');
        if (label) {
            var span = label.querySelector('span');
            if (span && span.textContent.trim().toLowerCase() === tagName.toLowerCase()) {
                // Já existe, apenas marca
                existingCheckboxes[i].checked = true;
                updateSelectedTagsPreview();
                input.value = '';
                return false;
            }
        }
    }
    
    // Verifica se já existe nas tags customizadas
    var existingCustomCheckboxes = document.querySelectorAll('input[name="occurrence-tags-custom"]');
    for (var j = 0; j < existingCustomCheckboxes.length; j++) {
        if (existingCustomCheckboxes[j].value.toLowerCase() === tagName.toLowerCase()) {
            // Já existe, apenas marca
            existingCustomCheckboxes[j].checked = true;
            updateSelectedTagsPreview();
            input.value = '';
            return false;
        }
    }
    
    // Adiciona nova tag customizada
    var container = document.getElementById('tags-list-container');
    if (!container) {
        console.error('Container tags-list-container não encontrado');
        return false;
    }
    
    var newLabel = document.createElement('label');
    newLabel.className = 'flex items-center p-2 hover:bg-blue-50 rounded-md cursor-pointer transition-colors tag-option';
    newLabel.setAttribute('data-tag-name', tagName.toLowerCase());
    
    var checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.name = 'occurrence-tags-custom';
    checkbox.value = tagName;
    checkbox.className = 'w-4 h-4 text-slate-600 border-slate-300 rounded focus:ring-slate-500 cursor-pointer';
    checkbox.setAttribute('data-custom-tag', 'true');
    checkbox.addEventListener('change', updateSelectedTagsPreview);
    
    var span = document.createElement('span');
    span.className = 'ml-2 text-sm text-slate-900';
    span.textContent = tagName;
    
    newLabel.appendChild(checkbox);
    newLabel.appendChild(span);
    container.appendChild(newLabel);
    
    checkbox.checked = true;
    updateSelectedTagsPreview();
    input.value = '';
    
    return false;
}

// Torna a função globalmente acessível
window.addCustomTag = addCustomTag;

// Função para atualizar preview de tags selecionadas
function updateSelectedTagsPreview() {
    var previewContainer = document.getElementById('selected-tags-preview');
    if (!previewContainer) return;
    
    previewContainer.innerHTML = '';
    
    // Tags do banco
    var checkboxes = document.querySelectorAll('input[name="occurrence-tags"]:checked');
    for (var i = 0; i < checkboxes.length; i++) {
        var label = checkboxes[i].closest('label');
        if (label) {
            var tagName = label.querySelector('span').textContent.trim();
            var tagId = checkboxes[i].value;
            var tag = document.createElement('span');
            tag.className = 'inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-700 border border-slate-300';
            tag.textContent = tagName;
            previewContainer.appendChild(tag);
        }
    }
    
    // Tags customizadas
    var customCheckboxes = document.querySelectorAll('input[name="occurrence-tags-custom"]:checked');
    for (var j = 0; j < customCheckboxes.length; j++) {
        var customTagName = customCheckboxes[j].value;
        var customTag = document.createElement('span');
        customTag.className = 'inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-200 text-slate-800 border border-slate-400';
        customTag.textContent = customTagName + ' (custom)';
        previewContainer.appendChild(customTag);
    }
}

// Função para toggle de mais opções
// Funções removidas - não são mais necessárias após remoção da seção "Exibir mais opções"

function saveOccurrence(event) {
    if (event) {
    event.preventDefault();
        event.stopPropagation();
    }
    
    var descriptionInput = document.getElementById('occurrence-description');
    if (!descriptionInput) {
        console.error('Campo occurrence-description não encontrado');
        return false;
    }
    
    var description = descriptionInput.value.trim();
    if (!description) {
        alert('Por favor, preencha a descrição da ocorrência.');
        return false;
    }
    
    // Coleta tags selecionadas (do banco) ANTES de limpar
    var selectedTags = [];
    var tagCheckboxes = document.querySelectorAll('input[name="occurrence-tags"]:checked');
    for (var i = 0; i < tagCheckboxes.length; i++) {
        selectedTags.push(tagCheckboxes[i].value);
    }
    
    // Coleta tags customizadas ANTES de limpar
    var customTags = [];
    var customCheckboxes = document.querySelectorAll('input[name="occurrence-tags-custom"]:checked');
    for (var j = 0; j < customCheckboxes.length; j++) {
        customTags.push(customCheckboxes[j].value);
    }
    
    var container = document.getElementById('ocorrencias-formset-container');
    var occPrefix = 'ocorrencias';
    var totalForms = document.querySelector('input[name="' + occPrefix + '-TOTAL_FORMS"]') ||
                     document.getElementById('id_' + occPrefix + '-TOTAL_FORMS');
    
    if (!container) {
        console.error('Container ocorrencias-formset-container não encontrado');
        return false;
    }
    
    if (!totalForms) {
        var formsetContainer = document.getElementById('ocorrencias-formset-container');
        if (formsetContainer) {
            var hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = occPrefix + '-TOTAL_FORMS';
            hiddenInput.id = 'id_' + occPrefix + '-TOTAL_FORMS';
            hiddenInput.value = container.querySelectorAll('.ocorrencia-item').length;
            if (formsetContainer.parentNode) {
                formsetContainer.parentNode.insertBefore(hiddenInput, formsetContainer);
            }
            totalForms = hiddenInput;
        } else {
            console.error('Não foi possível criar TOTAL_FORMS');
            return false;
        }
    }
    
    var formNum = parseInt(totalForms.value) || container.querySelectorAll('.ocorrencia-item').length || 0;
    
    // Cria novo item
    var newItem = document.createElement('div');
    newItem.className = 'ocorrencia-item border border-slate-200 rounded-lg p-4 bg-slate-50 hover:bg-slate-100 transition-colors';
    newItem.setAttribute('data-form-index', formNum);
    
    // Monta tags HTML se houver
    var tagsHtml = '';
    var allTags = selectedTags.concat(customTags);
    
    if (allTags.length > 0) {
        tagsHtml = '<div class="flex flex-wrap gap-2 mt-2">';
        
        // Tags do banco
        for (var k = 0; k < selectedTags.length; k++) {
            var tagId = selectedTags[k];
            var tagCheckbox = document.querySelector('input[name="occurrence-tags"][value="' + tagId + '"]');
            if (tagCheckbox) {
                var tagLabel = tagCheckbox.closest('label');
                if (tagLabel) {
                    var tagName = tagLabel.querySelector('span').textContent.trim();
                    tagsHtml += '<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium shadow-sm bg-slate-100 text-slate-700 border border-slate-300"><i class="fas fa-tag mr-1 text-xs"></i>' + tagName + '</span>';
                }
            }
        }
        
        // Tags customizadas
        for (var l = 0; l < customTags.length; l++) {
            var customTagName = customTags[l];
            tagsHtml += '<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium shadow-sm bg-slate-200 text-slate-800 border border-slate-400"><i class="fas fa-tag mr-1 text-xs"></i>' + customTagName + ' <span class="text-xs opacity-75">(custom)</span></span>';
        }
        
        tagsHtml += '</div>';
    }
    
    var descEscaped = description.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    var tagsInputs = '';
    for (var t = 0; t < selectedTags.length; t++) {
        tagsInputs += '<input type="hidden" name="' + occPrefix + '-' + formNum + '-tags" value="' + selectedTags[t] + '">';
    }
    newItem.innerHTML = '<div class="flex items-start justify-between">' +
        '<div class="flex-1">' +
        '<p class="text-sm font-medium text-slate-900 mb-2 leading-relaxed">' + description + '</p>' +
        tagsHtml +
        '</div>' +
        '<div class="flex items-center space-x-2 ml-4">' +
        '<button type="button" onclick="editOccurrence(' + formNum + ')" class="p-2 text-slate-600 hover:bg-slate-200 rounded-md transition-colors" aria-label="Editar ocorrência" title="Editar"><i class="fas fa-edit text-sm" aria-hidden="true"></i></button>' +
        '<button type="button" onclick="removeOccurrence(' + formNum + ')" class="p-2 text-red-600 hover:bg-red-50 rounded-md transition-colors" aria-label="Remover ocorrência" title="Remover"><i class="fas fa-trash text-sm" aria-hidden="true"></i></button>' +
        '</div>' +
        '</div>' +
        '<input type="hidden" name="' + occPrefix + '-' + formNum + '-id" value="">' +
        '<input type="hidden" name="' + occPrefix + '-' + formNum + '-description" value="' + descEscaped + '">' +
        tagsInputs;
    
    // Adiciona o item ao container ANTES de limpar qualquer coisa
    container.appendChild(newItem);
    
    // Atualiza TOTAL_FORMS ANTES de limpar
    totalForms.value = (formNum + 1).toString();
    
    // Limpa apenas os campos do formulário do modal (não os dados já salvos no formset)
    var descriptionInput = document.getElementById('occurrence-description');
    if (descriptionInput) {
        descriptionInput.value = '';
    }
    
    var searchInput = document.getElementById('tag-search-input');
    if (searchInput) {
        searchInput.value = '';
    }
    
    // Desmarca todos os checkboxes de tags
    var allCheckboxes = document.querySelectorAll('input[name="occurrence-tags"]:checked, input[name="occurrence-tags-custom"]:checked');
    for (var m = 0; m < allCheckboxes.length; m++) {
        allCheckboxes[m].checked = false;
    }
    
    // Remove tags customizadas temporárias (apenas as que foram adicionadas nesta sessão)
    var customTagInputs = document.querySelectorAll('input[name="occurrence-tags-custom"]');
    for (var n = 0; n < customTagInputs.length; n++) {
        var customLabel = customTagInputs[n].closest('label');
        if (customLabel && customLabel.getAttribute('data-tag-name')) {
            customLabel.remove();
        }
    }
    
    updateSelectedTagsPreview();
    
    closeOccurrenceModal();
    updateOccurrenceCount();
    
    return false;
}

// Torna a função globalmente acessível
window.saveOccurrence = saveOccurrence;

// editOccurrence e removeOccurrence estão definidos no topo do script (escopo global)

// Funções para gerenciar Atividades
function saveActivity(event) {
    try {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        var descriptionInput = document.getElementById('activity-description');
        if (!descriptionInput) {
            console.error('Campo activity-description não encontrado');
            alert('Erro: formulário de atividade não encontrado. Recarregue a página.');
            return false;
        }
        
        var description = descriptionInput.value.trim();
        if (!description) {
            alert('Por favor, preencha a descrição da atividade.');
            if (descriptionInput.focus) descriptionInput.focus();
            return false;
        }
        
        var container = document.getElementById('worklog-formset-container');
        if (!container) {
            console.error('Container worklog-formset-container não encontrado');
            alert('Erro: seção de atividades não encontrada. Abra a seção "Atividades Executadas" e tente novamente.');
            return false;
        }
        
        var workLogPrefix = 'work_logs';
        var totalForms = document.querySelector('input[name="' + workLogPrefix + '-TOTAL_FORMS"]') ||
                         document.getElementById('id_' + workLogPrefix + '-TOTAL_FORMS');
        
        if (!totalForms) {
            var existingForms = container.querySelectorAll('.activity-item').length;
            var hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = workLogPrefix + '-TOTAL_FORMS';
            hiddenInput.id = 'id_' + workLogPrefix + '-TOTAL_FORMS';
            hiddenInput.value = String(existingForms);
            if (container.parentNode) {
                container.parentNode.insertBefore(hiddenInput, container);
            }
            totalForms = hiddenInput;
        }
        
        var formNum = parseInt(totalForms.value, 10) || container.querySelectorAll('.activity-item').length || 0;
        
        var percentageEl = document.getElementById('activity-percentage');
        var percentage = percentageEl ? (percentageEl.value || '').trim() : '';
        var workStageSelect = document.getElementById('activity-work-stage');
        var workStage = workStageSelect ? (workStageSelect.value || 'AN') : 'AN';
        var workStageLabels = { 'IN': 'Iniciada', 'AN': 'Em andamento', 'TE': 'Finalizada' };
        var workStageLabel = workStageLabels[workStage] || workStage;
        
        var newItem = document.createElement('div');
        newItem.className = 'activity-item border border-slate-200 rounded-lg p-4 bg-slate-50 hover:bg-slate-100 transition-colors';
        newItem.setAttribute('data-form-index', String(formNum));
        
        var infoHtml = '';
        if (percentage) {
            infoHtml += '<span class="flex items-center"><i class="fas fa-percentage mr-1"></i>' + percentage + '%</span>';
        }
        infoHtml += '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">' + workStageLabel + '</span>';
        
        var descEscaped = description.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        newItem.innerHTML = '<div class="flex items-start justify-between">' +
            '<div class="flex-1">' +
            '<div class="flex items-center gap-3 mb-2">' +
            '<h4 class="text-sm font-semibold text-slate-900">' + (description.length > 50 ? description.substring(0, 50) + '...' : description) + '</h4>' +
            '</div>' +
            (infoHtml ? '<div class="flex items-center gap-4 text-xs text-slate-600">' + infoHtml + '</div>' : '') +
            '</div>' +
            '<div class="flex items-center space-x-2 ml-4">' +
            '<button type="button" onclick="editActivity(' + formNum + ')" class="p-2 text-slate-600 hover:bg-slate-200 rounded-md transition-colors" aria-label="Editar atividade" title="Editar"><i class="fas fa-edit text-sm" aria-hidden="true"></i></button>' +
            '<button type="button" onclick="removeActivity(' + formNum + ')" class="p-2 text-red-600 hover:bg-red-50 rounded-md transition-colors" aria-label="Remover atividade" title="Remover"><i class="fas fa-trash text-sm" aria-hidden="true"></i></button>' +
            '</div>' +
            '</div>' +
            '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-id" value="">' +
            '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-activity_description" value="' + descEscaped + '">' +
            '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-location" value="">' +
            '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-work_stage" value="' + workStage + '">' +
            '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-percentage_executed_today" value="' + percentage + '">' +
            '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-accumulated_progress_snapshot" value="">' +
            '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-quantity_done" value="">' +
            '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-unit" value="">' +
            '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-start_time" value="">' +
            '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-end_time" value="">' +
            '<input type="hidden" name="' + workLogPrefix + '-' + formNum + '-notes" value="">';
        
        container.appendChild(newItem);
        totalForms.value = String(formNum + 1);
        
        // activity-form é um div, não um <form>, então limpamos os campos manualmente
        if (descriptionInput) descriptionInput.value = '';
        if (percentageEl) percentageEl.value = '';
        if (workStageSelect) workStageSelect.value = 'AN';
        var moreOptions = document.getElementById('activity-more-options');
        if (moreOptions) moreOptions.classList.add('hidden');
        var showMoreCheckbox = document.getElementById('activity-show-more');
        if (showMoreCheckbox) showMoreCheckbox.checked = false;
        
        closeActivityModal();
        if (typeof updateActivityCount === 'function') updateActivityCount();
        return false;
    } catch (err) {
        console.error('saveActivity erro:', err);
        alert('Ocorreu um erro ao salvar a atividade. Verifique o console (F12) e tente novamente.');
        return false;
    }
}

function editActivity(index) {
    // TODO: Implementar edição de atividade
    var item = document.querySelector('.activity-item[data-form-index="' + index + '"]');
    if (item) {
        // Por enquanto, apenas remove e permite recriar
        alert('Funcionalidade de edição será implementada em breve. Por favor, remova e adicione novamente.');
    }
}

// removeActivity está definido no topo do script (escopo global)

function toggleActivityMoreOptions() {
    var checkbox = document.getElementById('activity-show-more');
    var moreOptions = document.getElementById('activity-more-options');
    if (checkbox && moreOptions) {
        if (checkbox.checked) {
            moreOptions.classList.remove('hidden');
        } else {
            moreOptions.classList.add('hidden');
        }
    }
}

function calculateActivityHours() {
    var startTime = document.getElementById('activity-start-time').value;
    var endTime = document.getElementById('activity-end-time').value;
    var totalHours = document.getElementById('activity-total-hours');
    
    if (startTime && endTime && totalHours) {
        calculateTotalHours(
            document.getElementById('activity-start-time'),
            document.getElementById('activity-end-time'),
            totalHours
        );
    }
}

function updateActivityCount() {
    var forms = document.querySelectorAll('.activity-item:not([style*="display: none"])');
    var count = forms.length;
    var display = document.getElementById('activities-count-display');
    if (display) {
        display.textContent = count;
    }
    updateActivitiesEmptyState(count);
}

function updateActivitiesEmptyState(visibleCount) {
    var emptyEl = document.getElementById('activities-empty-message');
    if (!emptyEl) return;
    if (typeof visibleCount !== 'number') {
        var items = document.querySelectorAll('.activity-item:not([style*="display: none"])');
        visibleCount = items.length;
    }
    if (visibleCount > 0) {
        emptyEl.classList.add('hidden');
        emptyEl.style.display = 'none';
        emptyEl.setAttribute('aria-hidden', 'true');
    } else {
        emptyEl.classList.remove('hidden');
        emptyEl.style.display = '';
        emptyEl.setAttribute('aria-hidden', 'false');
    }
}

// Torna as funções globalmente acessíveis
window.saveActivity = saveActivity;
window.editActivity = editActivity;
window.removeActivity = removeActivity;
window.toggleActivityMoreOptions = toggleActivityMoreOptions;
window.calculateActivityHours = calculateActivityHours;
window.updateActivityCount = updateActivityCount;
window.updateActivitiesEmptyState = updateActivitiesEmptyState;

// Ao carregar, sincroniza a mensagem "nenhuma atividade" com a quantidade real de itens
document.addEventListener('DOMContentLoaded', function() {
    if (typeof updateActivitiesEmptyState === 'function') updateActivitiesEmptyState();
});

// Funções para gerenciar Vídeos com múltiplas seleções
function handleMultipleVideos(input) {
    if (!input || !input.files || input.files.length === 0) {
        console.log('Nenhum arquivo selecionado');
        return;
    }
    
    var previewGrid = document.getElementById('videos-preview-grid');
    var emptyState = document.getElementById('videos-empty-state');
    
    if (!previewGrid) {
        console.error('Grid de preview não encontrado');
        return;
    }
    
    // Esconde estado vazio
    if (emptyState) {
        emptyState.style.display = 'none';
    }
    
    console.log('Processando', input.files.length, 'vídeo(s)');
    
    // Processa cada vídeo selecionado
    for (var i = 0; i < input.files.length; i++) {
        (function(file, index) {
            var videoNum = previewGrid.querySelectorAll('.video-item').length;
            var videoName = 'video_new_' + videoNum;
            var captionName = 'video_caption_new_' + videoNum;
            
            // Cria card de preview (legenda visível em cada card)
            var videoCard = document.createElement('div');
            videoCard.className = 'video-item group relative border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm hover:shadow-md transition-all';
            videoCard.setAttribute('data-video-index', videoNum);
            
            videoCard.innerHTML = '<div class="video-item__media aspect-video bg-slate-100">' +
                '<video controls class="w-full h-full object-cover" src="" style="display: none;"></video>' +
                '<div class="absolute inset-0 flex items-center justify-center bg-slate-200 video-loading-spinner">' +
                '<i class="fas fa-spinner fa-spin text-slate-400 text-lg"></i>' +
                '</div>' +
                '<div class="video-item__remove">' +
                '<button type="button" onclick="removeVideoItem(this)" class="bg-red-600 text-white w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-700 transition-all shadow border border-white" aria-label="Remover vídeo" title="Remover vídeo">' +
                '<i class="fas fa-trash text-xs" aria-hidden="true"></i>' +
                '</button>' +
                '</div>' +
                '</div>' +
                '<div class="video-item__caption p-2 border-t border-slate-100">' +
                '<label class="block text-xs font-medium text-slate-700 mb-1">Legenda <span class="text-red-500">*</span></label>' +
                '<input type="text" name="' + captionName + '" value="" placeholder="Legenda deste vídeo" required class="w-full px-2 py-1.5 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none" aria-label="Legenda do vídeo">' +
                '</div>' +
                '<input type="file" name="' + videoName + '" class="hidden-field" accept="video/*" data-file-index="' + videoNum + '" aria-label="Upload de vídeo">';
            
            // Tenta atribuir o arquivo ao input file
            var fileInput = videoCard.querySelector('input[type="file"]');
            if (fileInput && typeof DataTransfer !== 'undefined') {
                try {
                    var dt = new DataTransfer();
                    dt.items.add(file);
                    fileInput.files = dt.files;
                } catch(e) {
                    console.log('DataTransfer não suportado para vídeos');
                }
            }
            
            previewGrid.appendChild(videoCard);
            console.log('Preview de vídeo adicionado ao grid');
            
            // Usa blob URL para vídeo (mais eficiente que data URL para arquivos grandes)
            // O CSP já permite blob: em media-src
            var videoElement = videoCard.querySelector('video');
            var spinner = videoCard.querySelector('.video-loading-spinner');
            if (videoElement) {
                try {
                    var videoURL = URL.createObjectURL(file);
                    videoElement.src = videoURL;
                    videoElement.style.display = 'block';
                    if (spinner) {
                        spinner.style.display = 'none';
                    }
                    // Limpa a URL quando o vídeo for removido
                    videoElement.addEventListener('load', function() {
                        // URL será liberada quando o elemento for removido
                    });
                } catch(e) {
                    console.error('Erro ao criar preview do vídeo:', e);
                    if (spinner) {
                        spinner.innerHTML = '<i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>';
                    }
                }
            }
            
        })(input.files[i], i);
    }
    
    // Atualiza contador e esconde estado vazio após processar todos os vídeos
    setTimeout(function() {
        // Garante que o grid está visível
        if (previewGrid) {
            previewGrid.style.display = 'grid';
        }
        
        // Esconde estado vazio se houver vídeos
        var videoItems = previewGrid ? previewGrid.querySelectorAll('.video-item:not([style*="display: none"])') : [];
        if (videoItems.length > 0 && emptyState) {
            emptyState.style.display = 'none';
        }
        
    updateVideoCount();
    }, 50);
    
    // Limpa o input para permitir adicionar mais vídeos
    input.value = '';
}

function removeVideoItem(button) {
    var videoCard = button.closest('.video-item');
    if (!videoCard) return;
    
    // Libera a blob URL se existir
    var videoElement = videoCard.querySelector('video');
    if (videoElement && videoElement.src && videoElement.src.startsWith('blob:')) {
        URL.revokeObjectURL(videoElement.src);
    }
    
    var videoId = videoCard.getAttribute('data-video-id');
    if (videoId) {
        // Se é um vídeo existente, marca para deletar
        var deleteInput = document.createElement('input');
        deleteInput.type = 'hidden';
        deleteInput.name = 'video_delete_' + videoId;
        deleteInput.value = 'on';
        videoCard.appendChild(deleteInput);
        videoCard.style.display = 'none';
    } else {
        // Se é um vídeo novo, apenas remove
        videoCard.remove();
    }
    
    // Verifica se ainda há vídeos
    var previewGrid = document.getElementById('videos-preview-grid');
    var emptyState = document.getElementById('videos-empty-state');
    if (previewGrid && previewGrid.querySelectorAll('.video-item:not([style*="display: none"])').length === 0 && emptyState) {
        emptyState.style.display = 'block';
    }
    
    updateVideoCount();
}

// Função para atualizar legendas nos cards de vídeo (input visível em cada card)
function updateAllVideoCaptions(captionValue) {
    var videoCards = document.querySelectorAll('.video-item');
    for (var i = 0; i < videoCards.length; i++) {
        var captionInput = videoCards[i].querySelector('input[name*="caption"]');
        if (captionInput) {
            captionInput.value = captionValue || '';
        }
    }
}

function updateVideoCount() {
    var previewGrid = document.getElementById('videos-preview-grid');
    var count = previewGrid ? previewGrid.querySelectorAll('.video-item:not([style*="display: none"])').length : 0;
    var display = document.getElementById('videos-count-display');
    if (display) display.textContent = count;
}

// Torna as funções globalmente acessíveis
window.handleMultipleVideos = handleMultipleVideos;
window.removeVideoItem = removeVideoItem;
window.updateAllVideoCaptions = updateAllVideoCaptions;

// Funções para gerenciar Anexos
function addAttachmentRow() {
    var container = document.getElementById('attachment-formset-container');
    if (!container) return;
    
    // Remove estado vazio se existir
    var emptyState = container.querySelector('.text-center');
    if (emptyState && emptyState.classList.contains('py-12')) {
        emptyState.remove();
    }
    
    var attachmentNum = container.querySelectorAll('.attachment-item').length;
    var newAttachment = document.createElement('div');
    newAttachment.className = 'attachment-item border border-slate-200 rounded-lg p-4 bg-white hover:bg-slate-50 transition-colors shadow-sm';
    var attachName = 'attachment_new_' + attachmentNum;
    var attachFileName = 'attachment_name_new_' + attachmentNum;
    var attachFileId = 'attachment_file_' + attachmentNum;
    var attachFileNameId = 'attachment_name_' + attachmentNum;
    newAttachment.innerHTML = '<div class="flex items-start gap-4">' +
        '<div class="flex-1 space-y-4">' +
        '<div>' +
        '<label class="block text-xs font-semibold text-slate-700 mb-1.5 uppercase tracking-wide" for="' + attachFileId + '">' +
        '<i class="fas fa-file mr-1.5 text-slate-500"></i>Arquivo' +
        '</label>' +
        '<input type="file" name="' + attachName + '" id="' + attachFileId + '" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt" class="w-full px-3 py-2.5 border border-slate-300 rounded-lg text-sm text-slate-700 focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none transition-all file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200" aria-label="Selecione um arquivo" title="Selecione um arquivo para anexar">' +
        '</div>' +
        '<div>' +
        '<label class="block text-xs font-semibold text-slate-700 mb-1.5 uppercase tracking-wide" for="' + attachFileNameId + '">' +
        '<i class="fas fa-tag mr-1.5 text-slate-500"></i>Nome do Arquivo' +
        '</label>' +
        '<input type="text" name="' + attachFileName + '" id="' + attachFileNameId + '" class="w-full px-3 py-2.5 border border-slate-300 rounded-lg text-sm text-slate-900 focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none transition-all" placeholder="Ex: Relatório de inspeção, Laudo técnico..." aria-label="Nome do arquivo" title="Digite o nome do arquivo">' +
        '</div>' +
        '</div>' +
        '<button type="button" onclick="removeAttachmentItem(this)" class="mt-6 p-2.5 text-red-600 hover:bg-red-50 rounded-lg transition-colors flex-shrink-0" title="Remover anexo" aria-label="Remover anexo">' +
        '<i class="fas fa-trash text-base"></i>' +
        '</button>' +
        '</div>';
    container.appendChild(newAttachment);
    updateAttachmentCount();
}

function removeAttachmentItem(button) {
    var item = button.closest('.attachment-item');
    if (item) {
        item.remove();
        updateAttachmentCount();
        
        // Mostra estado vazio se não houver mais anexos
        var container = document.getElementById('attachment-formset-container');
        if (container && container.querySelectorAll('.attachment-item').length === 0) {
            container.innerHTML = '<div class="text-center py-12 bg-slate-50 rounded-lg border border-slate-200">' +
                '<div class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">' +
                '<i class="fas fa-paperclip text-slate-400 text-2xl"></i>' +
                '</div>' +
                '<p class="text-sm text-slate-500">Nenhum anexo adicionado ainda</p>' +
                '<p class="text-xs text-slate-400 mt-1">Clique em "Adicionar Anexo" para começar</p>' +
                '</div>';
        }
    }
}

// Torna as funções de anexos globalmente acessíveis
window.addAttachmentRow = addAttachmentRow;
window.removeAttachmentItem = removeAttachmentItem;

function updateAttachmentCount() {
    var container = document.getElementById('attachment-formset-container');
    var count = container ? container.querySelectorAll('.attachment-item').length : 0;
    var display = document.getElementById('attachments-count-display');
    if (display) display.textContent = count;
}

// Funções para gerenciar Assinaturas
var signatureContexts = {};

function initSignatureCanvas(canvasId) {
    var canvas = document.getElementById('signature-canvas-' + canvasId);
    if (!canvas) return;
    
    var ctx = canvas.getContext('2d');
    var isDrawing = false;
    var lastX = 0;
    var lastY = 0;
    
    // Ajusta tamanho do canvas de forma responsiva
    function resizeCanvas() {
        var rect = canvas.getBoundingClientRect();
        if (rect.width === 0 || rect.height === 0) {
            // Canvas ainda não está visível, tenta novamente em breve
            setTimeout(resizeCanvas, 100);
            return;
        }
        var dpr = window.devicePixelRatio || 1;
        var width = rect.width;
        var height = 150; // Altura fixa
        
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        ctx.scale(dpr, dpr);
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        
        // Reconfigura o contexto após resize
        ctx.strokeStyle = '#1e293b';
        ctx.lineWidth = 2.5;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
    }
    
    // Tenta inicializar imediatamente
    resizeCanvas();
    
    // Reajusta ao redimensionar a janela
    window.addEventListener('resize', resizeCanvas);
    
    // Reajusta quando a seção for expandida (observa mudanças de visibilidade)
    var observer = new MutationObserver(function(mutations) {
        var content = document.getElementById('section-assinaturas-content');
        if (content && content.style.display !== 'none') {
            setTimeout(resizeCanvas, 50);
        }
    });
    
    var content = document.getElementById('section-assinaturas-content');
    if (content) {
        observer.observe(content, { attributes: true, attributeFilter: ['style'] });
    }
    
    // Configura estilo do desenho
    ctx.strokeStyle = '#1e293b';
    ctx.lineWidth = 2.5;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    // Eventos de mouse
    canvas.addEventListener('mousedown', function(e) {
        e.preventDefault();
        isDrawing = true;
        var rect = canvas.getBoundingClientRect();
        var dpr = window.devicePixelRatio || 1;
        lastX = (e.clientX - rect.left) * dpr;
        lastY = (e.clientY - rect.top) * dpr;
    });
    
    canvas.addEventListener('mousemove', function(e) {
        if (!isDrawing) return;
        e.preventDefault();
        var rect = canvas.getBoundingClientRect();
        var dpr = window.devicePixelRatio || 1;
        var x = (e.clientX - rect.left) * dpr;
        var y = (e.clientY - rect.top) * dpr;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        
        lastX = x;
        lastY = y;
    });
    
    canvas.addEventListener('mouseup', function() {
        isDrawing = false;
        saveSignature(canvasId);
    });
    
    canvas.addEventListener('mouseout', function() {
        isDrawing = false;
    });
    
    // Eventos de touch (mobile)
    canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        isDrawing = true;
        var rect = canvas.getBoundingClientRect();
        var dpr = window.devicePixelRatio || 1;
        var touch = e.touches[0];
        lastX = (touch.clientX - rect.left) * dpr;
        lastY = (touch.clientY - rect.top) * dpr;
    });
    
    canvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        if (!isDrawing) return;
        var rect = canvas.getBoundingClientRect();
        var dpr = window.devicePixelRatio || 1;
        var touch = e.touches[0];
        var x = (touch.clientX - rect.left) * dpr;
        var y = (touch.clientY - rect.top) * dpr;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        
        lastX = x;
        lastY = y;
    });
    
    canvas.addEventListener('touchend', function() {
        isDrawing = false;
        saveSignature(canvasId);
    });
}

// Função global para limpar assinatura
window.clearSignature = function(canvasId) {
    var canvas = document.getElementById('signature-canvas-' + canvasId);
    if (!canvas) {
        console.error('Canvas de assinatura não encontrado:', 'signature-canvas-' + canvasId);
        return false;
    }
    
    var ctx = canvas.getContext('2d');
    if (!ctx) {
        console.error('Contexto do canvas não encontrado');
        return false;
    }
    
    // Salva dimensões e transformação
    var rect = canvas.getBoundingClientRect();
    var dpr = window.devicePixelRatio || 1;
    var width = rect.width;
    var height = 150;
    
    // Reseta o canvas completamente (isso limpa tudo incluindo transformações)
    canvas.width = width * dpr;
    canvas.height = height * dpr;
    
    // Reconfigura o contexto após reset
    ctx.scale(dpr, dpr);
    ctx.strokeStyle = '#1e293b';
    ctx.lineWidth = 2.5;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.fillStyle = '#ffffff';
    
    // Preenche com branco
    ctx.fillRect(0, 0, width, height);
    
    // Limpa o campo hidden
    var dataInput = document.getElementById('signature-data-' + canvasId);
    if (dataInput) {
        dataInput.value = '';
    }
    
    return false; // Previne qualquer comportamento padrão
}

function saveSignature(canvasId) {
    try {
        var canvas = document.getElementById('signature-canvas-' + canvasId);
        if (!canvas) return;
        var ctx = canvas.getContext('2d');
        if (!ctx || canvas.width === 0 || canvas.height === 0) return;
        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        var hasContent = false;
        for (var i = 3; i < imageData.data.length; i += 4) {
            if (imageData.data[i] > 0) {
                hasContent = true;
                break;
            }
        }
        var dataInput = document.getElementById('signature-data-' + canvasId);
        if (dataInput) {
            dataInput.value = hasContent ? canvas.toDataURL('image/png') : '';
        }
    } catch (err) {
        console.warn('saveSignature:', err);
        var dataInput = document.getElementById('signature-data-' + canvasId);
        if (dataInput) dataInput.value = '';
    }
}

    // Remove IDs duplicados dos campos ocultos do formset de imagens
    // (IDs já são removidos no script acima, mas mantemos este como backup)
    setTimeout(function() {
        // Busca campos de imagem pelo name attribute em vez de ID (já que removemos IDs duplicados)
        var hiddenImageFields = document.querySelectorAll('#image-formset-container input[name^="diaryimage_set-"], #image-formset-container select[name^="diaryimage_set-"], #image-formset-container textarea[name^="diaryimage_set-"]');
        for (var i = 0; i < hiddenImageFields.length; i++) {
            var field = hiddenImageFields[i];
            // Remove ID para evitar duplicação
            if (field.id) {
                field.removeAttribute('id');
            }
        }
    }, 100);

    // Inicializa contadores e estados ao carregar (dentro do mesmo DOMContentLoaded)
    updateClimaCount();
    updatePhotoCount();
    renderLaborList();
    updateLaborTotals();
    updateEquipmentCount();
    updateVideoCount();
    updateAttachmentCount();
    if (typeof updateOccurrenceCount === 'function') updateOccurrenceCount();
    if (typeof updateActivityCount === 'function') updateActivityCount();
    
    // Event listeners para tags de ocorrências
    var tagCheckboxes = document.querySelectorAll('input[name="occurrence-tags"]');
    for (var i = 0; i < tagCheckboxes.length; i++) {
        tagCheckboxes[i].addEventListener('change', updateSelectedTagsPreview);
    }
    
    // Atualiza contador de clima quando checkboxes mudarem
    const climaCheckboxes = ['weather_morning_enabled', 'weather_afternoon_enabled'];
    climaCheckboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
            checkbox.addEventListener('change', updateClimaCount);
        }
    });
    
    // Inicializa canvas de assinaturas quando a seção for expandida
    function initSignaturesWhenVisible() {
        var sectionContent = document.getElementById('section-assinaturas-content');
        if (sectionContent && sectionContent.style.display !== 'none') {
            // Seção já está visível, inicializa imediatamente
            setTimeout(function() {
                initSignatureCanvas(1);
            }, 100);
        } else {
            // Observa quando a seção for expandida
            var observer = new MutationObserver(function(mutations) {
                var sectionContent = document.getElementById('section-assinaturas-content');
                if (sectionContent && sectionContent.style.display !== 'none') {
                    setTimeout(function() {
                        initSignatureCanvas(1);
                    }, 200);
                    observer.disconnect(); // Para de observar após inicializar
                }
            });
            
            var sectionContent = document.getElementById('section-assinaturas-content');
            if (sectionContent) {
                observer.observe(sectionContent, { attributes: true, attributeFilter: ['style'] });
            }
            
            // Também tenta inicializar imediatamente (caso já esteja visível)
            setTimeout(function() {
                var sectionContent = document.getElementById('section-assinaturas-content');
                if (sectionContent && sectionContent.style.display !== 'none') {
                    initSignatureCanvas(1);
                }
            }, 500);
        }
    }
    
    initSignaturesWhenVisible();
    
    // Gerencia o atributo required do campo labor-role baseado na visibilidade do modal
    var laborRoleField = document.getElementById('labor-role');
    var laborModal = document.getElementById('modal-add-labor');
    if (laborRoleField && laborModal) {
        // Remove required quando o modal está oculto
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    var isHidden = laborModal.classList.contains('hidden');
                    if (isHidden) {
                        laborRoleField.removeAttribute('required');
                    } else {
                        // Restaura required quando o modal está visível
                        if (laborRoleField.getAttribute('data-required') === 'true') {
                            laborRoleField.setAttribute('required', 'required');
                        }
                    }
                }
            });
        });
        observer.observe(laborModal, { attributes: true, attributeFilter: ['class'] });
        
        // Inicializa: remove required se o modal estiver oculto
        if (laborModal.classList.contains('hidden')) {
            laborRoleField.removeAttribute('required');
        }
    }
    
    // Remove required de todos os campos dentro de modais ocultos antes da validação
    function removeRequiredFromHiddenFields() {
        var modals = document.querySelectorAll('[id^="modal-"]');
        modals.forEach(function(modal) {
            if (modal.classList.contains('hidden')) {
                var requiredFields = modal.querySelectorAll('[required]');
                requiredFields.forEach(function(field) {
                    field.setAttribute('data-was-required', 'true');
                    field.removeAttribute('required');
                });
            }
        });
    }
    
    // Restaura required após a validação
    function restoreRequiredFromHiddenFields() {
        var fields = document.querySelectorAll('[data-was-required="true"]');
        fields.forEach(function(field) {
            field.removeAttribute('data-was-required');
            if (field.getAttribute('data-required') === 'true') {
                field.setAttribute('required', 'required');
            }
        });
    }
    
    // Garante que o campo data está em yyyy-MM-dd (exigido por type="date" e pelo backend)
    function normalizeDateInputForSubmit() {
        var dateInput = document.getElementById('id_date');
        if (!dateInput || !dateInput.value) return;
        var v = dateInput.value.trim();
        // Já está em yyyy-MM-dd
        if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return;
        // Converte dd/mm/yyyy ou dd-mm-yyyy para yyyy-MM-dd
        var parts = v.split(/[\/\-]/);
        if (parts.length === 3) {
            var day = parts[0].replace(/^0/, '') || '1';
            var month = parts[1].replace(/^0/, '') || '1';
            var year = parts[2];
            if (day.length === 1) day = '0' + day;
            if (month.length === 1) month = '0' + month;
            if (year.length === 2) year = (parseInt(year, 10) < 50 ? '20' : '19') + year;
            dateInput.value = year + '-' + month + '-' + day;
        }
    }
    
    // Constrói work_logs_json e occurrences_json. Coleta por NOMES dos inputs (work_logs-N-*, ocorrencias-N-*)
    // para não depender da estrutura DOM (.activity-item pode estar em seção recolhida ou ter classe diferente).
    function buildAndSetDiaryJsonPayload() {
        var form = document.getElementById('diary-form');
        if (!form) return;
        var workLogs = [];
        var seenIndexes = {};
        var descInputs = form.querySelectorAll('input[name^="work_logs-"][name$="-activity_description"], input[name*="work_logs-"][name*="-activity_description"]');
        for (var d = 0; d < descInputs.length; d++) {
            var name = descInputs[d].name || '';
            var match = name.match(/work_logs-(\d+)-/);
            var idx = match ? match[1] : String(d);
            if (seenIndexes[idx]) continue;
            seenIndexes[idx] = true;
            var delInput = form.querySelector('input[name="work_logs-' + idx + '-DELETE"]');
            if (delInput && (delInput.checked === true || (delInput.value || '').toString().toLowerCase() === 'on')) continue;
            var desc = (descInputs[d].value || '').trim();
            if (!desc) continue;
            var get = function(suffix) {
                var el = form.querySelector('[name="work_logs-' + idx + '-' + suffix + '"]');
                return (el && el.value !== undefined && el.value !== null) ? String(el.value).trim() : '';
            };
            workLogs.push({
                activity_description: desc,
                work_stage: get('work_stage') || 'AN',
                percentage_executed_today: get('percentage_executed_today') || '0',
                accumulated_progress_snapshot: get('accumulated_progress_snapshot') || '0',
                location: get('location'),
                notes: get('notes')
            });
        }
        var occurrences = [];
        seenIndexes = {};
        var occDescInputs = form.querySelectorAll('input[name^="ocorrencias-"][name$="-description"], input[name*="ocorrencias-"][name*="-description"], textarea[name^="ocorrencias-"][name$="-description"]');
        for (var o = 0; o < occDescInputs.length; o++) {
            var oname = occDescInputs[o].name || '';
            var omatch = oname.match(/ocorrencias-(\d+)-/);
            var oidx = omatch ? omatch[1] : String(o);
            if (seenIndexes[oidx]) continue;
            seenIndexes[oidx] = true;
            var occDel = form.querySelector('input[name="ocorrencias-' + oidx + '-DELETE"]');
            if (occDel && (occDel.checked === true || (occDel.value || '').toString().toLowerCase() === 'on')) continue;
            var occDesc = (occDescInputs[o].value || '').trim();
            if (!occDesc) continue;
            var tagInputs = form.querySelectorAll('input[name="ocorrencias-' + oidx + '-tags"]');
            var tagIds = [];
            for (var t = 0; t < tagInputs.length; t++) {
                if (tagInputs[t].value) tagIds.push(parseInt(tagInputs[t].value, 10));
            }
            occurrences.push({ description: occDesc, tag_ids: tagIds });
        }
        // [DIARY_DEBUG] Diagnóstico: itens coletados e payload (confirmar no Network que work_logs_json e occurrences_json estão no POST)
        var wlStr = JSON.stringify(workLogs);
        var occStr = JSON.stringify(occurrences);
        console.log('[DIARY_DEBUG] buildAndSetDiaryJsonPayload: descInputs.length=', descInputs.length, 'occDescInputs.length=', occDescInputs.length, 'workLogs.length=', workLogs.length, 'occurrences.length=', occurrences.length);
        console.log('[DIARY_DEBUG] work_logs_json length=', wlStr.length, '(500 chars):', wlStr.substring(0, 500));
        console.log('[DIARY_DEBUG] occurrences_json length=', occStr.length, '(300 chars):', occStr.substring(0, 300));
        var wlInput = document.getElementById('work_logs_json_input');
        var occInput = document.getElementById('occurrences_json_input');
        if (!wlInput && form) {
            wlInput = document.createElement('input');
            wlInput.type = 'hidden';
            wlInput.name = 'work_logs_json';
            wlInput.id = 'work_logs_json_input';
            form.insertBefore(wlInput, form.firstChild);
        }
        if (!occInput && form) {
            occInput = document.createElement('input');
            occInput.type = 'hidden';
            occInput.name = 'occurrences_json';
            occInput.id = 'occurrences_json_input';
            form.insertBefore(occInput, form.firstChild);
        }
        if (wlInput) wlInput.value = wlStr;
        if (occInput) occInput.value = occStr;
        var wlTotal = document.querySelector('input[name="work_logs-TOTAL_FORMS"]');
        if (wlTotal) wlTotal.value = String(descInputs.length);
        var occTotal = document.querySelector('input[name="ocorrencias-TOTAL_FORMS"]');
        if (occTotal) occTotal.value = String(occDescInputs.length);
    }
    window.buildAndSetDiaryJsonPayload = buildAndSetDiaryJsonPayload;

    // Salva assinaturas antes de submeter o formulário e adiciona validações
    var form = document.getElementById('diary-form');
    var isSubmitting = false;
    if (form) {
        form.addEventListener('submit', function(e) {
            try {
            if (isSubmitting) {
                e.preventDefault();
                return false;
            }
            // 0) Normaliza data para yyyy-MM-dd (evita erro de formato e rejeição do form)
            normalizeDateInputForSubmit();
            // 0.1) Monta e envia atividades e ocorrências como JSON (nova forma de armazenamento)
            if (typeof buildAndSetDiaryJsonPayload === 'function') buildAndSetDiaryJsonPayload();
            // 1) Define se é salvamento parcial: flag já em 1 (clicou em "rascunho") ou submitter é o botão rascunho
            var partialSaveFlag = document.getElementById('partial_save_flag');
            var alreadyDraft = (partialSaveFlag && partialSaveFlag.value === '1');
            var isDraftButton = e.submitter && (e.submitter.id === 'save-draft-btn' || e.submitter.id === 'save-draft-btn-bottom');
            if (partialSaveFlag) {
                if (alreadyDraft || isDraftButton) partialSaveFlag.value = '1';
                else partialSaveFlag.value = ''; // Salvar Diário = sempre completo
            }
            var isPartialSave = (partialSaveFlag && partialSaveFlag.value === '1');
            
            // 2) SALVAMENTO PARCIAL: só exige data, não exige assinatura; depois envia com form.submit()
            if (isPartialSave) {
                var dateInputPartial = document.getElementById('id_date');
                if (dateInputPartial && !dateInputPartial.value) {
                    e.preventDefault();
                    alert('Por favor, preencha a data do relatório.');
                    dateInputPartial.focus();
                    dateInputPartial.classList.add('border-red-500');
                    return false;
                }
                try { if (typeof saveSignature === 'function') saveSignature(1); } catch (err) { console.warn(err); }
                try {
                    if (typeof removeRequiredFromHiddenFields === 'function') removeRequiredFromHiddenFields();
                    if (typeof window.getDiaryLaborPayload === 'function') {
                        var inp = document.getElementById('diary_labor_data');
                        if (inp) inp.value = JSON.stringify(window.getDiaryLaborPayload());
                    }
                    if (typeof window.getEquipmentPayload === 'function') {
                        var eq = document.getElementById('equipment_data');
                        if (eq) eq.value = JSON.stringify(window.getEquipmentPayload());
                    } else if (typeof equipmentList !== 'undefined' && equipmentList && equipmentList.length > 0) {
                        var eq2 = document.getElementById('equipment_data');
                        if (eq2) eq2.value = JSON.stringify(equipmentList);
                    }
                    var old = document.getElementById('labor_data');
                    if (old) old.remove();
                } catch (err) { console.warn('Serialização parcial:', err); }
                isSubmitting = true;
                var saveBtn = document.getElementById('save-diary-btn');
                var saveBtnBottom = document.getElementById('save-diary-btn-bottom');
                var draftBtn = document.getElementById('save-draft-btn');
                var draftBtnBottom = document.getElementById('save-draft-btn-bottom');
                if (saveBtn) saveBtn.disabled = true;
                if (saveBtnBottom) saveBtnBottom.disabled = true;
                if (draftBtn) draftBtn.disabled = true;
                if (draftBtnBottom) draftBtnBottom.disabled = true;
                e.preventDefault();
                setTimeout(function() { form.submit(); }, 0);
                return false;
            }
            
            try {
            // Remove required de campos em modais ocultos
            if (typeof removeRequiredFromHiddenFields === 'function') removeRequiredFromHiddenFields();
            
            // Serializa mão de obra por categorias (novo UX) em diary_labor_data
            if (typeof window.getDiaryLaborPayload === 'function') {
                var payload = window.getDiaryLaborPayload();
                var diaryLaborInput = document.getElementById('diary_labor_data');
                if (diaryLaborInput) diaryLaborInput.value = JSON.stringify(payload);
            }
            
            // Serializa equipamentos (novo UX: por categorias + outros)
            if (typeof window.getEquipmentPayload === 'function') {
                var equipmentPayload = window.getEquipmentPayload();
                var equipmentInput = document.getElementById('equipment_data');
                if (equipmentInput) equipmentInput.value = JSON.stringify(equipmentPayload);
            } else if (typeof equipmentList !== 'undefined' && equipmentList && equipmentList.length > 0) {
                var equipmentInput = document.getElementById('equipment_data');
                if (equipmentInput) equipmentInput.value = JSON.stringify(equipmentList);
            }
            
            var oldLaborData = document.getElementById('labor_data');
            if (oldLaborData) oldLaborData.remove();
            
            // Validação básica: data obrigatória
            var dateInput = document.getElementById('id_date');
            if (dateInput && !dateInput.value) {
                e.preventDefault();
                if (typeof restoreRequiredFromHiddenFields === 'function') restoreRequiredFromHiddenFields();
                alert('Por favor, preencha a data do relatório.');
                dateInput.focus();
                dateInput.classList.add('border-red-500');
                return false;
            }
            
            // Valida e garante que os arquivos de imagem estão corretos
            var imageForms = document.querySelectorAll('.image-form-row');
            var totalFormsInput = document.getElementById('id_diaryimage_set-TOTAL_FORMS');
            if (totalFormsInput) {
                var totalForms = parseInt(totalFormsInput.value) || 0;
                var validForms = 0;
                
                for (var i = 0; i < imageForms.length; i++) {
                    var formRow = imageForms[i];
                    var deleteInput = formRow.querySelector('input[name$="-DELETE"]');
                    if (deleteInput && deleteInput.value === 'on') {
                        continue; // Form marcado para deletar, pula
                    }
                    
                    var fileInput = formRow.querySelector('input[type="file"]');
                    var captionInput = formRow.querySelector('input[name$="-caption"]');
                    
                    // Verifica se tem arquivo ou se é um form existente (com ID)
                    var idInput = formRow.querySelector('input[name$="-id"]');
                    var hasId = idInput && idInput.value && idInput.value !== '';
                    
                    if (fileInput) {
                        // Verifica se tem arquivo ou se é um form existente (com ID)
                        if (fileInput.files.length > 0 || hasId) {
                            validForms++;
                            // Garante que a legenda está preenchida se for novo form (legenda obrigatória)
                            if (!hasId && captionInput && !captionInput.value.trim()) {
                                var globalCaption = document.getElementById('photos-caption-global');
                                if (globalCaption && globalCaption.value.trim()) {
                                    captionInput.value = globalCaption.value.trim();
                                }
                                // Se continuar vazio, o backend validará e exibirá erro "A legenda é obrigatória"
                            }
                            
                            // Log para debug
                            if (fileInput.files.length > 0) {
                                console.log('Form válido:', i, 'Arquivo:', fileInput.files[0].name, 'Tamanho:', fileInput.files[0].size);
                            } else if (hasId) {
                                console.log('Form válido (existente):', i, 'ID:', idInput.value);
                            }
                        } else {
                            console.warn('Form inválido (sem arquivo e sem ID):', i);
                        }
                    } else {
                        console.warn('Form sem input de arquivo:', i);
                    }
                }
                
                // Atualiza TOTAL_FORMS para refletir apenas os forms válidos
                // IMPORTANTE: Não altera o totalForms aqui, pois pode quebrar o formset
                // O Django espera que TOTAL_FORMS seja igual ao número de forms no DOM
                console.log('Validação de imagens - Total de forms:', totalForms, 'Forms válidos:', validForms);
                
                // Se houver forms inválidos, mostra aviso mas não impede o envio
                // (o Django vai validar no servidor)
                if (validForms < imageForms.length) {
                    console.warn('Alguns forms de imagem podem estar inválidos. O servidor irá validar.');
                }
            }
            
            // Restaura required após validação bem-sucedida
            if (typeof restoreRequiredFromHiddenFields === 'function') restoreRequiredFromHiddenFields();
            
            // Salva assinatura (responsável pelo preenchimento)
            if (typeof saveSignature === 'function') saveSignature(1);
            
            // Em Salvamento Parcial a assinatura não é obrigatória
            var isPartialSave = document.getElementById('partial_save_flag') && document.getElementById('partial_save_flag').value === '1';
            
            // Valida assinatura obrigatória (exceto em Salvamento Parcial)
            var signatureData = document.getElementById('signature-data-1');
            if (!isPartialSave && (!signatureData || !signatureData.value || signatureData.value.trim() === '')) {
                e.preventDefault();
                if (typeof restoreRequiredFromHiddenFields === 'function') restoreRequiredFromHiddenFields();
                alert('A assinatura do responsável pelo preenchimento é obrigatória. Por favor, assine na seção Assinaturas.');
                var sectionBtn = document.querySelector('#section-assinaturas .section-toggle');
                var sectionContent = document.getElementById('section-assinaturas-content');
                if (sectionBtn && sectionContent) {
                    sectionBtn.classList.remove('section-collapsed');
                    sectionBtn.classList.add('section-expanded');
                    sectionBtn.setAttribute('aria-expanded', 'true');
                    sectionContent.classList.remove('section-collapsed');
                    sectionContent.classList.add('section-expanded');
                    var chevron = sectionBtn.querySelector('.section-chevron');
                    if (chevron) chevron.style.transform = 'rotate(180deg)';
                    sectionContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                return false;
            }
            
            // Atualiza botões de salvar (topo e rodapé)
            var saveBtn = document.getElementById('save-diary-btn');
            var saveIcon = document.getElementById('save-icon');
            var saveText = document.getElementById('save-text');
            var saveSpinner = document.getElementById('save-spinner');
            
            var saveBtnBottom = document.getElementById('save-diary-btn-bottom');
            var saveIconBottom = document.getElementById('save-icon-bottom');
            var saveTextBottom = document.getElementById('save-text-bottom');
            var saveSpinnerBottom = document.getElementById('save-spinner-bottom');
            
            if (saveBtn && saveIcon && saveText && saveSpinner) {
                isSubmitting = true;
                saveBtn.disabled = true;
                saveIcon.classList.add('hidden');
                saveText.textContent = 'Salvando...';
                saveSpinner.classList.remove('hidden');
            }
            
            if (saveBtnBottom && saveIconBottom && saveTextBottom && saveSpinnerBottom) {
                saveBtnBottom.disabled = true;
                saveIconBottom.classList.add('hidden');
                saveTextBottom.textContent = 'Salvando...';
                saveSpinnerBottom.classList.remove('hidden');
            }
            
            // Garante que equipamentos (e quantidades) são enviados: atualiza equipment_data no último momento
            if (typeof window.getEquipmentPayload === 'function') {
                var equipmentPayload = window.getEquipmentPayload();
                console.log('[DIARY_DEBUG] equipment_data (getEquipmentPayload) no submit:', JSON.stringify(equipmentPayload));
                var equipmentInput = document.getElementById('equipment_data');
                if (equipmentInput) equipmentInput.value = JSON.stringify(equipmentPayload);
            }
            
            // Reabilita após timeout de segurança (10 segundos)
            setTimeout(function() {
                isSubmitting = false;
                if (saveBtn && saveIcon && saveText && saveSpinner) {
                    saveBtn.disabled = false;
                    saveIcon.classList.remove('hidden');
                    saveText.textContent = 'Salvar Diário';
                    saveSpinner.classList.add('hidden');
                }
                
                if (saveBtnBottom && saveIconBottom && saveTextBottom && saveSpinnerBottom) {
                    saveBtnBottom.disabled = false;
                    saveIconBottom.classList.remove('hidden');
                    saveTextBottom.textContent = 'Salvar Diário';
                    saveSpinnerBottom.classList.add('hidden');
                }
            }, 10000);
            } catch (err) {
                console.error('Erro no envio do diário:', err);
                isSubmitting = false;
                alert('Ocorreu um erro ao preparar o envio. O formulário será enviado mesmo assim para validação no servidor.');
                // Não chama preventDefault: deixa o formulário submeter
            }
            } catch (outerErr) {
                console.error('Erro no handler de submit:', outerErr);
                // Não chama preventDefault para o formulário poder submeter
            }
        });
    }
    
    // Botões "Salvar como rascunho": definem a flag e disparam o submit (para o handler tratar como parcial)
    var diaryForm = document.getElementById('diary-form');
    var partialSaveFlagInput = document.getElementById('partial_save_flag');
    function submitAsDraft() {
        if (partialSaveFlagInput) partialSaveFlagInput.value = '1';
        if (diaryForm && typeof diaryForm.requestSubmit === 'function') {
            diaryForm.requestSubmit(); // sem argumento: botão rascunho é type="button", não submit
        } else {
            diaryForm.submit();
        }
    }
    var saveDraftBtn = document.getElementById('save-draft-btn');
    var saveDraftBtnBottom = document.getElementById('save-draft-btn-bottom');
    if (saveDraftBtn) saveDraftBtn.addEventListener('click', function() { submitAsDraft(); });
    if (saveDraftBtnBottom) saveDraftBtnBottom.addEventListener('click', function() { submitAsDraft(); });
    
    // Validação de campos obrigatórios em tempo real
    var dateInput = document.getElementById('id_date');
    if (dateInput) {
        dateInput.addEventListener('blur', function() {
            if (!this.value) {
                this.classList.add('border-red-500', 'ring-2', 'ring-red-200');
            } else {
                this.classList.remove('border-red-500', 'ring-2', 'ring-red-200');
            }
        });
        
        dateInput.addEventListener('change', function() {
            this.classList.remove('border-red-500', 'ring-2', 'ring-red-200');
        });
    }
});
</script>
{% endblock %}

{% block page_modals %}
<!-- Modais renderizados no body (fora do main) para overlay correto -->
<div id="modal-add-activity"
     class="diary-modal-overlay fixed inset-0 z-[9999] flex items-center justify-center p-4 overflow-y-auto"
     onclick="if(event.target===this) closeActivityModal();"
     role="dialog"
     aria-modal="true"
     aria-hidden="true">
    <div class="diary-modal-card bg-white rounded-xl max-w-xl w-full my-auto flex flex-col" onclick="event.stopPropagation()">
        <div class="flex-shrink-0 bg-blue-50 px-6 py-4 flex items-center justify-between border-b border-blue-200">
            <h3 class="text-lg font-semibold text-slate-900 flex items-center">
                <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center mr-3">
                    <i class="fas fa-tasks text-white text-sm"></i>
                </div>
                Adicionar Atividade
            </h3>
            <button type="button"
                    onclick="closeActivityModal();"
                    class="diary-modal-close-btn p-2 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition-colors"
                    aria-label="Fechar modal de adicionar atividade"
                    title="Fechar">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="diary-modal-body p-6">
            <div id="activity-form" role="form">
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-semibold text-slate-900 mb-2">
                            Descrição <span class="text-red-500">*</span>
                        </label>
                        <textarea id="activity-description"
                                  rows="2"
                                  style="height: 4rem; max-height: 5.5rem;"
                                  class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none text-sm text-slate-900 placeholder:text-slate-400 transition-all resize-y"
                                  placeholder="Descreva a atividade executada..."></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-900 mb-2">Porcentagem (%)</label>
                            <input type="number"
                                   id="activity-percentage"
                                   step="0.01"
                                   min="0"
                                   max="100"
                                   class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none text-sm text-slate-900 transition-all"
                                   placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-900 mb-2">Status</label>
                            <select id="activity-work-stage"
                                    class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none text-sm text-slate-900 transition-all">
                                <option value="IN">Iniciada</option>
                                <option value="AN" selected>Em andamento</option>
                                <option value="TE">Finalizada</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="diary-modal-footer flex items-center justify-end gap-3 flex-shrink-0">
            <button type="button"
                    onclick="closeActivityModal();"
                    class="diary-modal-btn-cancel px-5 py-2.5 rounded-lg text-sm font-medium transition-all duration-200">
                Fechar
            </button>
            <button type="button" id="modal-activity-save-btn" onclick="return saveActivity(event);"
                    class="diary-modal-btn-save px-5 py-2.5 rounded-lg text-sm font-medium shadow hover:shadow-md transition-all duration-200 flex items-center">
                <i class="fas fa-save mr-2"></i>Salvar
            </button>
        </div>
    </div>
</div>

<div id="modal-add-occurrence"
     class="diary-modal-overlay fixed inset-0 z-[9999] flex items-center justify-center p-4 overflow-y-auto"
     onclick="if(event.target===this) closeOccurrenceModal();"
     role="dialog"
     aria-modal="true"
     aria-hidden="true"
     aria-labelledby="modal-add-occurrence-title">
    <div class="diary-modal-card bg-white rounded-xl max-w-xl w-full my-auto flex flex-col" onclick="event.stopPropagation()">
        <div class="flex-shrink-0 bg-blue-50 px-6 py-4 flex items-center justify-between border-b border-blue-200">
            <h3 id="modal-add-occurrence-title" class="text-lg font-semibold text-slate-900 flex items-center">
                <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center mr-3">
                    <i class="fas fa-exclamation-triangle text-white text-sm"></i>
                </div>
                Adicionar Ocorrência
            </h3>
            <button type="button"
                    onclick="closeOccurrenceModal();"
                    class="diary-modal-close-btn p-2 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition-colors"
                    aria-label="Fechar modal de adicionar ocorrência"
                    title="Fechar">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="diary-modal-body p-6">
            <div id="occurrence-form" role="form">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-900 mb-1.5">
                            Descrição <span class="text-red-500">*</span>
                        </label>
                        <textarea id="occurrence-description"
                                  rows="2"
                                  style="height: 3.5rem; max-height: 5rem;"
                                  class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none text-sm text-slate-900 placeholder:text-slate-400 transition-all resize-y"
                                  placeholder="Descreva a ocorrência..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-900 mb-1.5">
                            Tipos de ocorrência (tags)
                        </label>
                        <div class="border border-slate-300 rounded-lg bg-white">
                            <div class="p-2.5 border-b border-slate-200">
                                <div class="flex items-center">
                                    <i class="fas fa-search text-slate-400 mr-2 text-xs"></i>
                                    <input type="text"
                                           id="tag-search-input"
                                           aria-label="Pesquisar tags de ocorrência"
                                           placeholder="Pesquisar tags"
                                           class="flex-1 outline-none text-sm text-slate-900 placeholder:text-slate-400"
                                           onkeyup="filterTags(this.value)">
                                </div>
                            </div>
                            <div id="tags-list-container" class="overflow-y-auto p-2 border-t border-slate-100">
                                {% for tag in occurrence_tags %}
                                <label class="flex items-center hover:bg-blue-50 rounded-md cursor-pointer transition-colors tag-option" data-tag-name="{{ tag.name|lower }}">
                                    <input type="checkbox"
                                           name="occurrence-tags"
                                           value="{{ tag.id }}"
                                           aria-label="Selecionar tag {{ tag.name }}"
                                           title="{{ tag.name }}"
                                           class="w-4 h-4 text-slate-600 border-slate-300 rounded focus:ring-slate-500 cursor-pointer tag-checkbox"
                                           data-tag-color="{{ tag.color }}">
                                    <span class="ml-2 text-sm text-slate-900">{{ tag.name }}</span>
                                </label>
                                {% empty %}
                                <p class="text-sm text-slate-500 p-2">Nenhuma tag disponível</p>
                                {% endfor %}
                            </div>
                        </div>
                        <div id="selected-tags-preview" class="flex flex-wrap gap-1.5 mt-2 min-h-[1.75rem]"></div>
                        <div class="mt-3 pt-3 border-t border-slate-200">
                            <label class="block text-xs font-medium text-slate-700 mb-1.5">Outros</label>
                            <div class="flex gap-2">
                                <input type="text"
                                       id="custom-tag-input"
                                       aria-label="Digite uma nova tag personalizada"
                                       placeholder="Nova tag..."
                                       class="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none text-sm text-slate-900 placeholder:text-slate-400"
                                       onkeypress="if(event.key === 'Enter') { event.preventDefault(); addCustomTag(); }">
                                <button type="button"
                                        onclick="return addCustomTag();"
                                        class="diary-modal-btn-save px-3 py-2 rounded-lg text-sm font-medium flex items-center">
                                    <i class="fas fa-plus mr-1"></i>Adicionar
                                </button>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">Tags personalizadas que não estão na lista</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="diary-modal-footer flex items-center justify-between flex-shrink-0">
            <button type="button"
                    onclick="closeOccurrenceModal();"
                    class="diary-modal-btn-cancel px-5 py-2.5 rounded-lg text-sm font-medium transition-all duration-200">
                Fechar
            </button>
            <button type="button" onclick="saveOccurrence(event)"
                    class="diary-modal-btn-save px-5 py-2.5 rounded-lg text-sm font-medium shadow hover:shadow-md transition-all duration-200 flex items-center">
                <i class="fas fa-save mr-2"></i>Salvar
            </button>
        </div>
    </div>
</div>
{% endblock %}