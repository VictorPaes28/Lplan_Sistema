{% extends 'base.html' %}
{% load static %}
{% load core_tags %}

{% block page_title %}Detalhes do Relatório{% endblock %}
{% block page_subtitle %}Relatório Diário de Obra{% endblock %}

{% block content %}
<!-- Header com Voltar -->
<div class="mb-6 flex items-center justify-between flex-wrap gap-3">
    <div class="flex items-center min-w-0">
        <a href="{% url 'report-list' %}" 
           class="diary-detail-back-link text-slate-600 hover:text-slate-900 mr-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded-lg p-2 -ml-2 transition-colors hover:bg-slate-100"
           aria-label="Voltar para lista de relatórios"
           title="Voltar">
            <i class="fas fa-arrow-left text-lg" aria-hidden="true"></i>
        </a>
        <div class="min-w-0">
            <h1 class="text-xl font-bold text-slate-800 tracking-tight">
                Detalhes do relatório
            </h1>
            <p class="text-sm text-slate-500 mt-0.5">RDO · {{ diary.date|date:"d/m/Y" }}{% if diary.report_number %} · #{{ diary.report_number }}{% endif %}</p>
        </div>
    </div>
    <div class="flex space-x-2">
        <!-- Dropdown de Impressão -->
        <div class="relative" id="print-dropdown-container">
            <button type="button" 
                    id="print-dropdown-button"
                    class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 flex items-center transition-colors duration-200"
                    aria-expanded="false">
                <i class="fas fa-print mr-3"></i>Imprimir
                <i class="fas fa-chevron-down ml-2 text-xs transition-transform duration-200" id="print-dropdown-chevron"></i>
            </button>
            <div id="print-dropdown-menu"
                 style="display: none;"
                 class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                <div class="py-2">
                    <a href="{% url 'diary-pdf' diary.id %}" 
                       class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                        <i class="fas fa-file-pdf text-red-500 mr-3"></i>Imprimir relatório (PDF)
                    </a>
                    <a href="{% url 'diary-pdf-detailed' diary.id %}" 
                       class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                        <i class="fas fa-file-pdf text-red-500 mr-3"></i>Imprimir relatório detalhado (PDF)
                    </a>
                    <a href="{% url 'diary-pdf-no-photos' diary.id %}" 
                       class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                        <i class="fas fa-file-pdf text-red-500 mr-3"></i>Imprimir relatório sem fotos (PDF)
                    </a>
                    <div class="border-t border-gray-200 my-1"></div>
                    <a href="{% url 'diary-excel' diary.id %}" 
                       class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                        <i class="fas fa-file-excel text-green-500 mr-3"></i>Excel (xlsx)
                    </a>
                </div>
            </div>
        </div>
        {% if diary|can_edit:user %}
        <a href="{% url 'diary-edit' diary.id %}" 
           class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center transition-colors">
            <i class="fas fa-edit mr-3"></i>Editar
        </a>
        {% endif %}
    </div>
</div>

<!-- Card Principal -->
<div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-6">
    <!-- Logo e Título -->
    <div class="text-center mb-6 pb-6 border-b border-slate-200">
        <div class="flex items-center justify-center mb-6 mt-4">
            <div class="logo-white-box w-20 h-20 bg-white rounded-lg flex items-center justify-center mr-12 p-1.5 flex-shrink-0">
                <img src="{% static 'core/images/lplan-logo2.png' %}" alt="LPLAN" class="w-full h-full object-contain" style="max-width: 90%; max-height: 90%;">
            </div>
            <div class="text-left ml-10">
                <h1 class="text-3xl font-bold text-blue-900 mb-1">LPLAN</h1>
                <p class="text-sm text-gray-600">Gestão de Obras</p>
            </div>
        </div>
        <h2 class="text-xl font-bold text-slate-800 mt-2">Relatório Diário de Obra (RDO)</h2>
    </div>

    <!-- Status Badge -->
    <div class="mb-6 flex items-center justify-between">
        <span class="report-status {{ diary|report_status_css }} inline-flex items-center px-4 py-2 text-sm font-semibold rounded-full">
            <i class="fas fa-circle mr-2" style="font-size:0.4rem;vertical-align:middle"></i>{{ diary|report_status_label }}
        </span>
        <div class="text-sm text-gray-600">
            <i class="fas fa-eye mr-2"></i>{{ view_count }} visualizações
        </div>
    </div>

    <!-- Informações do Relatório -->
    <div class="mb-6">
        <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
            <i class="fas fa-info-circle text-blue-600 mr-3"></i>
            Informações do Relatório
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Relatório n°</p>
                <p class="text-lg font-bold text-slate-800">{{ diary.report_number|default:"-" }}</p>
            </div>
            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Data</p>
                <p class="text-lg font-bold text-slate-800">{{ diary.date|date:"d/m/Y" }}</p>
            </div>
            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Dia da semana</p>
                <p class="text-lg font-bold text-slate-800">{{ weekday_name }}</p>
            </div>
            {% if diary.project.contract_number %}
            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">N° do contrato</p>
                <p class="text-lg font-bold text-slate-800">{{ diary.project.contract_number }}</p>
            </div>
            {% endif %}
            {% if project_days_total > 0 %}
            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Prazo contratual</p>
                <p class="text-lg font-bold text-slate-800">{{ project_days_total }} dias</p>
            </div>
            {% endif %}
            {% if project_days_elapsed >= 0 %}
            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Prazo decorrido</p>
                <p class="text-lg font-bold text-slate-800">{{ project_days_elapsed }} dias</p>
            </div>
            {% endif %}
            {% if project_days_remaining >= 0 %}
            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Prazo a vencer</p>
                <p class="text-lg font-bold text-slate-800">{{ project_days_remaining }} dias</p>
            </div>
            {% endif %}
            {% if diary.work_hours %}
            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Horas de trabalho</p>
                <p class="text-lg font-bold text-slate-800">{{ diary.work_hours }}h</p>
            </div>
            {% endif %}
            {% if diary.pluviometric_index %}
            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Índice pluviométrico</p>
                <p class="text-lg font-bold text-slate-800">{{ diary.pluviometric_index }}mm</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Detalhes da Obra -->
    <div class="mb-6">
        <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
            <i class="fas fa-building text-blue-600 mr-3"></i>
            Informações da Obra
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Obra</p>
                <p class="text-base font-semibold text-slate-800">{{ diary.project.name }}</p>
                {% if diary.project.code %}
                <p class="text-sm text-gray-600 mt-1">{{ diary.project.code }}</p>
                {% endif %}
            </div>
            {% if diary.project.address %}
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Endereço</p>
                <p class="text-base font-semibold text-slate-800">{{ diary.project.address }}</p>
            </div>
            {% endif %}
            {% if diary.project.client_name %}
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Contratante</p>
                <p class="text-base font-semibold text-slate-800">{{ diary.project.client_name }}</p>
            </div>
            {% endif %}
            {% if diary.project.responsible %}
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Responsável</p>
                <p class="text-base font-semibold text-slate-800">{{ diary.project.responsible }}</p>
            </div>
            {% endif %}
            {% if diary.inspection_responsible %}
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Responsável pela Inspeção</p>
                <p class="text-base font-semibold text-slate-800">{{ diary.inspection_responsible }}</p>
            </div>
            {% endif %}
            {% if diary.production_responsible %}
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Responsável pela Produção</p>
                <p class="text-base font-semibold text-slate-800">{{ diary.production_responsible }}</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Clima -->
    {% if weather_morning or weather_afternoon or weather_night or diary.weather_conditions or diary.pluviometric_index or diary.rain_occurrence %}
    <div class="mb-6">
        <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
            <i class="fas fa-cloud-sun text-blue-600 mr-3"></i>
            Condições Climáticas
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% if weather_morning %}
            <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-lg p-4 border border-yellow-200">
                <p class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-sun text-yellow-500 mr-3"></i>Manhã
                </p>
                <div class="flex items-center">
                    <i class="fas fa-{{ weather_morning.icon }} text-{{ weather_morning.color }}-500 text-3xl mr-5"></i>
                    <div>
                        <p class="text-base font-semibold text-gray-900">{{ weather_morning.label }}</p>
                        <p class="text-sm text-gray-600">{{ weather_morning.condition }}</p>
                    </div>
                </div>
            </div>
            {% endif %}
            {% if weather_afternoon %}
            <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg p-4 border border-blue-200">
                <p class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-sun text-orange-500 mr-3"></i>Tarde
                </p>
                <div class="flex items-center">
                    <i class="fas fa-{{ weather_afternoon.icon }} text-{{ weather_afternoon.color }}-500 text-3xl mr-5"></i>
                    <div>
                        <p class="text-base font-semibold text-gray-900">{{ weather_afternoon.label }}</p>
                        <p class="text-sm text-gray-600">{{ weather_afternoon.condition }}</p>
                    </div>
                </div>
            </div>
            {% endif %}
            {% if weather_night %}
            <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg p-4 border border-indigo-200">
                <p class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-moon text-indigo-500 mr-3"></i>Noite
                </p>
                <div class="flex items-center">
                    <i class="fas fa-{{ weather_night.icon }} text-{{ weather_night.color }}-500 text-3xl mr-5"></i>
                    <div>
                        <p class="text-base font-semibold text-gray-900">{{ weather_night.label }}</p>
                        <p class="text-sm text-gray-600">{{ weather_night.condition }}</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Informações adicionais de clima -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            {% if diary.pluviometric_index %}
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Índice Pluviométrico</p>
                <p class="text-lg font-bold text-blue-700">{{ diary.pluviometric_index }}mm</p>
            </div>
            {% endif %}
            {% if diary.rain_occurrence %}
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Ocorrência de Chuva</p>
                <p class="text-sm font-semibold text-blue-700">{{ diary.get_rain_occurrence_display }}</p>
            </div>
            {% endif %}
            {% if diary.rain_observations %}
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Observações sobre Chuva</p>
                <p class="text-sm text-gray-700">{{ diary.rain_observations }}</p>
            </div>
            {% endif %}
        </div>
        
        {% if diary.weather_conditions and not weather_morning and not weather_afternoon and not weather_night %}
        <div class="mt-4 bg-slate-50 rounded-lg p-4 border border-slate-200">
            <p class="text-sm font-medium text-gray-700 mb-2">Descrição Geral</p>
            <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ diary.weather_conditions }}</p>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Mão de Obra -->
    <div class="mb-6">
        <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
            <i class="fas fa-users text-blue-600 mr-3"></i>
            Mão de Obra
        </h3>
        {% if labor_entries_by_category %}
        <div class="bg-white rounded-lg p-4 border border-slate-200">
            {% if labor_entries_by_category.indireta %}
            <div class="mb-4">
                <h4 class="text-sm font-semibold text-gray-700 mb-3">Mão de Obra Indireta</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    {% for item in labor_entries_by_category.indireta %}
                    <div class="bg-blue-50 rounded-lg p-3 border border-blue-200 text-center">
                        <p class="text-xs font-medium text-gray-600 mb-1">{{ item.cargo_name }}</p>
                        <p class="text-lg font-bold text-blue-700">{{ item.quantity }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% if labor_entries_by_category.direta %}
            <div class="mb-4 {% if labor_entries_by_category.indireta %}pt-4 border-t border-slate-200{% endif %}">
                <h4 class="text-sm font-semibold text-gray-700 mb-3">Mão de Obra Direta</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    {% for item in labor_entries_by_category.direta %}
                    <div class="bg-green-50 rounded-lg p-3 border border-green-200 text-center">
                        <p class="text-xs font-medium text-gray-600 mb-1">{{ item.cargo_name }}</p>
                        <p class="text-lg font-bold text-green-700">{{ item.quantity }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% if labor_entries_by_category.terceirizada %}
            <div class="pt-4 border-t border-slate-200">
                <h4 class="text-sm font-semibold text-gray-700 mb-3">Mão de Obra Terceirizada</h4>
                {% for block in labor_entries_by_category.terceirizada %}
                <div class="mb-3">
                    <p class="text-xs font-semibold text-slate-600 mb-2">{{ block.company }}</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                        {% for item in block.items %}
                        <div class="bg-purple-50 rounded-lg p-3 border border-purple-200 text-center">
                            <p class="text-xs font-medium text-gray-600 mb-1">{{ item.cargo_name }}</p>
                            <p class="text-lg font-bold text-purple-700">{{ item.quantity }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% else %}
        {% if total_direct_labor > 0 or total_indirect_labor > 0 or total_third_party_labor > 0 %}
        <div class="bg-white rounded-lg p-4 border border-slate-200">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 pb-4 border-b border-slate-200">
                {% if total_direct_labor > 0 %}
                <div class="text-center bg-green-50 rounded-lg p-3 border border-green-200">
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Direto</p>
                    <p class="text-2xl font-bold text-green-700">{{ total_direct_labor }}</p>
                </div>
                {% endif %}
                {% if total_indirect_labor > 0 %}
                <div class="text-center bg-blue-50 rounded-lg p-3 border border-blue-200">
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Indireto (LPLAN)</p>
                    <p class="text-2xl font-bold text-blue-700">{{ total_indirect_labor }}</p>
                </div>
                {% endif %}
                {% if total_third_party_labor > 0 %}
                <div class="text-center bg-purple-50 rounded-lg p-3 border border-purple-200">
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Terceiros</p>
                    <p class="text-2xl font-bold text-purple-700">{{ total_third_party_labor }}</p>
                </div>
                {% endif %}
            </div>
            {% if labor_by_type.Direto %}
            <div class="mb-4">
                <h4 class="text-sm font-semibold text-gray-700 mb-3">Mão de Obra Direta</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    {% for labor_name, count in labor_by_type.Direto.items %}
                    <div class="bg-green-50 rounded-lg p-3 border border-green-200 text-center">
                        <p class="text-xs font-medium text-gray-600 mb-1">{{ labor_name }}</p>
                        <p class="text-lg font-bold text-green-700">{{ count }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% if labor_by_type.Indireto %}
            <div class="mb-4 pt-4 border-t border-slate-200">
                <h4 class="text-sm font-semibold text-gray-700 mb-3">Mão de Obra Indireta (LPLAN)</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    {% for labor_name, count in labor_by_type.Indireto.items %}
                    <div class="bg-blue-50 rounded-lg p-3 border border-blue-200 text-center">
                        <p class="text-xs font-medium text-gray-600 mb-1">{{ labor_name }}</p>
                        <p class="text-lg font-bold text-blue-700">{{ count }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% if labor_by_type.Terceiros %}
            <div class="pt-4 border-t border-slate-200">
                <h4 class="text-sm font-semibold text-gray-700 mb-3">Mão de Obra Terceiros</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    {% for labor_name, count in labor_by_type.Terceiros.items %}
                    <div class="bg-purple-50 rounded-lg p-3 border border-purple-200 text-center">
                        <p class="text-xs font-medium text-gray-600 mb-1">{{ labor_name }}</p>
                        <p class="text-lg font-bold text-purple-700">{{ count }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 text-center">
            <p class="text-sm text-gray-500">
                <i class="fas fa-info-circle mr-3"></i>Nenhuma mão de obra registrada para este dia
            </p>
        </div>
        {% endif %}
        {% endif %}
    </div>

    <!-- Equipamentos -->
    <div class="mb-6">
        <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
            <i class="fas fa-tools text-blue-600 mr-3"></i>
            Equipamentos Utilizados
            {% if equipment_list %}<span class="ml-2 text-sm font-normal text-gray-500">({{ equipment_list|length }})</span>{% endif %}
        </h3>
        {% if equipment_list %}
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
            {% for equipment in equipment_list %}
            <div class="bg-slate-50 rounded-lg p-3 border border-slate-200 hover:shadow-md transition-shadow">
                <p class="text-sm font-semibold text-slate-800">{{ equipment.name }}</p>
                {% if equipment.code %}
                <p class="text-xs text-gray-600 mt-1">
                    <i class="fas fa-hashtag mr-2"></i>{{ equipment.code }}
                </p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 text-center">
            <p class="text-sm text-gray-500">
                <i class="fas fa-info-circle mr-2"></i>Nenhum equipamento registrado para este dia
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Ocorrências (modelo DiaryOccurrence + campos legados) -->
    <div class="mb-6">
        <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
            <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
            Interrupções e Ocorrências
        </h3>
        {% if diary.occurrences.all or diary.accidents or diary.stoppages or diary.imminent_risks or diary.incidents %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% for occ in diary.occurrences.all %}
            <div class="bg-slate-50 rounded-lg p-4 border-l-4 border-red-500">
                <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ occ.description|linebreaks }}</p>
                {% if occ.tags.exists %}
                <div class="mt-2 flex flex-wrap gap-1">
                    {% for tag in occ.tags.all %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800"># {{ tag.name }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
            {% if diary.accidents %}
            <div class="bg-red-50 rounded-lg p-4 border-l-4 border-red-500">
                <h4 class="text-md font-semibold text-red-800 mb-2 flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                    Acidentes
                </h4>
                <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ diary.accidents|linebreaks }}</p>
            </div>
            {% endif %}
            {% if diary.stoppages %}
            <div class="bg-orange-50 rounded-lg p-4 border-l-4 border-orange-500">
                <h4 class="text-md font-semibold text-orange-800 mb-2 flex items-center">
                    <i class="fas fa-pause-circle text-orange-500 mr-3"></i>
                    Paralisações
                </h4>
                <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ diary.stoppages|linebreaks }}</p>
            </div>
            {% endif %}
            {% if diary.imminent_risks %}
            <div class="bg-yellow-50 rounded-lg p-4 border-l-4 border-yellow-500">
                <h4 class="text-md font-semibold text-yellow-800 mb-2 flex items-center">
                    <i class="fas fa-exclamation-circle text-yellow-500 mr-3"></i>
                    Riscos Eminentes
                </h4>
                <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ diary.imminent_risks|linebreaks }}</p>
            </div>
            {% endif %}
            {% if diary.incidents %}
            <div class="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
                <h4 class="text-md font-semibold text-blue-800 mb-2 flex items-center">
                    <i class="fas fa-info-circle text-blue-500 mr-3"></i>
                    Outros Incidentes
                </h4>
                <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ diary.incidents|linebreaks }}</p>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 text-center">
            <p class="text-sm text-gray-500">
                <i class="fas fa-check-circle mr-3 text-green-500"></i>Nenhuma ocorrência registrada para este dia
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Atividades executadas (work_logs do diário + Fiscalizações, DDS) -->
    <div class="mb-6">
        <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
            <i class="fas fa-calendar-check text-blue-600 mr-3"></i>
            Atividades executadas
        </h3>
        {% if diary.work_logs.all or diary.inspections or diary.dds %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% for wl in diary.work_logs.all %}
            <div class="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
                <h4 class="text-md font-semibold text-blue-800 mb-2 flex items-center">
                    <i class="fas fa-tasks text-blue-500 mr-3"></i>
                    {{ wl.activity.name }}
                </h4>
                {% if wl.notes %}
                <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ wl.notes|linebreaks }}</p>
                {% endif %}
                {% if wl.percentage_executed_today and wl.percentage_executed_today != 0 %}
                <p class="text-xs text-gray-600 mt-2">Executado no dia: {{ wl.percentage_executed_today }}%</p>
                {% endif %}
            </div>
            {% endfor %}
            {% if diary.inspections %}
            <div class="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
                <h4 class="text-md font-semibold text-blue-800 mb-2 flex items-center">
                    <i class="fas fa-clipboard-check text-blue-500 mr-3"></i>
                    Fiscalizações
                </h4>
                <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ diary.inspections|linebreaks }}</p>
            </div>
            {% endif %}
            {% if diary.dds %}
            <div class="bg-green-50 rounded-lg p-4 border-l-4 border-green-500">
                <h4 class="text-md font-semibold text-green-800 mb-2 flex items-center">
                    <i class="fas fa-shield-alt text-green-500 mr-3"></i>
                    DDS (Discurso Diário de Segurança)
                </h4>
                <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ diary.dds|linebreaks }}</p>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 text-center">
            <p class="text-sm text-gray-500">
                <i class="fas fa-info-circle mr-3"></i>Nenhuma atividade executada registrada para este dia
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Deliberações -->
    {% if diary.deliberations %}
    <div class="mb-6">
        <h3 class="text-lg font-semibold text-slate-800 mb-3 flex items-center">
            <i class="fas fa-gavel text-blue-600 mr-3"></i>
            Deliberações
        </h3>
        <div class="bg-amber-50 rounded-lg p-4 border-l-4 border-amber-500">
            <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ diary.deliberations|linebreaks }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Observações Gerais -->
    {% if diary.general_notes %}
    <div class="mb-6">
        <h3 class="text-lg font-semibold text-slate-800 mb-3 flex items-center">
            <i class="fas fa-sticky-note text-blue-600 mr-3"></i>
            Observações Gerais
        </h3>
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
            <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ diary.general_notes|linebreaks }}</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Imagens -->
{% if diary.images.all %}
<div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-6">
    <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
        <i class="fas fa-camera text-blue-600 mr-3"></i>
        Fotos de Evidência ({{ diary.images.count }})
    </h3>
    <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
        {% for image in diary.images.all %}
        <div class="relative group diary-photo-thumb">
            <img src="{{ image.image.url }}" 
                 alt="{{ image.caption|default:'Foto' }}"
                 class="w-full h-32 object-cover rounded-lg border border-gray-200 hover:shadow-md transition-shadow cursor-pointer"
                 onclick="window.open('{{ image.image.url }}', '_blank')">
            {% if image.caption %}
            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs p-2 rounded-b-lg">
                {{ image.caption|truncatewords:8 }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Vídeos -->
{% if diary.videos.all %}
<div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-6">
    <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
        <i class="fas fa-video text-blue-600 mr-3"></i>
        Vídeos de Evidência ({{ diary.videos.count }})
    </h3>
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
        {% for video in diary.videos.all %}
        <div class="relative diary-video-preview">
            <video class="w-full rounded-lg border border-gray-200 diary-video-player" 
                   controls 
                   preload="metadata"
                   style="pointer-events: auto;">
                <source src="{{ video.video.url }}" type="video/mp4">
                Seu navegador não suporta a reprodução de vídeos.
            </video>
            {% if video.caption %}
            <p class="text-xs text-gray-600 mt-1.5 line-clamp-2">{{ video.caption }}</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Registros de Trabalho -->
{% if diary.work_logs.all %}
<div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-6">
    <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
        <i class="fas fa-tasks text-blue-600 mr-3"></i>
        Registros de Trabalho ({{ diary.work_logs.count }})
    </h3>
    <div class="space-y-4">
        {% for work_log in diary.work_logs.all %}
        <div class="border-l-4 border-blue-600 pl-4 py-3 bg-blue-50 rounded-r-lg">
            <h4 class="font-semibold text-slate-800 mb-2">
                <i class="fas fa-project-diagram text-blue-600 mr-3"></i>
                {{ work_log.activity.code }} - {{ work_log.activity.name }}
            </h4>
            {% if work_log.location %}
            <p class="text-sm text-gray-600 mb-2">
                <i class="fas fa-map-marker-alt text-blue-500 mr-2"></i>
                <strong>Local:</strong> {{ work_log.location }}
            </p>
            {% endif %}
            <div class="grid grid-cols-2 gap-4 mb-2">
                <div class="bg-white rounded p-2">
                    <p class="text-xs text-gray-500 mb-1">Progresso Hoje</p>
                    <p class="text-sm font-bold text-blue-600">{{ work_log.percentage_executed_today }}%</p>
                </div>
                <div class="bg-white rounded p-2">
                    <p class="text-xs text-gray-500 mb-1">Acumulado</p>
                    <p class="text-sm font-bold text-green-600">{{ work_log.accumulated_progress_snapshot }}%</p>
                </div>
            </div>
            {% if work_log.notes %}
            <p class="text-sm text-gray-700 mt-2 bg-white p-2 rounded border">
                <strong>Descrição:</strong> {{ work_log.notes }}
            </p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Assinatura -->
{% if signature_inspection %}
<div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-6">
    <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
        <i class="fas fa-signature text-blue-600 mr-3"></i>
        Assinaturas
    </h3>
    <div class="max-w-md">
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
            <p class="text-sm font-semibold text-gray-700 mb-3">Responsável pelo preenchimento</p>
            <div class="border-2 border-gray-300 rounded p-2 bg-white mb-2">
                <img src="{{ signature_inspection.signature_data }}" 
                     alt="Assinatura - Responsável pelo preenchimento" 
                     class="w-full h-24 object-contain">
            </div>
            <p class="text-xs text-gray-600">
                <i class="fas fa-user mr-2"></i>{{ signature_inspection.signer.get_full_name|default:signature_inspection.signer.username }}
                <br>
                <i class="fas fa-clock mr-2"></i>{{ signature_inspection.signed_at|date:"d/m/Y H:i" }}
            </p>
        </div>
    </div>
</div>
{% endif %}

<!-- Informações de Auditoria -->
<div class="bg-gray-50 rounded-lg border border-gray-200 p-4 mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between text-sm text-gray-600 space-y-2 md:space-y-0">
        <div>
            <p class="mb-1">
                <i class="fas fa-user-plus mr-2"></i>
                <strong>Criado por:</strong> {{ diary.created_by.get_full_name|default:diary.created_by.username }} 
                em {{ diary.created_at|date:"d/m/Y H:i" }}
            </p>
            {% if diary.updated_at != diary.created_at %}
            <p class="text-xs text-gray-500">
                <i class="fas fa-edit mr-2"></i>
                Última modificação: {{ diary.updated_at|date:"d/m/Y H:i" }}
            </p>
            {% endif %}
        </div>
        <div class="flex space-x-4">
            {% if edit_count > 0 %}
            <button type="button"
                    onclick="document.getElementById('edit-logs-modal').classList.remove('hidden')"
                    class="text-blue-600 hover:text-blue-800 cursor-pointer transition-colors">
                <i class="fas fa-history mr-2"></i>Log de edições ({{ edit_count }})
            </button>
            {% else %}
            <span class="text-gray-500">
                <i class="fas fa-history mr-2"></i>Log de edições (0)
            </span>
            {% endif %}
        </div>
    </div>
</div>

<!-- Comentários com o dono da obra (chat LPLAN ↔ cliente) -->
{% if diary.is_approved %}
<div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-6">
    <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
        <i class="fas fa-comments text-blue-600 mr-3"></i>
        Comentários com o dono da obra
    </h3>
    {% if owner_comments %}
    <ul class="space-y-4 mb-6">
        {% for c in owner_comments %}
        <li class="flex {% if c.author == user %}justify-end{% else %}justify-start{% endif %}">
            <div class="max-w-[85%] rounded-lg px-4 py-2 {% if c.author == user %}bg-blue-100 text-blue-900{% else %}bg-slate-100 text-slate-800{% endif %}">
                <p class="text-sm font-medium">{{ c.author.get_full_name|default:c.author.username }}</p>
                <p class="text-sm whitespace-pre-wrap mt-1">{{ c.text }}</p>
                <p class="text-xs text-slate-500 mt-2">{{ c.created_at|date:"d/m/Y H:i" }}</p>
            </div>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="text-sm text-slate-500 mb-6">Nenhum comentário ainda. O dono da obra pode comentar na página de visualização (link enviado por e-mail) dentro de 24h após o envio.</p>
    {% endif %}
    {% if can_add_owner_comment %}
    <form action="{% url 'diary-add-owner-comment' diary.id %}" method="post" class="flex flex-col gap-3">
        {% csrf_token %}
        <textarea name="text" rows="3" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Resposta ao dono da obra..." required></textarea>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium w-fit"><i class="fas fa-paper-plane mr-2"></i>Enviar resposta</button>
    </form>
    {% endif %}
</div>
{% endif %}

<!-- Modal: Log de Edições -->
<div id="edit-logs-modal" 
     class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm"
     onclick="if(event.target === this) this.classList.add('hidden')">
    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-blue-100">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-history mr-3 text-blue-600"></i>Log de Edições
                </h3>
                <button type="button"
                        onclick="document.getElementById('edit-logs-modal').classList.add('hidden')"
                        aria-label="Fechar modal"
                        class="text-gray-400 hover:text-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 rounded p-1">
                    <i class="fas fa-times text-xl" aria-hidden="true"></i>
                </button>
            </div>
        </div>
        
        <!-- Conteúdo -->
        <div class="p-6 overflow-y-auto max-h-[60vh]">
            {% if edit_logs %}
            <div class="space-y-4">
                {% for log in edit_logs %}
                <div class="border-l-4 border-blue-500 pl-4 py-3 bg-blue-50 rounded-r-lg">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <p class="text-sm font-semibold text-gray-900">
                                <i class="fas fa-user mr-2"></i>
                                {{ log.edited_by.get_full_name|default:log.edited_by.username }}
                            </p>
                            <p class="text-xs text-gray-600 mt-1">
                                <i class="fas fa-clock mr-2"></i>{{ log.edited_at|date:"d/m/Y H:i:s" }}
                            </p>
                            {% if log.changes_summary %}
                            <p class="text-xs text-gray-700 mt-2 bg-white p-2 rounded border">
                                {{ log.changes_summary }}
                            </p>
                            {% endif %}
                            {% if log.notes %}
                            <p class="text-xs text-gray-600 mt-1 italic">
                                {{ log.notes }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <i class="fas fa-history text-gray-300 text-4xl mb-3"></i>
                <p class="text-gray-500">Nenhuma edição registrada</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Footer -->
        <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
            <button type="button"
                    onclick="document.getElementById('edit-logs-modal').classList.add('hidden')"
                    class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium">
                Fechar
            </button>
        </div>
    </div>
</div>

<script>
(function() {
    // Dropdown de Impressão
    const printButton = document.getElementById('print-dropdown-button');
    const printMenu = document.getElementById('print-dropdown-menu');
    const printChevron = document.getElementById('print-dropdown-chevron');
    const printContainer = document.getElementById('print-dropdown-container');
    
    if (printButton && printMenu && printChevron) {
        let isPrintOpen = false;
        
        function togglePrintDropdown(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            isPrintOpen = !isPrintOpen;
            
            if (isPrintOpen) {
                printMenu.style.display = 'block';
                printButton.setAttribute('aria-expanded', 'true');
                printButton.classList.remove('bg-gray-800');
                printButton.classList.add('bg-gray-700');
                printChevron.style.transform = 'rotate(180deg)';
            } else {
                printMenu.style.display = 'none';
                printButton.setAttribute('aria-expanded', 'false');
                printButton.classList.remove('bg-gray-700');
                printButton.classList.add('bg-gray-800');
                printChevron.style.transform = 'rotate(0deg)';
            }
        }
        
        printButton.addEventListener('click', togglePrintDropdown);
        
        // Fecha ao clicar fora
        document.addEventListener('click', function(e) {
            if (isPrintOpen && printContainer && !printContainer.contains(e.target)) {
                isPrintOpen = false;
                printMenu.style.display = 'none';
                printButton.setAttribute('aria-expanded', 'false');
                printButton.classList.remove('bg-gray-700');
                printButton.classList.add('bg-gray-800');
                printChevron.style.transform = 'rotate(0deg)';
            }
        });
    }
})();
</script>
{% endblock %}
