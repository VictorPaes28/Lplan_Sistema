{% extends 'base.html' %}
{% load static %}

{% block title %}{{ action|title }} Pedido: {{ workorder.codigo }}{% endblock %}

{% block page_title %}Aprovação{% endblock %}
{% block page_subtitle %}GestControll{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/approval_form.css' %}">
{% endblock %}

{% block content %}
<div class="approval-container">
    <div class="card">
        <h1 class="approval-title">
            {% if action == 'aprovar' %}
                Aprovar Pedido de Obra
            {% else %}
                Reprovar Pedido de Obra
            {% endif %}
        </h1>
        
        <div class="approval-info-box">
            <p><strong>Código:</strong> {{ workorder.codigo }}</p>
            <p><strong>Obra:</strong> {{ workorder.obra.codigo }} - {{ workorder.obra.nome }}</p>
            <p><strong>Credor:</strong> {{ workorder.nome_credor }}</p>
        </div>
        
        <div class="approval-alert {{ action }}">
            <strong>
                {% if action == 'aprovar' %}
                    ✓ Você está prestes a aprovar este pedido de obra.
                {% else %}
                    ✗ Você está prestes a reprovar este pedido de obra.
                {% endif %}
            </strong>
            <p>
                {% if action == 'aprovar' %}
                    O pedido será marcado como aprovado e não poderá mais ser editado.
                {% else %}
                    Selecione pelo menos uma tag de erro ou informe um comentário explicando o motivo da reprovação.
                {% endif %}
            </p>
        </div>
        
        <form method="post">
            {% csrf_token %}
            
            {% if action == 'reprovar' and tags_disponiveis %}
                <div class="approval-form-group">
                    <label class="approval-label">
                        Tags de Erro <span class="approval-required">*</span> (selecione uma ou mais):
                    </label>
                    <div class="tags-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.75rem; margin-top: 0.5rem;">
                        {% for tag in tags_disponiveis %}
                            <label class="tag-checkbox-label" style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid #dee2e6; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; background-color: #fff;">
                                <input 
                                    type="checkbox" 
                                    name="tags_erro" 
                                    value="{{ tag.id }}"
                                    {% if tag.id in tags_selecionadas %}checked{% endif %}
                                    style="margin-right: 0.5rem; width: 18px; height: 18px; cursor: pointer;"
                                    onchange="this.parentElement.style.borderColor = this.checked ? '#dc3545' : '#dee2e6'; this.parentElement.style.backgroundColor = this.checked ? '#fff5f5' : '#fff';"
                                >
                                <div style="flex: 1;">
                                    <strong style="display: block; color: #2c3e50; font-size: 0.95rem;">{{ tag.nome }}</strong>
                                    {% if tag.descricao %}
                                        <small style="display: block; color: #6c757d; font-size: 0.85rem; margin-top: 0.25rem;">{{ tag.descricao|truncatewords:15 }}</small>
                                    {% endif %}
                                </div>
                            </label>
                        {% endfor %}
                    </div>
                    <p class="approval-help" style="margin-top: 0.75rem; color: #6c757d; font-size: 0.9rem;">
                        Selecione uma ou mais tags que descrevem os motivos da reprovação. Você também pode adicionar um comentário complementar abaixo.
                    </p>
                </div>
            {% endif %}
            
            <div class="approval-form-group">
                <label for="comentario" class="approval-label">
                    Comentário {% if action == 'reprovar' %}(opcional - complementar às tags){% else %}(opcional){% endif %}:
                </label>
                <textarea 
                    id="comentario" 
                    name="comentario" 
                    rows="5"
                    placeholder="{% if action == 'aprovar' %}Adicione observações sobre a aprovação (opcional)...{% else %}Adicione observações complementares às tags selecionadas (opcional)...{% endif %}"
                    class="approval-textarea"
                >{{ comentario|default:'' }}</textarea>
                {% if action == 'reprovar' %}
                    <p class="approval-help">
                        Use este campo para adicionar informações complementares às tags selecionadas.
                    </p>
                {% endif %}
            </div>
            
            <div class="approval-actions">
                <button 
                    type="submit" 
                    class="btn approval-submit {{ action }}"
                >
                    {% if action == 'aprovar' %}
                        ✓ Confirmar Aprovação
                    {% else %}
                        ✗ Confirmar Reprovação
                    {% endif %}
                </button>
                <a href="{% url 'gestao:detail_workorder' workorder.pk %}" class="btn btn-secondary approval-cancel">
                    Cancelar
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}
