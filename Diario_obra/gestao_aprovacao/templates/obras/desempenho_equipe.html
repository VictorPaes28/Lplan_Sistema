{% extends 'base.html' %}
{% load static %}

{% block title %}Desempenho da Equipe{% endblock %}

{% block page_title %}Desempenho da Equipe{% endblock %}
{% block page_subtitle %}GestControll - Análise{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/desempenho_equipe.css' %}">
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">Análise de Desempenho</h1>
        <p class="page-header-desc">Métricas do processo de pedidos e do fluxo de aprovação</p>
    </div>

    <!-- Conteúdo Integrado -->
    <div class="desempenho-content-wrap">
        <!-- Seção: Qualidade das Solicitações -->
        <section class="desempenho-section" aria-label="Qualidade das solicitações">
            <h2 class="desempenho-section-title">Qualidade das Solicitações</h2>
            <div id="tab-solicitantes" class="tab-content">
        <div class="performance-card" style="background: transparent; border: none; box-shadow: none; padding: 0;">
            <!-- Filtros -->
            <div class="period-selector-container" style="display: flex; gap: 1.25rem; align-items: flex-end; flex-wrap: wrap; padding: 1rem 1.25rem; background: #ffffff; border: 1px solid #E6E8EC; border-radius: 10px; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
                <div style="flex: 1; min-width: 200px;">
                    <label for="period-selector-solicitantes" class="period-label" style="color: #6c757d; font-weight: 500; margin-bottom: 0.375rem; display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.3px;">Período de análise</label>
                    <select id="period-selector-solicitantes" class="period-selector" style="width: 100%; height: 40px; padding: 0 0.875rem; border-radius: 10px; border: 1px solid #E6E8EC; font-size: 0.9rem; background: white; color: #212529; cursor: pointer;">
                        <option value="7">Últimos 7 dias</option>
                        <option value="15">Últimos 15 dias</option>
                        <option value="30" selected>Últimos 30 dias</option>
                        <option value="60">Últimos 60 dias</option>
                        <option value="90">Últimos 90 dias</option>
                    </select>
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label for="tipo-selector-solicitantes" class="period-label" style="color: #6c757d; font-weight: 500; margin-bottom: 0.375rem; display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.3px;">Tipo de Solicitação</label>
                    <select id="tipo-selector-solicitantes" class="period-selector" style="width: 100%; height: 40px; padding: 0 0.875rem; border-radius: 10px; border: 1px solid #E6E8EC; font-size: 0.9rem; background: white; color: #212529; cursor: pointer;">
                        <option value="">Todos os tipos</option>
                        <option value="contrato">Contrato</option>
                        <option value="medicao">Medição</option>
                        <option value="ordem_servico">Ordem de Serviço (OS)</option>
                        <option value="mapa_cotacao">Mapa de Cotação</option>
                    </select>
                </div>
            </div>
            
            <!-- Cards de Resumo Geral -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.25rem; margin-bottom: 2rem;">
                <div style="background: #ffffff; padding: 1.25rem 1.5rem; border-radius: 12px; border: 1px solid #E6E8EC; box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
                    <div style="font-size: 0.7rem; color: #6c757d; margin-bottom: 0.5rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px;">Total de Reprovações</div>
                    <div style="font-size: 2.25rem; font-weight: 700; line-height: 1.1; color: #495057;" id="total-reprovacoes-solicitantes">Carregando...</div>
                </div>
                <div style="background: #ffffff; padding: 1.25rem 1.5rem; border-radius: 12px; border: 1px solid #E6E8EC; box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
                    <div style="font-size: 0.7rem; color: #6c757d; margin-bottom: 0.5rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px;">Solicitantes com Erros</div>
                    <div style="font-size: 2.25rem; font-weight: 700; line-height: 1.1; color: #495057;" id="total-solicitantes">-</div>
                </div>
                <div style="background: #ffffff; padding: 1.25rem 1.5rem; border-radius: 12px; border: 1px solid #E6E8EC; box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
                    <div style="font-size: 0.7rem; color: #6c757d; margin-bottom: 0.5rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px;">Taxa de Reprovação</div>
                    <div style="font-size: 2.25rem; font-weight: 700; line-height: 1.1; color: #495057;" id="taxa-reprovacao-geral">-</div>
                </div>
            </div>

            <!-- Top Tags Gerais -->
            <div id="top-tags-container" style="margin: 1.5rem 0; padding: 1.5rem; background: #ffffff; border: 1px solid #E6E8EC; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); display: none;">
                <h3 style="margin: 0 0 1.25rem 0; color: #212529; font-size: 1.1rem; font-weight: 600;">
                    Top Tags de Erro (Geral)
                </h3>
                <div id="top-tags-list" style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <!-- Preenchido via JavaScript -->
                </div>
            </div>

            <!-- Reprovações por Tipo -->
            <div id="reprovacoes-por-tipo-container" style="margin: 1.5rem 0; padding: 1.5rem; background: #ffffff; border: 1px solid #E6E8EC; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); display: none;">
                <h3 style="margin: 0 0 1.25rem 0; color: #212529; font-size: 1.1rem; font-weight: 600;">
                    Reprovações por Tipo de Solicitação
                </h3>
                <div id="reprovacoes-por-tipo-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                    <!-- Preenchido via JavaScript -->
                </div>
            </div>

            <!-- Tabela de Solicitantes -->
            <div class="detailed-table-container" id="solicitantes-table-container" style="display: none; margin-top: 2rem;">
                <div class="table-header" style="margin-bottom: 1.25rem; padding: 1.25rem; background: #ffffff; border: 1px solid #E6E8EC; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
                    <h3 class="table-title" style="margin: 0 0 0.5rem 0; color: #212529; font-size: 1.1rem; font-weight: 600;">
                        Análise Detalhada por Solicitante
                    </h3>
                    <p style="margin: 0; color: #6c757d; font-size: 0.8rem; line-height: 1.4;">
                        Ordenado por número de reprovações (1º = maior volume). Dados apenas para análise do processo.
                    </p>
                </div>
                <div class="table-wrapper" style="background: white; border-radius: 12px; border: 1px solid #E6E8EC; box-shadow: 0 1px 3px rgba(0,0,0,0.06); overflow: hidden;">
                    <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                        <table class="detailed-table" id="solicitantes-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="position: sticky; top: 0; z-index: 10; background: #F6F7F9;">
                                <tr>
                                    <th style="padding: 0.75rem 0.875rem; text-align: center; font-weight: 600; color: #495057; border-bottom: 1px solid #E6E8EC; font-size: 0.8rem; white-space: nowrap;" title="Posição por número de reprovações (1º = mais reprovações)">Pos.</th>
                                    <th style="padding: 0.75rem 0.875rem; text-align: left; font-weight: 600; color: #495057; border-bottom: 1px solid #E6E8EC; font-size: 0.85rem;">Solicitante</th>
                                    <th style="padding: 0.75rem 0.875rem; text-align: center; font-weight: 600; color: #495057; border-bottom: 1px solid #E6E8EC; font-size: 0.85rem;">Total Pedidos</th>
                                    <th style="padding: 0.75rem 0.875rem; text-align: center; font-weight: 600; color: #495057; border-bottom: 1px solid #E6E8EC; font-size: 0.85rem;">Reprovações</th>
                                    <th style="padding: 0.75rem 0.875rem; text-align: center; font-weight: 600; color: #495057; border-bottom: 1px solid #E6E8EC; font-size: 0.85rem;">Taxa de Erro</th>
                                    <th style="padding: 0.75rem 0.875rem; text-align: center; font-weight: 600; color: #495057; border-bottom: 1px solid #E6E8EC; font-size: 0.85rem;" title="Média de motivos de erro marcados em cada reprovação">Motivos por reprovação</th>
                                    <th style="padding: 0.75rem 0.875rem; text-align: center; font-weight: 600; color: #495057; border-bottom: 1px solid #E6E8EC; font-size: 0.85rem;" title="Tempo médio para corrigir e reenviar após reprovação">Tempo para corrigir</th>
                                    <th style="padding: 0.75rem 0.875rem; text-align: center; font-weight: 600; color: #495057; border-bottom: 1px solid #E6E8EC; font-size: 0.85rem;" title="Tempo desde a criação do pedido até a aprovação final">Tempo até aprovação</th>
                                    <th style="padding: 0.75rem 0.875rem; text-align: left; font-weight: 600; color: #495057; border-bottom: 1px solid #E6E8EC; font-size: 0.85rem;">Por tipo</th>
                                    <th style="padding: 0.75rem 0.875rem; text-align: left; font-weight: 600; color: #495057; border-bottom: 1px solid #E6E8EC; font-size: 0.85rem;">Principais motivos de erro</th>
                                    <th style="padding: 0.75rem 0.875rem; text-align: center; font-weight: 600; color: #495057; border-bottom: 1px solid #E6E8EC; font-size: 0.85rem;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="solicitantes-table-body">
                                <!-- Preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            </div>
        </section>

        <!-- Seção: Fluxo de Aprovação -->
        <section class="desempenho-section desempenho-section-flow" aria-label="Fluxo de aprovação">
            <h2 class="desempenho-section-title">Fluxo de Aprovação</h2>
            <div id="tab-aprovadores" class="tab-content">
            <div class="performance-card performance-card-inner">
                <div class="period-selector-container" style="margin-bottom: 1rem;">
                    <div class="period-selector-group">
                        <label for="period-selector" class="period-label">Período</label>
                        <select id="period-selector" class="period-selector">
                            <option value="7">Últimos 7 dias</option>
                            <option value="15">Últimos 15 dias</option>
                            <option value="30" selected>Últimos 30 dias</option>
                            <option value="60">Últimos 60 dias</option>
                            <option value="90">Últimos 90 dias</option>
                        </select>
                    </div>
                </div>
                <div id="aprovadores-blocks" class="desempenho-blocks-wrap" style="display: none;"></div>
            </div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const periodSelector = document.getElementById('period-selector');
    if (!periodSelector) return;
    
    let currentAbortController = null;
    
    function formatarTempo(horas) {
        if (!horas && horas !== 0) return '-';
        const h = Math.floor(horas);
        const m = Math.round((horas - h) * 60);
        if (h > 0 && m > 0) return `${h}h ${m}min`;
        if (h > 0) return `${h}h`;
        if (m > 0) return `${m}min`;
        return '0min';
    }
    
    function criarBlocosAprovadores(dados, slaHoras, dias) {
        const container = document.getElementById('aprovadores-blocks');
        if (!container || !dados || dados.length === 0) {
            if (container) container.style.display = 'none';
            return;
        }
        container.style.display = 'block';
        container.innerHTML = '';
        const metaSla = slaHoras || 24;
        const numDias = dias > 0 ? dias : 30;
        
        dados.forEach((item) => {
            const total = item.total_decisoes || 0;
            const taxaAprov = total > 0 ? ((item.aprovados || 0) / total * 100).toFixed(0) : 0;
            const mediaPorDia = numDias > 0 ? (total / numDias) : 0;
            const mediaPorDiaStr = mediaPorDia % 1 === 0 ? mediaPorDia.toString() : mediaPorDia.toFixed(1).replace('.', ',');
            const card = document.createElement('div');
            card.style.cssText = 'background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.75rem 2rem; max-width: 640px; box-shadow: 0 1px 3px rgba(0,0,0,0.06);';
            card.innerHTML = `
                <div style="margin-bottom: 1.25rem; padding-bottom: 0.875rem; border-bottom: 2px solid #e2e8f0;">
                    <div style="font-size: 1.25rem; font-weight: 600; color: #1e293b;">${item.usuario}</div>
                    <div style="font-size: 0.9rem; color: #64748b; margin-top: 0.25rem;">${total} decisões no período</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem 1.5rem; font-size: 0.875rem;">
                    <div style="min-height: 3.5rem;">
                        <div style="color: #64748b; font-size: 0.75rem; margin-bottom: 0.25rem;">Média de decisões por dia</div>
                        <div style="font-weight: 600; color: #334155; font-size: 1rem;">${mediaPorDiaStr}</div>
                    </div>
                    <div style="min-height: 3.5rem;">
                        <div style="color: #64748b; font-size: 0.75rem; margin-bottom: 0.25rem;">Demora média para decidir</div>
                        <div style="font-weight: 600; color: #334155; font-size: 1rem;">${formatarTempo(item.tempo_medio_horas)}</div>
                        <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 0.125rem;">Meta: ${metaSla}h</div>
                    </div>
                    <div style="min-height: 3.5rem;">
                        <div style="color: #64748b; font-size: 0.75rem; margin-bottom: 0.25rem;">Decisões atrasadas</div>
                        <div style="font-weight: 600; color: #334155; font-size: 1rem;">${item.pct_fora_sla != null ? item.pct_fora_sla + '%' : '-'}</div>
                        <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 0.125rem;">ideal &lt; 20%</div>
                    </div>
                    <div style="min-height: 3.5rem;">
                        <div style="color: #64748b; font-size: 0.75rem; margin-bottom: 0.25rem;">Aprovados / Reprovados</div>
                        <div style="font-weight: 600; color: #334155; font-size: 1rem;">${item.aprovados || 0} / ${item.reprovados || 0}</div>
                        <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 0.125rem;">${taxaAprov}% aprov.</div>
                    </div>
                    <div style="min-height: 3.5rem;">
                        <div style="color: #64748b; font-size: 0.75rem; margin-bottom: 0.25rem;">Aguardando análise</div>
                        <div style="font-weight: 600; color: #334155; font-size: 1rem;">${item.backlog || 0}</div>
                        <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 0.125rem;">pedidos não analisados</div>
                    </div>
                </div>
                ${item.diagnostico ? `
                <div style="margin-top: 1.25rem; padding: 0.875rem 1rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.8125rem; color: #475569; line-height: 1.5;">
                    ${item.diagnostico}
                </div>
                ` : ''}
            `;
            container.appendChild(card);
        });
    }
    
    function carregarDados(dias) {
        if (currentAbortController) currentAbortController.abort();
        currentAbortController = new AbortController();
        const timeoutId = setTimeout(() => currentAbortController.abort(), 30000);
        const container = document.getElementById('aprovadores-blocks');
        if (container) {
            container.style.display = 'block';
            container.innerHTML = '<div style="color: #64748b; font-size: 0.9rem;">Carregando...</div>';
        }
        
        fetch('{% url "gestao:desempenho_equipe_api" %}?dias=' + dias, { signal: currentAbortController.signal })
        .then(response => {
            clearTimeout(timeoutId);
            return response.json().then(data => {
                if (!response.ok) throw new Error(data.erro || 'Erro ' + response.status);
                return data;
            });
        })
        .then(data => {
            if (data.erro) {
                if (container) {
                    container.innerHTML = '<div style="color: #64748b; font-size: 0.9rem;">' + (data.erro || 'Erro ao carregar') + '</div>';
                }
                return;
            }
            criarBlocosAprovadores(data.dados, data.sla_horas || 24, parseInt(document.getElementById('period-selector').value) || 30);
        })
        .catch(function(err) {
            clearTimeout(timeoutId);
            if (container) {
                container.innerHTML = '<div style="color: #64748b; font-size: 0.9rem;">Erro ao carregar. Tente de novo.</div>';
            }
        });
    }
    
    // Event listener para mudança de período
    periodSelector.addEventListener('change', function() {
        const dias = parseInt(this.value);
        carregarDados(dias);
    });
    
    // Carregar dados iniciais de ambas as seções (sem abas, tudo visível)
    carregarDados(30);
    
    // Carregar dados iniciais de solicitantes
});

// ========== FUNCIONALIDADE DE SOLICITANTES ==========
document.addEventListener('DOMContentLoaded', function() {
    // Função para carregar dados de solicitantes
    function carregarDadosSolicitantes(dias, tipoSolicitacao) {
        const totalReprovacoesEl = document.getElementById('total-reprovacoes-solicitantes');
        const periodoEl = document.getElementById('periodo-analisado-solicitantes');
        const totalSolicitantesEl = document.getElementById('total-solicitantes');
        
        if (totalReprovacoesEl) totalReprovacoesEl.textContent = 'Carregando...';
        
        let url = '{% url "gestao:desempenho_solicitantes_api" %}?dias=' + dias;
        if (tipoSolicitacao) {
            url += '&tipo_solicitacao=' + encodeURIComponent(tipoSolicitacao);
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.erro) {
                    if (totalReprovacoesEl) totalReprovacoesEl.textContent = 'Erro';
                    return;
                }
                
                // Atualizar resumo
                if (totalReprovacoesEl) totalReprovacoesEl.textContent = data.total_reprovacoes || 0;
                // Mostrar total de solicitantes (incluindo os sem reprovações)
                if (totalSolicitantesEl) {
                    const totalSolicitantes = data.dados ? data.dados.length : 0;
                    totalSolicitantesEl.textContent = totalSolicitantes;
                    console.log(`Total de solicitantes encontrados: ${totalSolicitantes}`);
                }
                const taxaReprovacaoEl = document.getElementById('taxa-reprovacao-geral');
                if (taxaReprovacaoEl) {
                    taxaReprovacaoEl.textContent = (data.taxa_reprovacao_geral || 0) + '%';
                }
                
                // Top tags gerais - lista limpa
                const topTagsContainer = document.getElementById('top-tags-container');
                const topTagsList = document.getElementById('top-tags-list');
                if (topTagsContainer && topTagsList && data.top_tags_geral && data.top_tags_geral.length > 0) {
                    topTagsList.innerHTML = '';
                    const maxCount = data.top_tags_geral[0].count; // Para calcular proporção
                    data.top_tags_geral.forEach((tag, index) => {
                        const tagEl = document.createElement('div');
                        const proporcao = (tag.count / maxCount) * 100;
                        tagEl.style.cssText = `display: flex; align-items: center; gap: 0.875rem; padding: 0.625rem 0; border-bottom: 1px solid #E6E8EC;`;
                        tagEl.innerHTML = `
                            <div style="flex-shrink: 0; width: 24px; height: 24px; border-radius: 50%; background: #E6E8EC; color: #6c757d; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600;">${index + 1}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 0.875rem; color: #212529; font-weight: 500; margin-bottom: 0.25rem;">${tag.nome}</div>
                                <div style="height: 4px; background: #E6E8EC; border-radius: 2px; overflow: hidden;">
                                    <div style="height: 100%; width: ${proporcao}%; background: #6c757d; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div style="flex-shrink: 0; font-size: 0.8rem; color: #6c757d; font-weight: 600;">${tag.count}x</div>
                        `;
                        topTagsList.appendChild(tagEl);
                    });
                    topTagsContainer.style.display = 'block';
                } else if (topTagsContainer) {
                    topTagsContainer.style.display = 'none';
                }
                
                // Reprovações por tipo - cards menores
                const reprovacoesPorTipoContainer = document.getElementById('reprovacoes-por-tipo-container');
                const reprovacoesPorTipoList = document.getElementById('reprovacoes-por-tipo-list');
                if (reprovacoesPorTipoContainer && reprovacoesPorTipoList && data.reprovacoes_por_tipo_geral) {
                    reprovacoesPorTipoList.innerHTML = '';
                    const tipoLabels = {
                        'contrato': 'Contrato',
                        'medicao': 'Medição',
                        'ordem_servico': 'Ordem de Serviço (OS)',
                        'mapa_cotacao': 'Mapa de Cotação'
                    };
                    
                    Object.entries(data.reprovacoes_por_tipo_geral).forEach(([tipo, count]) => {
                        const tipoEl = document.createElement('div');
                        tipoEl.style.cssText = `padding: 1rem 1.25rem; background: #ffffff; border: 1px solid #E6E8EC; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); text-align: center; transition: all 0.2s;`;
                        tipoEl.innerHTML = `<div style="font-size: 0.7rem; font-weight: 500; margin-bottom: 0.5rem; color: #6c757d; text-transform: uppercase; letter-spacing: 0.3px;">${tipoLabels[tipo] || tipo}</div><div style="font-size: 2rem; font-weight: 700; color: #212529; line-height: 1.1;">${count}</div>`;
                        tipoEl.onmouseenter = () => {
                            tipoEl.style.backgroundColor = '#F6F7F9';
                            tipoEl.style.boxShadow = '0 2px 6px rgba(0,0,0,0.08)';
                        };
                        tipoEl.onmouseleave = () => {
                            tipoEl.style.backgroundColor = '#ffffff';
                            tipoEl.style.boxShadow = '0 1px 3px rgba(0,0,0,0.06)';
                        };
                        reprovacoesPorTipoList.appendChild(tipoEl);
                    });
                    reprovacoesPorTipoContainer.style.display = Object.keys(data.reprovacoes_por_tipo_geral).length > 0 ? 'block' : 'none';
                }
                
                // Função para formatar tempo (horas para dias/horas) - definida uma vez
                function formatarTempo(horas) {
                    if (horas == null || horas === undefined || horas === '') return '<span style="color: #868e96; font-size: 0.8rem;">-</span>';
                    if (horas === 0) return '<span style="color: #868e96; font-size: 0.8rem;">-</span>';
                    
                    const h = Math.floor(horas);
                    const m = Math.round((horas - h) * 60);
                    
                    if (horas < 24) {
                        if (h > 0 && m > 0) {
                            return `<span style="color: #495057; font-weight: 500; font-size: 0.85rem;">${h}h ${m}min</span>`;
                        } else if (h > 0) {
                            return `<span style="color: #495057; font-weight: 500; font-size: 0.85rem;">${h}h</span>`;
                        } else if (m > 0) {
                            return `<span style="color: #495057; font-weight: 500; font-size: 0.85rem;">${m}min</span>`;
                        } else {
                            return '<span style="color: #868e96; font-size: 0.8rem;">-</span>';
                        }
                    } else {
                        // 24h ou mais: mostrar dias, horas e minutos
                        const dias = Math.floor(horas / 24);
                        const horasRestantes = Math.floor((horas % 24));
                        const minutosRestantes = Math.round((horas % 1) * 60);
                        
                        if (dias > 0 && horasRestantes > 0 && minutosRestantes > 0) {
                            return `<span style="color: #495057; font-weight: 500; font-size: 0.85rem;">${dias}d ${horasRestantes}h ${minutosRestantes}min</span>`;
                        } else if (dias > 0 && horasRestantes > 0) {
                            return `<span style="color: #495057; font-weight: 500; font-size: 0.85rem;">${dias}d ${horasRestantes}h</span>`;
                        } else if (dias > 0 && minutosRestantes > 0) {
                            return `<span style="color: #495057; font-weight: 500; font-size: 0.85rem;">${dias}d ${minutosRestantes}min</span>`;
                        } else if (dias > 0) {
                            return `<span style="color: #495057; font-weight: 500; font-size: 0.85rem;">${dias}d</span>`;
                        } else {
                            return `<span style="color: #495057; font-weight: 500; font-size: 0.85rem;">${h}h ${m}min</span>`;
                        }
                    }
                }
                
                // Tabela de solicitantes
                const tableContainer = document.getElementById('solicitantes-table-container');
                const tableBody = document.getElementById('solicitantes-table-body');
                
                if (tableBody && data.dados && data.dados.length > 0) {
                    console.log(`[Desempenho] Exibindo ${data.dados.length} solicitantes na tabela`);
                    tableBody.innerHTML = '';
                    data.dados.forEach(item => {
                        const row = document.createElement('tr');
                        
                        // Formatar reprovações por tipo
                        const tipoLabels = {
                            'contrato': 'Contrato',
                            'medicao': 'Medição',
                            'ordem_servico': 'OS',
                            'mapa_cotacao': 'Mapa'
                        };
                        let reprovacoesPorTipoHtml = '';
                        Object.entries(item.reprovacoes_por_tipo || {}).forEach(([tipo, count]) => {
                            reprovacoesPorTipoHtml += `<span style="display: inline-block; padding: 0.25rem 0.625rem; background: #F6F7F9; color: #495057; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">${tipoLabels[tipo] || tipo}: ${count}</span>`;
                        });
                        
                        // Formatar top tags (Top 3 + "+N" se houver mais)
                        let topTagsHtml = '';
                        if (item.top_tags && item.top_tags.length > 0) {
                            const top3 = item.top_tags.slice(0, 3);
                            const restantes = item.top_tags.length - 3;
                            top3.forEach((tag) => {
                                topTagsHtml += `<span style="display: inline-block; padding: 0.25rem 0.625rem; background: #F6F7F9; color: #495057; border-radius: 12px; font-size: 0.75rem; font-weight: 500; margin-right: 0.375rem; margin-bottom: 0.25rem;">${tag.nome} <span style="color: #6c757d; font-weight: 400;">${tag.count}x</span></span>`;
                            });
                            if (restantes > 0) {
                                topTagsHtml += `<span style="display: inline-block; padding: 0.25rem 0.625rem; background: #E6E8EC; color: #6c757d; border-radius: 12px; font-size: 0.75rem; font-weight: 500; margin-right: 0.375rem; margin-bottom: 0.25rem;" title="${restantes} motivo(s) a mais">+${restantes}</span>`;
                            }
                        } else {
                            topTagsHtml = '<span style="color: #868e96; font-style: italic; font-size: 0.8rem;">Nenhum motivo</span>';
                        }
                        
                        // URLs de exportação
                        let exportUrlCsv = '/exportar-historico-solicitante/' + item.solicitante_id + '/?dias=' + dias + '&formato=csv';
                        let exportUrlPdf = '/exportar-historico-solicitante/' + item.solicitante_id + '/?dias=' + dias + '&formato=pdf';
                        if (tipoSolicitacao) {
                            exportUrlCsv += '&tipo_solicitacao=' + encodeURIComponent(tipoSolicitacao);
                            exportUrlPdf += '&tipo_solicitacao=' + encodeURIComponent(tipoSolicitacao);
                        }
                        
                        let rankingStyle = 'background: #fff;';
                        let rankingLabel = item.ranking ? (item.ranking + 'º') : '-';
                        let taxaErroColor = '#495057';
                        let taxaErroBg = '#f1f5f9';
                        let taxaErroBorder = '#e2e8f0';
                        
                        // Extrair métricas de tempo (agora simplificadas)
                        const tempoParaCorrigir = item.tempo_medio_para_corrigir;
                        const tempoTotalAprovacao = item.tempo_medio_total_aprovacao;
                        
                        // Zebra striping
                        const isEven = data.dados.indexOf(item) % 2 === 0;
                        const rowBg = isEven ? '#fff' : '#F6F7F9';
                        
                        row.innerHTML = `
                            <td style="padding: 0.75rem 0.875rem; text-align: center; border-bottom: 1px solid #E6E8EC; ${rankingStyle}">
                                <span style="font-weight: 500; font-size: 0.85rem; color: #64748b;">${rankingLabel}</span>
                            </td>
                            <td style="padding: 0.75rem 0.875rem; border-bottom: 1px solid #E6E8EC; background: ${rowBg};">
                                <strong style="color: #212529; font-size: 0.875rem; font-weight: 600;">${item.solicitante}</strong>
                            </td>
                            <td style="padding: 0.75rem 0.875rem; text-align: center; border-bottom: 1px solid #E6E8EC; background: ${rowBg};">
                                <span style="color: #495057; font-weight: 500; font-size: 0.875rem;">${item.total_pedidos || '-'}</span>
                            </td>
                            <td style="padding: 0.75rem 0.875rem; text-align: center; border-bottom: 1px solid #E6E8EC; background: ${rowBg};">
                                <span style="color: #475569; font-weight: 500; font-size: 0.875rem;">${item.total_reprovacoes}</span>
                            </td>
                            <td style="padding: 0.75rem 0.875rem; text-align: center; border-bottom: 1px solid #E6E8EC; background: ${rowBg};">
                                <span style="display: inline-block; padding: 0.25rem 0.5rem; background: ${taxaErroBg}; color: ${taxaErroColor}; border: 1px solid ${taxaErroBorder}; border-radius: 4px; font-weight: 500; font-size: 0.8rem;">${item.taxa_erro || 0}%</span>
                            </td>
                            <td style="padding: 0.75rem 0.875rem; text-align: center; border-bottom: 1px solid #E6E8EC; background: ${rowBg};">
                                <span style="color: #6c757d; font-weight: 400; font-size: 0.85rem;">${item.media_tags_por_reprovacao || '0'}</span>
                            </td>
                            <td style="padding: 0.75rem 0.875rem; text-align: center; border-bottom: 1px solid #E6E8EC; background: ${rowBg};">
                                ${formatarTempo(tempoParaCorrigir)}
                            </td>
                            <td style="padding: 0.75rem 0.875rem; text-align: center; border-bottom: 1px solid #E6E8EC; background: ${rowBg};">
                                ${formatarTempo(tempoTotalAprovacao)}
                            </td>
                            <td style="padding: 0.75rem 0.875rem; border-bottom: 1px solid #E6E8EC; background: ${rowBg};">
                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">${reprovacoesPorTipoHtml || '<span style="color: #868e96; font-size: 0.8rem;">-</span>'}</div>
                            </td>
                            <td style="padding: 0.75rem 0.875rem; border-bottom: 1px solid #E6E8EC; background: ${rowBg};">
                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">${topTagsHtml}</div>
                            </td>
                            <td style="padding: 0.75rem 0.875rem; text-align: center; border-bottom: 1px solid #E6E8EC; background: ${rowBg};">
                                <div style="display: inline-flex; gap: 0.5rem; align-items: center;">
                                    <a href="${exportUrlCsv}" style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.75rem; background: #495057; color: white; text-decoration: none; border-radius: 6px; font-weight: 500; font-size: 0.75rem; transition: all 0.2s;" onmouseover="this.style.backgroundColor='#212529';" onmouseout="this.style.backgroundColor='#495057';" title="Exportar em CSV (Excel)"> 
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                        CSV
                                    </a>
                                    <a href="${exportUrlPdf}" style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.75rem; background: #dc3545; color: white; text-decoration: none; border-radius: 6px; font-weight: 500; font-size: 0.75rem; transition: all 0.2s;" onmouseover="this.style.backgroundColor='#c82333';" onmouseout="this.style.backgroundColor='#dc3545';" title="Exportar em PDF"> 
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                        PDF
                                    </a>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    if (tableContainer) {
                        tableContainer.style.display = 'block';
                    }
                } else if (tableContainer) {
                    tableContainer.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Erro ao carregar dados de solicitantes:', error);
                const totalReprovacoesEl = document.getElementById('total-reprovacoes-solicitantes');
                if (totalReprovacoesEl) totalReprovacoesEl.textContent = 'Erro ao carregar';
            });
    }
    
    // Event listeners para filtros de solicitantes
    const periodSelectorSolicitantes = document.getElementById('period-selector-solicitantes');
    const tipoSelectorSolicitantes = document.getElementById('tipo-selector-solicitantes');
    
    if (periodSelectorSolicitantes) {
        periodSelectorSolicitantes.addEventListener('change', function() {
            const dias = parseInt(this.value);
            const tipo = tipoSelectorSolicitantes ? tipoSelectorSolicitantes.value : '';
            carregarDadosSolicitantes(dias, tipo);
        });
    }
    
    if (tipoSelectorSolicitantes) {
        tipoSelectorSolicitantes.addEventListener('change', function() {
            const dias = parseInt(periodSelectorSolicitantes.value);
            const tipo = this.value;
            carregarDadosSolicitantes(dias, tipo);
        });
    }
    
    // Carregar dados iniciais da aba de solicitantes (aba padrão)
    if (periodSelectorSolicitantes && tipoSelectorSolicitantes) {
        const diasInicial = parseInt(periodSelectorSolicitantes.value);
        const tipoInicial = tipoSelectorSolicitantes.value;
        carregarDadosSolicitantes(diasInicial, tipoInicial);
    }
});
</script>
{% endblock %}
