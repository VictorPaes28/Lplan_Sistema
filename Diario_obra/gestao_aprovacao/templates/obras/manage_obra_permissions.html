{% extends 'base.html' %}
{% load static %}

{% block title %}Gerenciar Permissões: {{ obra.codigo }}{% endblock %}

{% block page_title %}Permissões da Obra{% endblock %}
{% block page_subtitle %}GestControll - Gerenciamento{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/list_workorders.css' %}">
<style>
    .back-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; margin-bottom: 1.25rem; }
    .back-link { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; color: #475569; font-size: 0.875rem; font-weight: 500; text-decoration: none; transition: background 0.2s, color 0.2s; }
    .back-link:hover { background: #f8fafc; color: #1e293b; }
    .back-link svg { flex-shrink: 0; }
    .perm-card-title { font-size: 1.1rem; font-weight: 600; color: #1e293b; margin: 0 0 1rem 0; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0; }
    .perm-form-row { display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap; }
    .perm-form-row .field-wrap { flex: 1; min-width: 200px; }
    .perm-form-row label { display: block; font-size: 0.75rem; font-weight: 600; color: #64748b; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.03em; }
    .perm-form-row select { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem; background: #fff; }
    .perm-form-row .btn { flex-shrink: 0; }
    .perm-info-box { background: #fefce8; border: 1px solid #fde68a; border-radius: 8px; padding: 1rem 1.25rem; font-size: 0.875rem; color: #713f12; line-height: 1.5; }
    .perm-info-box strong { color: #a16207; }
    .perm-info-box ul { margin: 0.5rem 0 0 1.25rem; padding: 0; }
</style>
{% endblock %}

{% block content %}
<div class="page-container" style="max-width: 900px;">
    <div class="back-actions">
        <a href="{% url 'gestao:detail_obra' obra.pk %}" class="back-link" aria-label="Voltar para a obra">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            Voltar à obra
        </a>
        <a href="{% url 'gestao:home' %}" class="back-link" aria-label="Voltar ao GestControll">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
            Voltar ao GestControll
        </a>
    </div>

    <div class="list-header" style="margin-bottom: 1.5rem;">
        <h1 class="list-title" style="font-size: 1.5rem;">Gerenciar Permissões – {{ obra.codigo }}</h1>
    </div>

    <div class="card" style="margin-bottom: 1.5rem;">
        <h2 class="perm-card-title">Adicionar nova permissão</h2>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="add">
            <div class="perm-form-row">
                <div class="field-wrap">
                    <label for="usuario">Usuário</label>
                    <select id="usuario" name="usuario" required>
                        <option value="">Selecione um usuário</option>
                        <optgroup label="Solicitantes">
                            {% for usuario in usuarios_solicitantes %}
                                <option value="{{ usuario.pk }}">{{ usuario.get_full_name|default:usuario.username }}</option>
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Aprovadores">
                            {% for usuario in usuarios_aprovadores %}
                                <option value="{{ usuario.pk }}">{{ usuario.get_full_name|default:usuario.username }}</option>
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
                <div class="field-wrap">
                    <label for="tipo_permissao">Tipo de permissão</label>
                    <select id="tipo_permissao" name="tipo_permissao" required>
                        <option value="">Selecione...</option>
                        <option value="solicitante">Solicitante</option>
                        <option value="aprovador">Aprovador</option>
                    </select>
                </div>
                <button type="submit" class="btn">Adicionar</button>
            </div>
        </form>
    </div>

    <div class="card" style="margin-bottom: 1.5rem;">
        <h2 class="perm-card-title">Permissões existentes</h2>
        {% if permissoes %}
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Usuário</th>
                            <th>Tipo</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for perm in permissoes %}
                            <tr>
                                <td>{{ perm.usuario.get_full_name|default:perm.usuario.username }}</td>
                                <td>
                                    {% if perm.tipo_permissao == 'solicitante' %}
                                        <span class="badge" style="background: #e0f2fe; color: #0369a1;">Solicitante</span>
                                    {% else %}
                                        <span class="badge" style="background: #dcfce7; color: #166534;">Aprovador</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if perm.ativo %}
                                        <span class="badge badge-success">Ativa</span>
                                    {% else %}
                                        <span class="badge" style="background: #fef2f2; color: #b91c1c;">Inativa</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <form method="post" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="toggle">
                                        <input type="hidden" name="permission_id" value="{{ perm.pk }}">
                                        <button type="submit" class="btn btn-sm">{% if perm.ativo %}Desativar{% else %}Ativar{% endif %}</button>
                                    </form>
                                    <form method="post" style="display: inline;" onsubmit="return confirm('Remover esta permissão?');">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="remove">
                                        <input type="hidden" name="permission_id" value="{{ perm.pk }}">
                                        <button type="submit" class="btn btn-sm" style="background: #64748b; color: #fff;">Remover</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="empty-message" style="color: #64748b; margin: 0;">Nenhuma permissão cadastrada para esta obra.</p>
        {% endif %}
    </div>

    <div class="perm-info-box">
        <strong>Importante:</strong> para adicionar permissões, o usuário deve estar vinculado à empresa da obra (em "Gerenciar Usuários") e no grupo correto (Solicitante ou Aprovador).
    </div>
</div>
{% endblock %}
